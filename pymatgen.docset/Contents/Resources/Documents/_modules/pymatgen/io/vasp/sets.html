<!DOCTYPE html>

<html lang="en" data-content_root="../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pymatgen.io.vasp.sets &#8212; pymatgen 2025.1.24 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/basic.css?v=5c69cfe2" />
    <script src="../../../../_static/documentation_options.js?v=d2bc030c"></script>
    <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">pymatgen 2025.1.24 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">pymatgen.io.vasp.sets</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <h1>Source code for pymatgen.io.vasp.sets</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module defines the VaspInputSet abstract base class and a concrete implementation for the parameters developed</span>
<span class="sd">and tested by the core team of pymatgen, including the Materials Virtual Lab, Materials Project and the MIT high</span>
<span class="sd">throughput project. The basic concept behind an input set is to specify a scheme to generate a consistent set of VASP</span>
<span class="sd">inputs from a structure without further user intervention. This ensures comparability across runs.</span>

<span class="sd">Read the following carefully before implementing new input sets:</span>

<span class="sd">1. 99% of what needs to be done can be done by specifying user_incar_settings to override some of the defaults of</span>
<span class="sd">   various input sets. Unless there is an extremely good reason to add a new set, **do not** add one. e.g. if you want</span>
<span class="sd">   to turn the Hubbard U off, just set &quot;LDAU&quot;: False as a user_incar_setting.</span>
<span class="sd">2. All derivative input sets should inherit appropriate configurations (e.g., from MPRelaxSet), and more often than</span>
<span class="sd">   not, VaspInputSet should be the superclass. Superclass delegation should be used where possible. In particular,</span>
<span class="sd">   you are not supposed to implement your own as_dict or from_dict for derivative sets unless you know what you are</span>
<span class="sd">   doing. Improper overriding the as_dict and from_dict protocols is the major cause of implementation headaches. If</span>
<span class="sd">   you need an example, look at how the MPStaticSet is initialized.</span>

<span class="sd">The above are recommendations. The following are **UNBREAKABLE** rules:</span>

<span class="sd">1. All input sets must take in a structure, list of structures or None as the first argument. If None, the input set</span>
<span class="sd">   should perform a stateless initialization and before any output can be written, a structure must be set.</span>
<span class="sd">2. user_incar_settings, user_kpoints_settings and user_&lt;whatever&gt;_settings are ABSOLUTE. Any new sets you implement</span>
<span class="sd">   must obey this. If a user wants to override your settings, you assume he knows what he is doing. Do not</span>
<span class="sd">   magically override user supplied settings. You can issue a warning if you think the user is wrong.</span>
<span class="sd">3. All input sets must save all supplied args and kwargs as instance variables. e.g. self.arg = arg and</span>
<span class="sd">   self.kwargs = kwargs in the __init__. This ensures the as_dict and from_dict work correctly.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">abc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sequence</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">glob</span><span class="w"> </span><span class="kn">import</span> <span class="n">glob</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">chain</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">cast</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">monty.dev</span><span class="w"> </span><span class="kn">import</span> <span class="n">deprecated</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">monty.json</span><span class="w"> </span><span class="kn">import</span> <span class="n">MSONable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">monty.serialization</span><span class="w"> </span><span class="kn">import</span> <span class="n">loadfn</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pymatgen.analysis.structure_matcher</span><span class="w"> </span><span class="kn">import</span> <span class="n">StructureMatcher</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pymatgen.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">Element</span><span class="p">,</span> <span class="n">PeriodicSite</span><span class="p">,</span> <span class="n">SiteCollection</span><span class="p">,</span> <span class="n">Species</span><span class="p">,</span> <span class="n">Structure</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pymatgen.io.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">InputGenerator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pymatgen.io.vasp.inputs</span><span class="w"> </span><span class="kn">import</span> <span class="n">Incar</span><span class="p">,</span> <span class="n">Kpoints</span><span class="p">,</span> <span class="n">PmgVaspPspDirError</span><span class="p">,</span> <span class="n">Poscar</span><span class="p">,</span> <span class="n">Potcar</span><span class="p">,</span> <span class="n">VaspInput</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pymatgen.io.vasp.outputs</span><span class="w"> </span><span class="kn">import</span> <span class="n">Outcar</span><span class="p">,</span> <span class="n">Vasprun</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pymatgen.symmetry.analyzer</span><span class="w"> </span><span class="kn">import</span> <span class="n">SpacegroupAnalyzer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pymatgen.symmetry.bandstructure</span><span class="w"> </span><span class="kn">import</span> <span class="n">HighSymmKpath</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pymatgen.util.due</span><span class="w"> </span><span class="kn">import</span> <span class="n">Doi</span><span class="p">,</span> <span class="n">due</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pymatgen.util.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Kpoint</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Self</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">pymatgen.util.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">PathLike</span><span class="p">,</span> <span class="n">Tuple3Ints</span><span class="p">,</span> <span class="n">Vector3D</span>

    <span class="n">UserPotcarFunctional</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Literal</span><span class="p">[</span>
            <span class="s2">&quot;PBE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;PBE_52&quot;</span><span class="p">,</span>
            <span class="s2">&quot;PBE_54&quot;</span><span class="p">,</span>
            <span class="s2">&quot;PBE_64&quot;</span><span class="p">,</span>
            <span class="s2">&quot;LDA&quot;</span><span class="p">,</span>
            <span class="s2">&quot;LDA_52&quot;</span><span class="p">,</span>
            <span class="s2">&quot;LDA_54&quot;</span><span class="p">,</span>
            <span class="s2">&quot;PW91&quot;</span><span class="p">,</span>
            <span class="s2">&quot;LDA_US&quot;</span><span class="p">,</span>
            <span class="s2">&quot;PW91_US&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="o">|</span> <span class="kc">None</span>
    <span class="p">)</span>

<span class="n">MODULE_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_load_yaml_config</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">MODULE_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.yaml&quot;</span><span class="p">):</span>
        <span class="n">fname</span> <span class="o">+=</span> <span class="s2">&quot;.yaml&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">loadfn</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;PARENT&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">parent_config</span> <span class="o">=</span> <span class="n">_load_yaml_config</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;PARENT&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">parent_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                <span class="n">config</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">v_new</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">v_new</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">config</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_new</span>
    <span class="k">return</span> <span class="n">config</span>


<div class="viewcode-block" id="VaspInputSet">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.VaspInputSet">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">VaspInputSet</span><span class="p">(</span><span class="n">InputGenerator</span><span class="p">,</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class representing a set of VASP input parameters with a structure</span>
<span class="sd">    supplied as init parameters and initialized from a dict of settings.</span>
<span class="sd">    This allows arbitrary settings to be input. In general,</span>
<span class="sd">    this is rarely used directly unless there is a source of settings in yaml</span>
<span class="sd">    format (e.g., from a REST interface). It is typically used by other</span>
<span class="sd">    VaspInputSets for initialization.</span>

<span class="sd">    Special consideration should be paid to the way the MAGMOM initialization</span>
<span class="sd">    for the INCAR is done. The initialization differs depending on the type of</span>
<span class="sd">    structure and the configuration settings. The order in which the magmom is</span>
<span class="sd">    determined is as follows:</span>

<span class="sd">    1. If the site is specified in user_incar_settings, use that setting.</span>
<span class="sd">    2. If the site itself has a magmom setting (i.e. site.properties[&quot;magmom&quot;] = float),</span>
<span class="sd">        that is used. This can be set with structure.add_site_property().</span>
<span class="sd">    3. If the species of the site has a spin setting, that is used. This can be set</span>
<span class="sd">        with structure.add_spin_by_element().</span>
<span class="sd">    4. If the species itself has a particular setting in the config file, that</span>
<span class="sd">       is used, e.g. Mn3+ may have a different magmom than Mn4+.</span>
<span class="sd">    5. Lastly, the element symbol itself is checked in the config file. If</span>
<span class="sd">       there are no settings, a default value of 0.6 is used.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure (Structure): The Structure to create inputs for. If None, the input</span>
<span class="sd">            set is initialized without a Structure but one must be set separately before</span>
<span class="sd">            the inputs are generated.</span>
<span class="sd">        config_dict (dict): The config dictionary to use.</span>
<span class="sd">        files_to_transfer (dict): A dictionary of {filename: filepath}. This allows the</span>
<span class="sd">            transfer of files from a previous calculation.</span>
<span class="sd">        user_incar_settings (dict): User INCAR settings. This allows a user to override</span>
<span class="sd">            INCAR settings, e.g. setting a different MAGMOM for various elements or</span>
<span class="sd">            species. Note that in the new scheme, ediff_per_atom and hubbard_u are no</span>
<span class="sd">            longer args. Instead, the CONFIG supports EDIFF_PER_ATOM and EDIFF keys.</span>
<span class="sd">            The former scales with # of atoms, the latter does not. If both are present,</span>
<span class="sd">            EDIFF is preferred. To force such settings, just supply</span>
<span class="sd">            user_incar_settings={&quot;EDIFF&quot;: 1e-5, &quot;LDAU&quot;: False} for example. The keys</span>
<span class="sd">            &#39;LDAUU&#39;, &#39;LDAUJ&#39;, &#39;LDAUL&#39; are special cases since pymatgen defines different</span>
<span class="sd">            values depending on what anions are present in the structure, so these keys</span>
<span class="sd">            can be defined in one of two ways, e.g. either {&quot;LDAUU&quot;:{&quot;O&quot;:{&quot;Fe&quot;:5}}} to</span>
<span class="sd">            set LDAUU for Fe to 5 in an oxide, or {&quot;LDAUU&quot;:{&quot;Fe&quot;:5}} to set LDAUU to 5</span>
<span class="sd">            regardless of the input structure. If a None value is given, that key is</span>
<span class="sd">            unset. For example, {&quot;ENCUT&quot;: None} will remove ENCUT from the</span>
<span class="sd">            incar settings. Finally, KSPACING is a special setting and can be set to</span>
<span class="sd">            &quot;auto&quot; in which the KSPACING is set automatically based on the band gap.</span>
<span class="sd">        user_kpoints_settings (dict or Kpoints): Allow user to override kpoints setting</span>
<span class="sd">            by supplying a dict. e.g. {&quot;reciprocal_density&quot;: 1000}. User can also</span>
<span class="sd">            supply Kpoints object.</span>
<span class="sd">        user_potcar_settings (dict): Allow user to override POTCARs. e.g. {&quot;Gd&quot;:</span>
<span class="sd">            &quot;Gd_3&quot;}. This is generally not recommended.</span>
<span class="sd">        constrain_total_magmom (bool): Whether to constrain the total magmom (NUPDOWN in</span>
<span class="sd">            INCAR) to be the sum of the expected MAGMOM for all species.</span>
<span class="sd">        sort_structure (bool): Whether to sort the structure (using the default sort</span>
<span class="sd">            order of electronegativity) before generating input files. Defaults to True,</span>
<span class="sd">            the behavior you would want most of the time. This ensures that similar</span>
<span class="sd">            atomic species are grouped together.</span>
<span class="sd">        user_potcar_functional (str): Functional to use. Default (None) is to use the</span>
<span class="sd">            functional in the config dictionary. Valid values: &quot;PBE&quot;, &quot;PBE_52&quot;,</span>
<span class="sd">            &quot;PBE_54&quot;, &quot;PBE_64&quot;, &quot;LDA&quot;, &quot;LDA_52&quot;, &quot;LDA_54&quot;, &quot;PW91&quot;, &quot;LDA_US&quot;, &quot;PW91_US&quot;.</span>
<span class="sd">        force_gamma (bool): Force gamma centered kpoint generation. Default (False) is</span>
<span class="sd">            to use the Automatic Density kpoint scheme, which will use the Gamma</span>
<span class="sd">            centered generation scheme for hexagonal cells, and Monkhorst-Pack otherwise.</span>
<span class="sd">        reduce_structure (None/str): Before generating the input files, generate the</span>
<span class="sd">            reduced structure. Default (None), does not alter the structure. Valid</span>
<span class="sd">            values: None, &quot;niggli&quot;, &quot;LLL&quot;.</span>
<span class="sd">        vdw: Adds default parameters for van-der-Waals functionals supported by VASP to</span>
<span class="sd">            INCAR. Supported functionals are: DFT-D2, undamped DFT-D3, DFT-D3 with</span>
<span class="sd">            Becke-Jonson damping, Tkatchenko-Scheffler, Tkatchenko-Scheffler with</span>
<span class="sd">            iterative Hirshfeld partitioning, MBD@rSC, dDsC, Dion&#39;s vdW-DF, DF2, optPBE,</span>
<span class="sd">            optB88, optB86b and rVV10.</span>
<span class="sd">        use_structure_charge (bool): If set to True, then the overall charge of the</span>
<span class="sd">            structure (structure.charge) is used to set the NELECT variable in the</span>
<span class="sd">            INCAR. Default is False.</span>
<span class="sd">        standardize (float): Whether to standardize to a primitive standard cell.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        sym_prec (float): Tolerance for symmetry finding.</span>
<span class="sd">        international_monoclinic (bool): Whether to use international convention (vs</span>
<span class="sd">            Curtarolo) for monoclinic. Defaults True.</span>
<span class="sd">        validate_magmom (bool): Ensure that the missing magmom values are filled in with</span>
<span class="sd">            the VASP default value of 1.0.</span>
<span class="sd">        inherit_incar (bool): Whether to inherit INCAR settings from previous</span>
<span class="sd">            calculation. This might be useful to port Custodian fixes to child jobs but</span>
<span class="sd">            can also be dangerous e.g. when switching from GGA to meta-GGA or relax to</span>
<span class="sd">            static jobs. Defaults to True.</span>
<span class="sd">        auto_kspacing (bool): If true, determines the value of KSPACING from the bandgap</span>
<span class="sd">            of a previous calculation.</span>
<span class="sd">        auto_ismear (bool): If true, the values for ISMEAR and SIGMA will be set</span>
<span class="sd">            automatically depending on the bandgap of the system. If the bandgap is not</span>
<span class="sd">            known (e.g., there is no previous VASP directory) then ISMEAR=0 and</span>
<span class="sd">            SIGMA=0.2; if the bandgap is zero (a metallic system) then ISMEAR=2 and</span>
<span class="sd">            SIGMA=0.2; if the system is an insulator, then ISMEAR=-5 (tetrahedron</span>
<span class="sd">            smearing). Note, this only works when generating the input set from a</span>
<span class="sd">            previous VASP directory.</span>
<span class="sd">        auto_ispin (bool) = False:</span>
<span class="sd">            If generating input set from a previous calculation, this controls whether</span>
<span class="sd">            to disable magnetisation (ISPIN = 1) if the absolute value of all magnetic</span>
<span class="sd">            moments are less than 0.02.</span>
<span class="sd">        auto_lreal (bool) = False:</span>
<span class="sd">            If True, automatically use the VASP recommended LREAL based on cell size.</span>
<span class="sd">        auto_metal_kpoints</span>
<span class="sd">            If true and the system is metallic, try and use ``reciprocal_density_metal``</span>
<span class="sd">            instead of ``reciprocal_density`` for metallic systems. Note, this only works</span>
<span class="sd">            if the bandgap is not None.</span>
<span class="sd">        bandgap_tol (float): Tolerance for determining if a system is metallic when</span>
<span class="sd">            KSPACING is set to &quot;auto&quot;. If the bandgap is less than this value, the</span>
<span class="sd">            system is considered metallic. Defaults to 1e-4 (eV).</span>
<span class="sd">        bandgap (float): Used for determining KSPACING if KSPACING == &quot;auto&quot; or</span>
<span class="sd">            ISMEAR if auto_ismear == True. Set automatically when using from_prev_calc.</span>
<span class="sd">        prev_incar (str or dict): Previous INCAR used for setting parent INCAR when</span>
<span class="sd">            inherit_incar == True. Set automatically when using from_prev_calc.</span>
<span class="sd">        prev_kpoints (str or Kpoints): Previous Kpoints. Set automatically when using</span>
<span class="sd">            from_prev_calc.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">config_dict</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">files_to_transfer</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">user_incar_settings</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">user_kpoints_settings</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">user_potcar_settings</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">constrain_total_magmom</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">sort_structure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">user_potcar_functional</span><span class="p">:</span> <span class="n">UserPotcarFunctional</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">force_gamma</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">reduce_structure</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;niggli&quot;</span><span class="p">,</span> <span class="s2">&quot;LLL&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">vdw</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">use_structure_charge</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">standardize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">sym_prec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">international_monoclinic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">validate_magmom</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">inherit_incar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">auto_kspacing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">auto_ismear</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">auto_ispin</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">auto_lreal</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">auto_metal_kpoints</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">bandgap_tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-4</span>
    <span class="n">bandgap</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">prev_incar</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">prev_kpoints</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Kpoints</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_valid_potcars</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform validation.&quot;&quot;&quot;</span>
        <span class="n">user_potcar_functional</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_potcar_functional</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">valid_potcars</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid_potcars</span><span class="p">)</span> <span class="ow">and</span> <span class="n">user_potcar_functional</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_potcars</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid </span><span class="si">{</span><span class="n">user_potcar_functional</span><span class="si">=}</span><span class="s2">, must be one of </span><span class="si">{</span><span class="n">valid_potcars</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;CONFIG&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_config_dict</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">)</span>

        <span class="c1"># These have been left to stay consistent with previous API</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_incar_settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_incar_settings</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_kpoints_settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_kpoints_settings</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vdw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vdw</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vdw</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">vdw</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_incar_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;KSPACING&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_kpoints_settings</span><span class="p">:</span>
            <span class="c1"># self.user_kpoints_settings will never be `None` because it is set to</span>
            <span class="c1"># an empty dict if it is `None`.</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;You have specified KSPACING and also supplied KPOINTS &quot;</span>
                <span class="s2">&quot;settings. KSPACING only has effect when there is no &quot;</span>
                <span class="s2">&quot;KPOINTS file. Since both settings were given, pymatgen&quot;</span>
                <span class="s2">&quot;will generate a KPOINTS file and ignore KSPACING.&quot;</span>
                <span class="s2">&quot;Remove the `user_kpoints_settings` argument to enable KSPACING.&quot;</span><span class="p">,</span>
                <span class="n">BadInputSetWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vdw</span><span class="p">:</span>
            <span class="n">vdw_par</span> <span class="o">=</span> <span class="n">loadfn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">MODULE_DIR</span><span class="si">}</span><span class="s2">/vdW_parameters.yaml&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vdw_param</span> <span class="o">:=</span> <span class="n">vdw_par</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vdw</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_config_dict</span><span class="p">[</span><span class="s2">&quot;INCAR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">vdw_param</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Invalid or unsupported van-der-Waals functional. Supported functionals are </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vdw_par</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
        <span class="c1"># &#39;or&#39; case reads the POTCAR_FUNCTIONAL from the .yaml</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_potcar_functional</span><span class="p">:</span> <span class="n">UserPotcarFunctional</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_potcar_functional</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;POTCAR_FUNCTIONAL&quot;</span><span class="p">,</span> <span class="s2">&quot;PBE&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Warn if a user is overriding POTCAR_FUNCTIONAL</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_potcar_functional</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;POTCAR_FUNCTIONAL&quot;</span><span class="p">,</span> <span class="s2">&quot;PBE&quot;</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Overriding the POTCAR functional is generally not recommended &quot;</span>
                <span class="s2">&quot; as it significantly affects the results of calculations and &quot;</span>
                <span class="s2">&quot;compatibility with other calculations done with the same &quot;</span>
                <span class="s2">&quot;input set. Note that some POTCAR symbols specified in &quot;</span>
                <span class="s2">&quot;the configuration file may not be available in the selected &quot;</span>
                <span class="s2">&quot;functional.&quot;</span><span class="p">,</span>
                <span class="n">BadInputSetWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_potcar_settings</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Overriding POTCARs is generally not recommended as it &quot;</span>
                <span class="s2">&quot;significantly affects the results of calculations and &quot;</span>
                <span class="s2">&quot;compatibility with other calculations done with the same &quot;</span>
                <span class="s2">&quot;input set. In many instances, it is better to write a &quot;</span>
                <span class="s2">&quot;subclass of a desired input set and override the POTCAR in &quot;</span>
                <span class="s2">&quot;the subclass to be explicit on the differences.&quot;</span><span class="p">,</span>
                <span class="n">BadInputSetWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_potcar_settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_config_dict</span><span class="p">[</span><span class="s2">&quot;POTCAR&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">Structure</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span><span class="p">:</span> <span class="n">Structure</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># TODO is this needed? should it be self._structure = self.structure (needs explanation either way)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_incar</span><span class="p">,</span> <span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prev_incar</span> <span class="o">=</span> <span class="n">Incar</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_incar</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_kpoints</span><span class="p">,</span> <span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prev_kpoints</span> <span class="o">=</span> <span class="n">Kpoints</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_kpoints</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prev_vasprun</span><span class="p">:</span> <span class="n">Vasprun</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_outcar</span><span class="p">:</span> <span class="n">Outcar</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ispin</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>

<div class="viewcode-block" id="VaspInputSet.write_input">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.VaspInputSet.write_input">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_input</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">make_dir_if_not_present</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">include_cif</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">potcar_spec</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">zip_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write a set of VASP input to a directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            output_dir (str): Directory to output the VASP input files</span>
<span class="sd">            make_dir_if_not_present (bool): Set to True if you want the</span>
<span class="sd">                directory (and the whole path) to be created if it is not</span>
<span class="sd">                present.</span>
<span class="sd">            include_cif (bool): Whether to write a CIF file in the output</span>
<span class="sd">                directory for easier opening by VESTA.</span>
<span class="sd">            potcar_spec (bool): Instead of writing the POTCAR, write a &quot;POTCAR.spec&quot;.</span>
<span class="sd">                This is intended to help sharing an input set with people who might</span>
<span class="sd">                not have a license to specific Potcar files. Given a &quot;POTCAR.spec&quot;,</span>
<span class="sd">                the specific POTCAR file can be re-generated using pymatgen with the</span>
<span class="sd">                &quot;generate_potcar&quot; function in the pymatgen CLI.</span>
<span class="sd">            zip_output (bool): If True, output will be zipped into a file with the</span>
<span class="sd">                same name as the InputSet (e.g., MPStaticSet.zip).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vasp_input</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vasp_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input_set</span><span class="p">(</span><span class="n">potcar_spec</span><span class="o">=</span><span class="n">potcar_spec</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">PmgVaspPspDirError</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">potcar_spec</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PmgVaspPspDirError</span><span class="p">(</span>
                    <span class="s2">&quot;PMG_VASP_PSP_DIR is not set. Please set PMG_VASP_PSP_DIR&quot;</span>
                    <span class="s2">&quot; in .pmgrc.yaml or use potcar_spec=True argument.&quot;</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

        <span class="k">if</span> <span class="n">vasp_input</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;vasp_input is None&quot;</span><span class="p">)</span>

        <span class="n">cif_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">include_cif</span><span class="p">:</span>
            <span class="n">struct</span> <span class="o">=</span> <span class="n">vasp_input</span><span class="p">[</span><span class="s2">&quot;POSCAR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">structure</span>
            <span class="n">cif_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">struct</span><span class="o">.</span><span class="n">formula</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.cif&quot;</span>

        <span class="n">vasp_input</span><span class="o">.</span><span class="n">write_input</span><span class="p">(</span>
            <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
            <span class="n">make_dir_if_not_present</span><span class="o">=</span><span class="n">make_dir_if_not_present</span><span class="p">,</span>
            <span class="n">cif_name</span><span class="o">=</span><span class="n">cif_name</span><span class="p">,</span>
            <span class="n">zip_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.zip&quot;</span> <span class="k">if</span> <span class="n">zip_output</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">files_to_transfer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">files_to_transfer</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="VaspInputSet.as_dict">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.VaspInputSet.as_dict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbosity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            verbosity: Verbosity for generated dict. If 1, structure is</span>
<span class="sd">            excluded.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: MSONable VaspInputSet representation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dct</span> <span class="o">=</span> <span class="n">MSONable</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">dct</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;structure&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dct</span></div>


    <span class="nd">@property</span>  <span class="c1"># type: ignore[no-redef]</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">structure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Structure</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># noqa: F811</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Structure.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span>

    <span class="nd">@structure</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_config_dict&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span> <span class="o">=</span> <span class="n">structure</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">SiteCollection</span><span class="p">):</span>  <span class="c1"># could be Structure or Molecule</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_potcar_functional</span> <span class="o">==</span> <span class="s2">&quot;PBE_54&quot;</span> <span class="ow">and</span> <span class="s2">&quot;W&quot;</span> <span class="ow">in</span> <span class="n">structure</span><span class="o">.</span><span class="n">symbol_set</span><span class="p">:</span>
                <span class="c1"># When using 5.4 POTCARs, default Tungsten POTCAR to W_Sv but still allow user to override</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user_potcar_settings</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;W&quot;</span><span class="p">:</span> <span class="s2">&quot;W_sv&quot;</span><span class="p">,</span>
                    <span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_potcar_settings</span> <span class="ow">or</span> <span class="p">{}),</span>
                <span class="p">}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce_structure</span><span class="p">:</span>
                <span class="n">structure</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">get_reduced_structure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reduce_structure</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_structure</span><span class="p">:</span>
                <span class="n">structure</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">get_sorted_structure</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_magmom</span><span class="p">:</span>
                <span class="n">get_valid_magmom_struct</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">spin_mode</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>

            <span class="n">struct_has_Yb</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">specie</span><span class="o">.</span><span class="n">symbol</span> <span class="o">==</span> <span class="s2">&quot;Yb&quot;</span> <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">structure</span> <span class="k">for</span> <span class="n">specie</span> <span class="ow">in</span> <span class="n">site</span><span class="o">.</span><span class="n">species</span><span class="p">)</span>
            <span class="n">potcar_settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;POTCAR&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_potcar_settings</span><span class="p">:</span>
                <span class="n">potcar_settings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_potcar_settings</span><span class="p">)</span>
            <span class="n">uses_Yb_2_psp</span> <span class="o">=</span> <span class="n">potcar_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Yb&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Yb_2&quot;</span>
            <span class="k">if</span> <span class="n">struct_has_Yb</span> <span class="ow">and</span> <span class="n">uses_Yb_2_psp</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;The structure contains Ytterbium (Yb) and this InputSet uses the Yb_2 PSP.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Yb_2 is known to often give bad results since Yb has oxidation state 3+ in most compounds.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;See https://github.com/materialsproject/pymatgen/issues/2968 for details.&quot;</span><span class="p">,</span>
                    <span class="n">BadInputSetWarning</span><span class="p">,</span>
                    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standardize</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_prec</span><span class="p">:</span>
                <span class="n">structure</span> <span class="o">=</span> <span class="n">standardize_structure</span><span class="p">(</span>
                    <span class="n">structure</span><span class="p">,</span>
                    <span class="n">sym_prec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sym_prec</span><span class="p">,</span>
                    <span class="n">international_monoclinic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">international_monoclinic</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span> <span class="o">=</span> <span class="n">structure</span>

<div class="viewcode-block" id="VaspInputSet.get_input_set">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.VaspInputSet.get_input_set">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_input_set</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">prev_dir</span><span class="p">:</span> <span class="n">PathLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">potcar_spec</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VaspInput</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a VASP input set.</span>

<span class="sd">        Note, if both ``structure`` and ``prev_dir`` are set, then the structure</span>
<span class="sd">        specified will be preferred over the final structure from the last VASP run.</span>

<span class="sd">        Args:</span>
<span class="sd">            structure (Structure): A structure.</span>
<span class="sd">            prev_dir (PathLike): A previous directory to generate the input set from.</span>
<span class="sd">            potcar_spec (bool): Instead of generating a Potcar object, use a list of</span>
<span class="sd">                potcar symbols. This will be written as a &quot;POTCAR.spec&quot; file. This is</span>
<span class="sd">                intended to help sharing an input set with people who might not have a</span>
<span class="sd">                license to specific Potcar files. Given a &quot;POTCAR.spec&quot;, the specific</span>
<span class="sd">                POTCAR file can be re-generated using pymatgen with the</span>
<span class="sd">                &quot;generate_potcar&quot; function in the pymatgen CLI.</span>

<span class="sd">        Returns:</span>
<span class="sd">            VaspInput: A VASP input object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">structure</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either structure or prev_dir must be set&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_previous</span><span class="p">(</span><span class="n">prev_dir</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">structure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">structure</span>

        <span class="k">return</span> <span class="n">VaspInput</span><span class="p">(</span>
            <span class="n">incar</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">incar</span><span class="p">,</span>
            <span class="n">kpoints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">,</span>
            <span class="n">poscar</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">poscar</span><span class="p">,</span>
            <span class="n">potcar</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">potcar_symbols</span><span class="p">)</span> <span class="k">if</span> <span class="n">potcar_spec</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">potcar</span><span class="p">,</span>
            <span class="n">potcar_spec</span><span class="o">=</span><span class="n">potcar_spec</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="VaspInputSet.get_vasp_input">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.VaspInputSet.get_vasp_input">[docs]</a>
    <span class="nd">@deprecated</span><span class="p">(</span><span class="n">get_input_set</span><span class="p">,</span> <span class="n">deadline</span><span class="o">=</span><span class="p">(</span><span class="mi">2026</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_vasp_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a VaspInput object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            VaspInput.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input_set</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">incar_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the INCAR config for this calculation type.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">kpoints_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the kpoints configuration for this calculation type.</span>

<span class="sd">        Note, these updates will be ignored if the user has set user_kpoint_settings.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict or Kpoints: A dictionary of updates to apply to the KPOINTS config</span>
<span class="sd">                or a Kpoints object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_previous</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prev_dir</span><span class="p">:</span> <span class="n">PathLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load previous calculation outputs.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">prev_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">vasprun</span><span class="p">,</span> <span class="n">outcar</span> <span class="o">=</span> <span class="n">get_vasprun_outcar</span><span class="p">(</span><span class="n">prev_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_vasprun</span> <span class="o">=</span> <span class="n">vasprun</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_outcar</span> <span class="o">=</span> <span class="n">outcar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_incar</span> <span class="o">=</span> <span class="n">vasprun</span><span class="o">.</span><span class="n">incar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_kpoints</span> <span class="o">=</span> <span class="n">Kpoints</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">vasprun</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">as_dict</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">vasprun</span><span class="o">.</span><span class="n">efermi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># VASP doesn&#39;t output efermi in vasprun if IBRION = 1</span>
            <span class="n">vasprun</span><span class="o">.</span><span class="n">efermi</span> <span class="o">=</span> <span class="n">outcar</span><span class="o">.</span><span class="n">efermi</span>

        <span class="n">bs</span> <span class="o">=</span> <span class="n">vasprun</span><span class="o">.</span><span class="n">get_band_structure</span><span class="p">(</span><span class="n">efermi</span><span class="o">=</span><span class="s2">&quot;smart&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bandgap</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">bs</span><span class="o">.</span><span class="n">is_metal</span><span class="p">()</span> <span class="k">else</span> <span class="n">bs</span><span class="o">.</span><span class="n">get_band_gap</span><span class="p">()[</span><span class="s2">&quot;energy&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_ispin</span><span class="p">:</span>
            <span class="c1"># Turn off spin when magmom for every site is smaller than 0.02.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ispin</span> <span class="o">=</span> <span class="n">_get_ispin</span><span class="p">(</span><span class="n">vasprun</span><span class="p">,</span> <span class="n">outcar</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">get_structure_from_prev_run</span><span class="p">(</span><span class="n">vasprun</span><span class="p">,</span> <span class="n">outcar</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">incar</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Incar</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The INCAR.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No structure is associated with the input set!&quot;</span><span class="p">)</span>

        <span class="n">prev_incar</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherit_incar</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_incar</span><span class="p">:</span>
            <span class="n">prev_incar</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_incar</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inherit_incar</span><span class="p">,</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_incar</span><span class="p">:</span>
            <span class="n">prev_incar</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">cast</span><span class="p">(</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_incar</span><span class="p">)[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherit_incar</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_incar</span>
            <span class="p">}</span>

        <span class="n">incar_updates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">incar_updates</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_dict</span><span class="p">[</span><span class="s2">&quot;INCAR&quot;</span><span class="p">])</span>
        <span class="n">auto_updates</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_ispin</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ispin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">auto_updates</span><span class="p">[</span><span class="s2">&quot;ISPIN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ispin</span>

        <span class="c1"># Breaking change - order in which settings applied inconsistent with atomate2</span>
        <span class="c1"># apply updates from input set generator to SETTINGS</span>
        <span class="c1"># _apply_incar_updates(settings, incar_updates)</span>

        <span class="c1"># Apply user incar settings to SETTINGS not to INCAR</span>
        <span class="n">_apply_incar_updates</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_incar_settings</span><span class="p">)</span>

        <span class="c1"># Generate INCAR</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">composition</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">((</span><span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">elements</span> <span class="k">if</span> <span class="n">comp</span><span class="p">[</span><span class="n">el</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
        <span class="n">most_electro_neg</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">symbol</span>
        <span class="n">poscar</span> <span class="o">=</span> <span class="n">Poscar</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
        <span class="n">hubbard_u</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LDAU&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">incar</span> <span class="o">=</span> <span class="n">Incar</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">setting</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;MAGMOM&quot;</span><span class="p">:</span>
                <span class="n">mag</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">structure</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">uic_magmom</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_incar_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MAGMOM&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">species_string</span><span class="p">):</span>
                        <span class="n">mag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uic_magmom</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="s2">&quot;magmom&quot;</span><span class="p">):</span>
                        <span class="n">mag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">magmom</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">specie</span><span class="p">,</span> <span class="s2">&quot;spin&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">mag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">specie</span><span class="o">.</span><span class="n">spin</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">str</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">specie</span><span class="p">)</span> <span class="ow">in</span> <span class="n">setting</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">site</span><span class="o">.</span><span class="n">specie</span><span class="o">.</span><span class="n">symbol</span> <span class="o">==</span> <span class="s2">&quot;Co&quot;</span> <span class="ow">and</span> <span class="n">setting</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">specie</span><span class="p">)]</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">:</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                                <span class="s2">&quot;Co without an oxidation state is initialized as low spin by default in Pymatgen. &quot;</span>
                                <span class="s2">&quot;If this default behavior is not desired, please set the spin on the magmom on the &quot;</span>
                                <span class="s2">&quot;site directly to ensure correct initialization.&quot;</span><span class="p">,</span>
                                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="n">mag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">setting</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">specie</span><span class="p">)))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">site</span><span class="o">.</span><span class="n">specie</span><span class="o">.</span><span class="n">symbol</span> <span class="o">==</span> <span class="s2">&quot;Co&quot;</span><span class="p">:</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                                <span class="s2">&quot;Co without an oxidation state is initialized as low spin by default in Pymatgen. &quot;</span>
                                <span class="s2">&quot;If this default behavior is not desired, please set the spin on the magmom on the &quot;</span>
                                <span class="s2">&quot;site directly to ensure correct initialization.&quot;</span><span class="p">,</span>
                                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="n">mag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">setting</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">specie</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">))</span>
                <span class="n">incar</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">mag</span>

            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;LDAUU&quot;</span><span class="p">,</span> <span class="s2">&quot;LDAUJ&quot;</span><span class="p">,</span> <span class="s2">&quot;LDAUL&quot;</span><span class="p">}:</span>
                <span class="k">if</span> <span class="n">hubbard_u</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">structure</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
                        <span class="n">m</span> <span class="o">=</span> <span class="p">{</span><span class="n">site</span><span class="o">.</span><span class="n">specie</span><span class="o">.</span><span class="n">symbol</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">structure</span><span class="p">}</span>
                        <span class="n">incar</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="n">sym</span><span class="p">]</span> <span class="k">for</span> <span class="n">sym</span> <span class="ow">in</span> <span class="n">poscar</span><span class="o">.</span><span class="n">site_symbols</span><span class="p">]</span>
                        <span class="c1"># Lookup specific LDAU if specified for most_electroneg atom</span>
                    <span class="k">elif</span> <span class="n">most_electro_neg</span> <span class="ow">in</span> <span class="n">setting</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">setting</span><span class="p">[</span><span class="n">most_electro_neg</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">incar</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">setting</span><span class="p">[</span><span class="n">most_electro_neg</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">sym</span> <span class="ow">in</span> <span class="n">poscar</span><span class="o">.</span><span class="n">site_symbols</span><span class="p">]</span>
                        <span class="c1"># Else, use fallback LDAU value if it exists</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">incar</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="p">(</span><span class="n">setting</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">setting</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">sym</span> <span class="ow">in</span> <span class="n">poscar</span><span class="o">.</span><span class="n">site_symbols</span>
                        <span class="p">]</span>

            <span class="k">elif</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;EDIFF&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;EDIFFG&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;EDIFF&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">settings</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;EDIFF_PER_ATOM&quot;</span><span class="p">:</span>
                    <span class="n">incar</span><span class="p">[</span><span class="s2">&quot;EDIFF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">setting</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">incar</span><span class="p">[</span><span class="s2">&quot;EDIFF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;EDIFF&quot;</span><span class="p">])</span>

            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;KSPACING&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_kspacing</span><span class="p">:</span>
                <span class="c1"># Default to metal if no prev calc available</span>
                <span class="n">bandgap</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandgap</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandgap</span>
                <span class="k">if</span> <span class="n">new_kspacing</span> <span class="o">:=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;kspacing_update&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="c1"># allow custom KSPACING update</span>
                    <span class="n">incar</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_kspacing</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">incar</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">auto_kspacing</span><span class="p">(</span><span class="n">bandgap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandgap_tol</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">incar</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">setting</span>

        <span class="n">has_u</span> <span class="o">=</span> <span class="n">hubbard_u</span> <span class="ow">and</span> <span class="nb">sum</span><span class="p">(</span><span class="n">incar</span><span class="p">[</span><span class="s2">&quot;LDAUU&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_u</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">incar</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;LDAU&quot;</span><span class="p">):</span>
                    <span class="k">del</span> <span class="n">incar</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># Modify LMAXMIX if you have d or f electrons present. Note that if the user</span>
        <span class="c1"># explicitly sets LMAXMIX in settings it will override this logic.</span>
        <span class="c1"># Previously, this was only set if Hubbard U was enabled as per the VASP manual</span>
        <span class="c1"># but following an investigation it was determined that this would lead to a</span>
        <span class="c1"># significant difference between SCF -&gt; NonSCF even without Hubbard U enabled.</span>
        <span class="c1"># Thanks to Andrew Rosen for investigating and reporting.</span>
        <span class="k">if</span> <span class="s2">&quot;LMAXMIX&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="c1"># contains f-electrons</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">Z</span> <span class="o">&gt;</span> <span class="mi">56</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">structure</span><span class="o">.</span><span class="n">composition</span><span class="p">):</span>
                <span class="n">incar</span><span class="p">[</span><span class="s2">&quot;LMAXMIX&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span>
            <span class="c1"># contains d-electrons</span>
            <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">Z</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">structure</span><span class="o">.</span><span class="n">composition</span><span class="p">):</span>
                <span class="n">incar</span><span class="p">[</span><span class="s2">&quot;LMAXMIX&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>

        <span class="c1"># Warn user about LASPH for +U, meta-GGAs, hybrids, and vdW-DF</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">incar</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LASPH&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="n">incar</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;METAGGA&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">incar</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LHFCALC&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">incar</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LDAU&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">incar</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LUSE_VDW&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;LASPH = True should be set for +U, meta-GGAs, hybrids, and vdW-DFT&quot;</span><span class="p">,</span>
                <span class="n">BadInputSetWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Apply previous INCAR settings, be careful not to override user_incar_settings</span>
        <span class="c1"># or the settings updates from the specific input set implementations</span>
        <span class="c1"># also skip LDAU/MAGMOM as structure may have changed.</span>
        <span class="n">skip</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_incar_settings</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">incar_updates</span><span class="p">)</span>
        <span class="n">skip</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;MAGMOM&quot;</span><span class="p">,</span> <span class="s2">&quot;NUPDOWN&quot;</span><span class="p">,</span> <span class="s2">&quot;LDAUU&quot;</span><span class="p">,</span> <span class="s2">&quot;LDAUL&quot;</span><span class="p">,</span> <span class="s2">&quot;LDAUJ&quot;</span><span class="p">]</span>
        <span class="n">_apply_incar_updates</span><span class="p">(</span><span class="n">incar</span><span class="p">,</span> <span class="n">prev_incar</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="n">skip</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">constrain_total_magmom</span><span class="p">:</span>
            <span class="n">nupdown</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mag</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mag</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.6</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">mag</span> <span class="ow">in</span> <span class="n">incar</span><span class="p">[</span><span class="s2">&quot;MAGMOM&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">nupdown</span> <span class="o">-</span> <span class="nb">round</span><span class="p">(</span><span class="n">nupdown</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">1e-5</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;constrain_total_magmom was set to True, but the sum of MAGMOM &quot;</span>
                    <span class="s2">&quot;values is not an integer. NUPDOWN is meant to set the spin &quot;</span>
                    <span class="s2">&quot;multiplet and should typically be an integer. You are likely &quot;</span>
                    <span class="s2">&quot;better off changing the values of MAGMOM or simply setting &quot;</span>
                    <span class="s2">&quot;NUPDOWN directly in your INCAR settings.&quot;</span><span class="p">,</span>
                    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">auto_updates</span><span class="p">[</span><span class="s2">&quot;NUPDOWN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nupdown</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_structure_charge</span><span class="p">:</span>
            <span class="n">auto_updates</span><span class="p">[</span><span class="s2">&quot;NELECT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nelect</span>

        <span class="c1"># Check that ALGO is appropriate</span>
        <span class="k">if</span> <span class="n">incar</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LHFCALC&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">incar</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ALGO&quot;</span><span class="p">,</span> <span class="s2">&quot;Normal&quot;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;Normal&quot;</span><span class="p">,</span>
            <span class="s2">&quot;All&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Damped&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Hybrid functionals only support Algo = All, Damped, or Normal.&quot;</span><span class="p">,</span>
                <span class="n">BadInputSetWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_ismear</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandgap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Don&#39;t know if we are a metal or insulator so set ISMEAR and SIGMA to</span>
                <span class="c1"># be safe with the most general settings</span>
                <span class="n">auto_updates</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ISMEAR</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">SIGMA</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandgap</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandgap_tol</span><span class="p">:</span>
                <span class="n">auto_updates</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ISMEAR</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">SIGMA</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>  <span class="c1"># metal</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">auto_updates</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ISMEAR</span><span class="o">=-</span><span class="mi">5</span><span class="p">,</span> <span class="n">SIGMA</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>  <span class="c1"># insulator</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_lreal</span><span class="p">:</span>
            <span class="n">auto_updates</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">LREAL</span><span class="o">=</span><span class="n">_get_recommended_lreal</span><span class="p">(</span><span class="n">structure</span><span class="p">))</span>

        <span class="c1"># Apply updates from auto options, careful not to override user_incar_settings</span>
        <span class="n">_apply_incar_updates</span><span class="p">(</span><span class="n">incar</span><span class="p">,</span> <span class="n">auto_updates</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_incar_settings</span><span class="p">))</span>

        <span class="c1"># Apply updates from input set generator to INCAR</span>
        <span class="n">_apply_incar_updates</span><span class="p">(</span><span class="n">incar</span><span class="p">,</span> <span class="n">incar_updates</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_incar_settings</span><span class="p">))</span>

        <span class="c1"># Finally, re-apply `self.user_incar_settings` to make sure any accidentally</span>
        <span class="c1"># overwritten settings are changed back to the intended values.</span>
        <span class="c1"># skip dictionary parameters to avoid dictionaries appearing in the INCAR</span>
        <span class="n">_apply_incar_updates</span><span class="p">(</span><span class="n">incar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_incar_settings</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;LDAUU&quot;</span><span class="p">,</span> <span class="s2">&quot;LDAUJ&quot;</span><span class="p">,</span> <span class="s2">&quot;LDAUL&quot;</span><span class="p">,</span> <span class="s2">&quot;MAGMOM&quot;</span><span class="p">])</span>

        <span class="c1"># Remove unused INCAR parameters</span>
        <span class="n">_remove_unused_incar_params</span><span class="p">(</span><span class="n">incar</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_incar_settings</span><span class="p">))</span>

        <span class="n">kpoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span>
        <span class="k">if</span> <span class="n">kpoints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Unset KSPACING as we are using a KPOINTS file</span>
            <span class="n">incar</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;KSPACING&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s2">&quot;KSPACING&quot;</span> <span class="ow">in</span> <span class="n">incar</span> <span class="ow">and</span> <span class="s2">&quot;KSPACING&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_incar_settings</span> <span class="ow">and</span> <span class="s2">&quot;KSPACING&quot;</span> <span class="ow">in</span> <span class="n">prev_incar</span><span class="p">:</span>
            <span class="c1"># Prefer to inherit KSPACING from previous INCAR if it exists</span>
            <span class="c1"># TODO: Is that we actually want to do? Copied from current pymatgen inputsets</span>
            <span class="n">incar</span><span class="p">[</span><span class="s2">&quot;KSPACING&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev_incar</span><span class="p">[</span><span class="s2">&quot;KSPACING&quot;</span><span class="p">]</span>

        <span class="c1"># Ensure adequate number of KPOINTS are present for the tetrahedron method</span>
        <span class="c1"># (ISMEAR=-5). If KSPACING is in the INCAR file the number of kpoints is not</span>
        <span class="c1"># known before calling VASP, but a warning is raised when the KSPACING value is</span>
        <span class="c1"># &gt; 0.5 (2 reciprocal Angstrom). An error handler in Custodian is available to</span>
        <span class="c1"># correct overly large KSPACING values (small number of kpoints) if necessary.</span>
        <span class="k">if</span> <span class="n">kpoints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">kpoints</span><span class="o">.</span><span class="n">kpts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">incar</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ISMEAR&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">5</span><span class="p">:</span>
            <span class="n">incar</span><span class="p">[</span><span class="s2">&quot;ISMEAR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">incar</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;KSPACING&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="ow">and</span> <span class="n">incar</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ISMEAR&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">5</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Large KSPACING value detected with ISMEAR = -5. Ensure that VASP &quot;</span>
                <span class="s2">&quot;generates an adequate number of KPOINTS, lower KSPACING, or &quot;</span>
                <span class="s2">&quot;set ISMEAR = 0&quot;</span><span class="p">,</span>
                <span class="n">BadInputSetWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">ismear</span> <span class="o">=</span> <span class="n">incar</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ISMEAR&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">incar</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SIGMA&quot;</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">all</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">is_metal</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">structure</span><span class="o">.</span><span class="n">composition</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">incar</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NSW&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="p">(</span><span class="n">ismear</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ismear</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">sigma</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">))</span>
        <span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">ismear</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Relaxation of likely metal with ISMEAR &lt; 0 (</span><span class="si">{</span><span class="n">ismear</span><span class="si">}</span><span class="s2">).&quot;</span>
            <span class="k">elif</span> <span class="n">ismear</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">sigma</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ISMEAR = 0 with a small SIGMA (</span><span class="si">{</span><span class="n">sigma</span><span class="si">}</span><span class="s2">) detected.&quot;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2"> See VASP recommendations on ISMEAR for metals (https://www.vasp.at/wiki/index.php/ISMEAR).&quot;</span><span class="p">,</span>
                <span class="n">BadInputSetWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">incar</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">poscar</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Poscar</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Poscar.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No structure is associated with the input set!&quot;</span><span class="p">)</span>

        <span class="n">site_properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">site_properties</span>
        <span class="k">return</span> <span class="n">Poscar</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span>
            <span class="n">velocities</span><span class="o">=</span><span class="n">site_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;velocities&quot;</span><span class="p">),</span>
            <span class="n">predictor_corrector</span><span class="o">=</span><span class="n">site_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;predictor_corrector&quot;</span><span class="p">),</span>
            <span class="n">predictor_corrector_preamble</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;predictor_corrector_preamble&quot;</span><span class="p">),</span>
            <span class="n">lattice_velocities</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lattice_velocities&quot;</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">potcar_functional</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UserPotcarFunctional</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The functional used for POTCAR generation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_potcar_functional</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">nelect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The default number of electrons for a given structure.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No structure is associated with the input set!&quot;</span><span class="p">)</span>

        <span class="n">n_electrons_by_element</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="o">.</span><span class="n">element</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">nelectrons</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">potcar</span><span class="p">}</span>
        <span class="n">n_elect</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="n">num_atoms</span> <span class="o">*</span> <span class="n">n_electrons_by_element</span><span class="p">[</span><span class="n">el</span><span class="o">.</span><span class="n">symbol</span><span class="p">]</span> <span class="k">for</span> <span class="n">el</span><span class="p">,</span> <span class="n">num_atoms</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">n_elect</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">charge</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_structure_charge</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">kpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Kpoints</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The KPOINTS file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No structure is associated with the input set!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_incar_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;KSPACING&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incar_updates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;KSPACING&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_dict</span><span class="p">[</span><span class="s2">&quot;INCAR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;KSPACING&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_kpoints_settings</span> <span class="o">==</span> <span class="p">{}:</span>
            <span class="c1"># If KSPACING specified then always use this over k-points</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Use user setting if set otherwise default to base config settings</span>
        <span class="n">kpoints_updates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints_updates</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_kpoints_settings</span> <span class="o">!=</span> <span class="p">{}:</span>
            <span class="n">kconfig</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_kpoints_settings</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kpoints_updates</span><span class="p">,</span> <span class="n">Kpoints</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">kpoints_updates</span>
        <span class="k">elif</span> <span class="n">kpoints_updates</span> <span class="o">!=</span> <span class="p">{}:</span>
            <span class="n">kconfig</span> <span class="o">=</span> <span class="n">kpoints_updates</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kconfig</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;KPOINTS&quot;</span><span class="p">,</span> <span class="p">{}))</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kconfig</span><span class="p">,</span> <span class="n">Kpoints</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">kconfig</span>

        <span class="n">explicit</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">kconfig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;explicit&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">kconfig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;added_kpoints&quot;</span><span class="p">,</span> <span class="p">[]))</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="ow">or</span> <span class="s2">&quot;zero_weighted_reciprocal_density&quot;</span> <span class="ow">in</span> <span class="n">kconfig</span>
            <span class="ow">or</span> <span class="s2">&quot;zero_weighted_line_density&quot;</span> <span class="ow">in</span> <span class="n">kconfig</span>
        <span class="p">)</span>
        <span class="c1"># Handle length generation first as this doesn&#39;t support any additional options</span>
        <span class="k">if</span> <span class="n">kconfig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;length&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">explicit</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;length option cannot be used with explicit k-point generation, &quot;</span>
                    <span class="s2">&quot;added_kpoints, or zero weighted k-points.&quot;</span>
                <span class="p">)</span>
            <span class="c1"># If length is in kpoints settings use Kpoints.automatic</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Please use INCAR KSPACING tag&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Kpoints</span><span class="o">.</span><span class="n">automatic</span><span class="p">(</span><span class="n">kconfig</span><span class="p">[</span><span class="s2">&quot;length&quot;</span><span class="p">])</span>

        <span class="n">base_kpoints</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">kconfig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;line_density&quot;</span><span class="p">):</span>
            <span class="c1"># Handle line density generation</span>
            <span class="n">kpath</span> <span class="o">=</span> <span class="n">HighSymmKpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="o">**</span><span class="n">kconfig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kpath_kwargs&quot;</span><span class="p">,</span> <span class="p">{}))</span>
            <span class="n">frac_k_points</span><span class="p">,</span> <span class="n">k_points_labels</span> <span class="o">=</span> <span class="n">kpath</span><span class="o">.</span><span class="n">get_kpoints</span><span class="p">(</span>
                <span class="n">line_density</span><span class="o">=</span><span class="n">kconfig</span><span class="p">[</span><span class="s2">&quot;line_density&quot;</span><span class="p">],</span> <span class="n">coords_are_cartesian</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">base_kpoints</span> <span class="o">=</span> <span class="n">Kpoints</span><span class="p">(</span>
                <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;Non SCF run along symmetry lines&quot;</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="n">Kpoints</span><span class="o">.</span><span class="n">supported_modes</span><span class="o">.</span><span class="n">Reciprocal</span><span class="p">,</span>
                <span class="n">num_kpts</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">frac_k_points</span><span class="p">),</span>
                <span class="n">kpts</span><span class="o">=</span><span class="n">frac_k_points</span><span class="p">,</span>
                <span class="n">labels</span><span class="o">=</span><span class="n">k_points_labels</span><span class="p">,</span>
                <span class="n">kpts_weights</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">frac_k_points</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">kconfig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;grid_density&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">kconfig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reciprocal_density&quot;</span><span class="p">):</span>
            <span class="c1"># Handle regular weighted k-point grid generation</span>
            <span class="k">if</span> <span class="n">kconfig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;grid_density&quot;</span><span class="p">):</span>
                <span class="n">base_kpoints</span> <span class="o">=</span> <span class="n">Kpoints</span><span class="o">.</span><span class="n">automatic_density</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">kconfig</span><span class="p">[</span><span class="s2">&quot;grid_density&quot;</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_gamma</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">kconfig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reciprocal_density&quot;</span><span class="p">):</span>
                <span class="n">density</span> <span class="o">=</span> <span class="n">kconfig</span><span class="p">[</span><span class="s2">&quot;reciprocal_density&quot;</span><span class="p">]</span>
                <span class="n">base_kpoints</span> <span class="o">=</span> <span class="n">Kpoints</span><span class="o">.</span><span class="n">automatic_density_by_vol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">density</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_gamma</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">explicit</span> <span class="ow">or</span> <span class="n">base_kpoints</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># If not explicit that means no other options have been specified</span>
                <span class="c1"># so we can return the k-points as is</span>
                <span class="k">return</span> <span class="n">base_kpoints</span>

            <span class="n">sga</span> <span class="o">=</span> <span class="n">SpacegroupAnalyzer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">symprec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sym_prec</span><span class="p">)</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="n">sga</span><span class="o">.</span><span class="n">get_ir_reciprocal_mesh</span><span class="p">(</span><span class="n">base_kpoints</span><span class="o">.</span><span class="n">kpts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">base_kpoints</span> <span class="o">=</span> <span class="n">Kpoints</span><span class="p">(</span>
                <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;Uniform grid&quot;</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="n">Kpoints</span><span class="o">.</span><span class="n">supported_modes</span><span class="o">.</span><span class="n">Reciprocal</span><span class="p">,</span>
                <span class="n">num_kpts</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="p">),</span>
                <span class="n">kpts</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mesh</span><span class="p">),</span>
                <span class="n">kpts_weights</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mesh</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="n">zero_weighted_kpoints</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">kconfig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zero_weighted_line_density&quot;</span><span class="p">):</span>
            <span class="c1"># zero_weighted k-points along line mode path</span>
            <span class="n">kpath</span> <span class="o">=</span> <span class="n">HighSymmKpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>
            <span class="n">frac_k_points</span><span class="p">,</span> <span class="n">k_points_labels</span> <span class="o">=</span> <span class="n">kpath</span><span class="o">.</span><span class="n">get_kpoints</span><span class="p">(</span>
                <span class="n">line_density</span><span class="o">=</span><span class="n">kconfig</span><span class="p">[</span><span class="s2">&quot;zero_weighted_line_density&quot;</span><span class="p">],</span>
                <span class="n">coords_are_cartesian</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">zero_weighted_kpoints</span> <span class="o">=</span> <span class="n">Kpoints</span><span class="p">(</span>
                <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;Hybrid run along symmetry lines&quot;</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="n">Kpoints</span><span class="o">.</span><span class="n">supported_modes</span><span class="o">.</span><span class="n">Reciprocal</span><span class="p">,</span>
                <span class="n">num_kpts</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">frac_k_points</span><span class="p">),</span>
                <span class="n">kpts</span><span class="o">=</span><span class="n">frac_k_points</span><span class="p">,</span>
                <span class="n">labels</span><span class="o">=</span><span class="n">k_points_labels</span><span class="p">,</span>
                <span class="n">kpts_weights</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">frac_k_points</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">kconfig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zero_weighted_reciprocal_density&quot;</span><span class="p">):</span>
            <span class="n">zero_weighted_kpoints</span> <span class="o">=</span> <span class="n">Kpoints</span><span class="o">.</span><span class="n">automatic_density_by_vol</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span>
                <span class="n">kconfig</span><span class="p">[</span><span class="s2">&quot;zero_weighted_reciprocal_density&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">force_gamma</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">sga</span> <span class="o">=</span> <span class="n">SpacegroupAnalyzer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">symprec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sym_prec</span><span class="p">)</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="n">sga</span><span class="o">.</span><span class="n">get_ir_reciprocal_mesh</span><span class="p">(</span><span class="n">zero_weighted_kpoints</span><span class="o">.</span><span class="n">kpts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">zero_weighted_kpoints</span> <span class="o">=</span> <span class="n">Kpoints</span><span class="p">(</span>
                <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;Uniform grid&quot;</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="n">Kpoints</span><span class="o">.</span><span class="n">supported_modes</span><span class="o">.</span><span class="n">Reciprocal</span><span class="p">,</span>
                <span class="n">num_kpts</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="p">),</span>
                <span class="n">kpts</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mesh</span><span class="p">),</span>
                <span class="n">kpts_weights</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">mesh</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="n">added_kpoints</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">kconfig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;added_kpoints&quot;</span><span class="p">):</span>
            <span class="n">points</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">kconfig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;added_kpoints&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">added_kpoints</span> <span class="o">=</span> <span class="n">Kpoints</span><span class="p">(</span>
                <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;Specified k-points only&quot;</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="n">Kpoints</span><span class="o">.</span><span class="n">supported_modes</span><span class="o">.</span><span class="n">Reciprocal</span><span class="p">,</span>
                <span class="n">num_kpts</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">),</span>
                <span class="n">kpts</span><span class="o">=</span><span class="n">points</span><span class="p">,</span>
                <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user-defined&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">),</span>
                <span class="n">kpts_weights</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">base_kpoints</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">added_kpoints</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">zero_weighted_kpoints</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">base_kpoints</span>
        <span class="k">if</span> <span class="n">added_kpoints</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">base_kpoints</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">zero_weighted_kpoints</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">added_kpoints</span>

        <span class="c1"># Sanity check</span>
        <span class="k">if</span> <span class="s2">&quot;line_density&quot;</span> <span class="ow">in</span> <span class="n">kconfig</span> <span class="ow">and</span> <span class="n">zero_weighted_kpoints</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot combine line_density and zero weighted k-points options&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">zero_weighted_kpoints</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">base_kpoints</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Zero weighted k-points must be used with reciprocal_density or grid_density options&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">base_kpoints</span> <span class="ow">or</span> <span class="n">zero_weighted_kpoints</span> <span class="ow">or</span> <span class="n">added_kpoints</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Invalid k-point generation algo. Supported Keys are &#39;grid_density&#39; &quot;</span>
                <span class="s2">&quot;for Kpoints.automatic_density generation, &#39;reciprocal_density&#39; for &quot;</span>
                <span class="s2">&quot;KPoints.automatic_density_by_vol generation, &#39;length&#39; for &quot;</span>
                <span class="s2">&quot;Kpoints.automatic generation, &#39;line_density&#39; for line mode generation,&quot;</span>
                <span class="s2">&quot; &#39;added_kpoints&#39; for specific k-points to include, &quot;</span>
                <span class="s2">&quot; &#39;zero_weighted_reciprocal_density&#39; for a zero weighted uniform mesh,&quot;</span>
                <span class="s2">&quot; or &#39;zero_weighted_line_density&#39; for a zero weighted line mode mesh.&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">_combine_kpoints</span><span class="p">(</span><span class="n">base_kpoints</span><span class="p">,</span> <span class="n">zero_weighted_kpoints</span><span class="p">,</span> <span class="n">added_kpoints</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">potcar</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Potcar</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The input set&#39;s POTCAR.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No structure is associated with the input set!&quot;</span><span class="p">)</span>

        <span class="n">user_potcar_functional</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_potcar_functional</span>
        <span class="n">potcar</span> <span class="o">=</span> <span class="n">Potcar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">potcar_symbols</span><span class="p">,</span> <span class="n">functional</span><span class="o">=</span><span class="n">user_potcar_functional</span><span class="p">)</span>

        <span class="c1"># Warn if the selected POTCARs do not correspond to the chosen user_potcar_functional</span>
        <span class="k">for</span> <span class="n">p_single</span> <span class="ow">in</span> <span class="n">potcar</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">user_potcar_functional</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p_single</span><span class="o">.</span><span class="n">identify_potcar</span><span class="p">()[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;POTCAR data with symbol </span><span class="si">{</span><span class="n">p_single</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2"> is not known by pymatgen to &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;correspond with the selected </span><span class="si">{</span><span class="n">user_potcar_functional</span><span class="si">=}</span><span class="s2">. This POTCAR &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;is known to correspond with functionals </span><span class="si">{</span><span class="n">p_single</span><span class="o">.</span><span class="n">identify_potcar</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="s2">&quot;Please verify that you are using the right POTCARs!&quot;</span><span class="p">,</span>
                    <span class="n">BadInputSetWarning</span><span class="p">,</span>
                    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">potcar</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">potcar_symbols</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List of POTCAR symbols.&quot;&quot;&quot;</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">poscar</span><span class="o">.</span><span class="n">site_symbols</span>
        <span class="n">potcar_symbols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_dict</span><span class="p">[</span><span class="s2">&quot;POTCAR&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="n">elements</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">potcar_symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="n">el</span><span class="p">][</span><span class="s2">&quot;symbol&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">settings</span> <span class="k">else</span> <span class="n">el</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">potcar_symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">el</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">potcar_symbols</span>

<div class="viewcode-block" id="VaspInputSet.estimate_nbands">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.VaspInputSet.estimate_nbands">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">estimate_nbands</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Estimate the number of bands that VASP will initialize a</span>
<span class="sd">        calculation with by default. Note that in practice this</span>
<span class="sd">        can depend on # of cores (if not set explicitly).</span>

<span class="sd">        Note that this formula is slightly different than the formula on the VASP wiki</span>
<span class="sd">        (as of July 2023). This is because the formula in the source code (`main.F`) is</span>
<span class="sd">        slightly different than what is on the wiki.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No structure is associated with the input set!&quot;</span><span class="p">)</span>

        <span class="n">n_ions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>

        <span class="c1"># As per the VASP source, if non-spin polarized ignore n_mag</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">incar</span><span class="p">[</span><span class="s2">&quot;ISPIN&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">n_mag</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Otherwise set equal to sum of total magmoms</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_mag</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">incar</span><span class="p">[</span><span class="s2">&quot;MAGMOM&quot;</span><span class="p">])</span>
            <span class="n">n_mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">n_mag</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">possible_val_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nelect</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">n_ions</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">possible_val_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nelect</span> <span class="o">*</span> <span class="mf">0.6</span><span class="p">)</span>

        <span class="n">n_bands</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">possible_val_1</span><span class="p">,</span> <span class="n">possible_val_2</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_mag</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">incar</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LNONCOLLINEAR&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">n_bands</span> <span class="o">*=</span> <span class="mi">2</span>

        <span class="k">if</span> <span class="n">n_par</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">incar</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NPAR&quot;</span><span class="p">):</span>
            <span class="n">n_bands</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">n_bands</span> <span class="o">+</span> <span class="n">n_par</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_par</span><span class="p">))</span> <span class="o">*</span> <span class="n">n_par</span>

        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_bands</span><span class="p">)</span></div>


<div class="viewcode-block" id="VaspInputSet.override_from_prev_calc">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.VaspInputSet.override_from_prev_calc">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">override_from_prev_calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prev_calc_dir</span><span class="p">:</span> <span class="n">PathLike</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the input set to include settings from a previous calculation.</span>

<span class="sd">        Args:</span>
<span class="sd">            prev_calc_dir (PathLike): The path to the previous calculation directory.</span>

<span class="sd">        Returns:</span>
<span class="sd">            VaspInputSet: A new input set with settings (Structure, k-points, incar, etc)</span>
<span class="sd">                updated using the previous VASP run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_previous</span><span class="p">(</span><span class="n">prev_calc_dir</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standardize</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Use of standardize=True with from_prev_run is not &quot;</span>
                <span class="s2">&quot;recommended as there is no guarantee the copied &quot;</span>
                <span class="s2">&quot;files will be appropriate for the standardized &quot;</span>
                <span class="s2">&quot;structure.&quot;</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">files_to_transfer</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;copy_chgcar&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">chgcars</span> <span class="o">:=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">prev_calc_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;CHGCAR*&quot;</span><span class="p">)))):</span>
            <span class="n">files_to_transfer</span><span class="p">[</span><span class="s2">&quot;CHGCAR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">chgcars</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;copy_wavecar&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;WAVECAR&quot;</span><span class="p">,</span> <span class="s2">&quot;WAVEDER&quot;</span><span class="p">,</span> <span class="s2">&quot;WFULL&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">wavecar_files</span> <span class="o">:=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">prev_calc_dir</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">*&quot;</span><span class="p">)))):</span>
                    <span class="k">if</span> <span class="n">fname</span> <span class="o">==</span> <span class="s2">&quot;WFULL&quot;</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">wavecar_file</span> <span class="ow">in</span> <span class="n">wavecar_files</span><span class="p">:</span>
                            <span class="n">fname</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">wavecar_file</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
                            <span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">files_to_transfer</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">=</span> <span class="n">wavecar_file</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">files_to_transfer</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">wavecar_files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">files_to_transfer</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">files_to_transfer</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="VaspInputSet.from_prev_calc">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.VaspInputSet.from_prev_calc">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_prev_calc</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">prev_calc_dir</span><span class="p">:</span> <span class="n">PathLike</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a set of VASP input files for static calculations from a</span>
<span class="sd">        directory of previous VASP run.</span>

<span class="sd">        Args:</span>
<span class="sd">            prev_calc_dir (PathLike): Directory containing the outputs(</span>
<span class="sd">                vasprun.xml and OUTCAR) of previous VASP run.</span>
<span class="sd">            **kwargs: All kwargs supported by MPStaticSet, other than prev_incar</span>
<span class="sd">                and prev_structure and prev_kpoints which are determined from</span>
<span class="sd">                the prev_calc_dir.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">input_set</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">_dummy_structure</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">input_set</span><span class="o">.</span><span class="n">override_from_prev_calc</span><span class="p">(</span><span class="n">prev_calc_dir</span><span class="o">=</span><span class="n">prev_calc_dir</span><span class="p">)</span></div>


<div class="viewcode-block" id="VaspInputSet.calculate_ng">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.VaspInputSet.calculate_ng">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_ng</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">max_prime_factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
        <span class="n">must_inc_2</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">custom_encut</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">custom_prec</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the NGX, NGY, and NGZ values using the information available in the INCAR and POTCAR</span>
<span class="sd">        This is meant to help with making initial guess for the FFT grid so we can interact with the Charge density API.</span>

<span class="sd">        Args:</span>
<span class="sd">            max_prime_factor (int): the valid prime factors of the grid size in each direction</span>
<span class="sd">                VASP has many different setting for this to handle many compiling options.</span>
<span class="sd">                For typical MPI options all prime factors up to 7 are allowed</span>
<span class="sd">            must_inc_2 (bool): Whether 2 must be a prime factor of the result. Defaults to True.</span>
<span class="sd">            custom_encut (float | None): Calculates the FFT grid parameters using a custom</span>
<span class="sd">                ENCUT that may be different from what is generated by the input set. Defaults to None.</span>
<span class="sd">                Do *not* use this unless you know what you are doing.</span>
<span class="sd">            custom_prec (str | None): Calculates the FFT grid parameters using a custom prec</span>
<span class="sd">                that may be different from what is generated by the input set. Defaults to None.</span>
<span class="sd">                Do *not* use this unless you know what you are doing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO throw error for Ultrasoft potentials</span>

        <span class="n">_RYTOEV</span> <span class="o">=</span> <span class="mf">13.605826</span>
        <span class="n">_AUTOA</span> <span class="o">=</span> <span class="mf">0.529177249</span>

        <span class="c1"># TODO Only do this for VASP 6 for now. Older version require more advanced logic</span>

        <span class="k">if</span> <span class="n">custom_encut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">encut</span> <span class="o">=</span> <span class="n">custom_encut</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">incar</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ENCUT&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">encut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">incar</span><span class="p">[</span><span class="s2">&quot;ENCUT&quot;</span><span class="p">]</span>  <span class="c1"># get the ENCUT val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">encut</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">i_species</span><span class="o">.</span><span class="n">enmax</span> <span class="k">for</span> <span class="n">i_species</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vasp_input</span><span class="p">()[</span><span class="s2">&quot;POTCAR&quot;</span><span class="p">])</span>

        <span class="c1"># PREC=Normal is VASP default</span>
        <span class="n">PREC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">incar</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PREC&quot;</span><span class="p">,</span> <span class="s2">&quot;Normal&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">custom_prec</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">custom_prec</span>

        <span class="c1"># Check for unsupported / invalid PREC tags</span>
        <span class="k">if</span> <span class="n">PREC</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;h&quot;</span><span class="p">}:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;PREC = LOW/MEDIUM/HIGH from VASP 4.x and not supported, Please use NORMA/SINGLE/ACCURATE&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">PREC</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;h&quot;</span><span class="p">}:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">PREC</span><span class="si">=}</span><span class="s2"> does not exist. If this is no longer correct, please update this code.&quot;</span><span class="p">)</span>

        <span class="n">CUTOFF</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">encut</span> <span class="o">/</span> <span class="n">_RYTOEV</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="p">(</span><span class="n">anorm</span> <span class="o">/</span> <span class="n">_AUTOA</span><span class="p">))</span> <span class="k">for</span> <span class="n">anorm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">poscar</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">abc</span>
        <span class="p">]</span>

        <span class="c1"># TODO This only works in VASP 6.x</span>
        <span class="n">_WFACT</span> <span class="o">=</span> <span class="mi">4</span> <span class="k">if</span> <span class="n">PREC</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">}</span> <span class="k">else</span> <span class="mi">3</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">next_g_size</span><span class="p">(</span><span class="n">cur_g_size</span><span class="p">):</span>
            <span class="n">g_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_WFACT</span> <span class="o">*</span> <span class="n">cur_g_size</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">next_num_with_prime_factors</span><span class="p">(</span><span class="n">g_size</span><span class="p">,</span> <span class="n">max_prime_factor</span><span class="p">,</span> <span class="n">must_inc_2</span><span class="p">)</span>

        <span class="n">ng_vec</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="n">next_g_size</span><span class="p">,</span> <span class="n">CUTOFF</span><span class="p">)]</span>

        <span class="c1"># TODO This works for VASP 5.x and 6.x</span>
        <span class="n">finer_g_scale</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">PREC</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">}</span> <span class="k">else</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">ng_vec</span><span class="p">,</span> <span class="p">[</span><span class="n">ng_</span> <span class="o">*</span> <span class="n">finer_g_scale</span> <span class="k">for</span> <span class="n">ng_</span> <span class="ow">in</span> <span class="n">ng_vec</span><span class="p">]</span></div>


<div class="viewcode-block" id="VaspInputSet.from_directory">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.VaspInputSet.from_directory">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_directory</span><span class="p">(</span><span class="n">directory</span><span class="p">:</span> <span class="n">PathLike</span><span class="p">,</span> <span class="n">optional_files</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VaspInput</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load a set of VASP inputs from a directory.</span>

<span class="sd">        Note that only the standard INCAR, POSCAR, POTCAR and KPOINTS files are read</span>
<span class="sd">        unless optional_filenames is specified.</span>

<span class="sd">        Args:</span>
<span class="sd">            directory: Directory to read VASP inputs from.</span>
<span class="sd">            optional_files: Optional files to read in as well as a dict of {filename: Object class}.</span>
<span class="sd">                Object class must have a static/class method from_file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="n">objs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;INCAR&quot;</span><span class="p">:</span> <span class="n">Incar</span><span class="p">,</span> <span class="s2">&quot;KPOINTS&quot;</span><span class="p">:</span> <span class="n">Kpoints</span><span class="p">,</span> <span class="s2">&quot;POSCAR&quot;</span><span class="p">:</span> <span class="n">Poscar</span><span class="p">,</span> <span class="s2">&quot;POTCAR&quot;</span><span class="p">:</span> <span class="n">Potcar</span><span class="p">}</span>

        <span class="n">inputs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">directory</span> <span class="o">/</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">inputs</span><span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">directory</span> <span class="o">/</span> <span class="n">name</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Handle the case where there is no KPOINTS file</span>
                <span class="n">inputs</span><span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">optional_inputs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">optional_files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">optional_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">optional_inputs</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">directory</span> <span class="o">/</span> <span class="n">name</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>

        <span class="k">return</span> <span class="n">VaspInput</span><span class="p">(</span>
            <span class="n">incar</span><span class="o">=</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;INCAR&quot;</span><span class="p">],</span>
            <span class="n">kpoints</span><span class="o">=</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;KPOINTS&quot;</span><span class="p">],</span>
            <span class="n">poscar</span><span class="o">=</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;POSCAR&quot;</span><span class="p">],</span>
            <span class="n">potcar</span><span class="o">=</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;POTCAR&quot;</span><span class="p">],</span>
            <span class="n">optional_files</span><span class="o">=</span><span class="n">optional_inputs</span><span class="p">,</span>  <span class="c1"># type: ignore[arg-type]</span>
        <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_get_nedos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dedos</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Automatic setting of NEDOS using the energy range and the energy step.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_vasprun</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_vasprun</span><span class="o">.</span><span class="n">eigenvalues</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">2000</span>

        <span class="n">emax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">eigs</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">for</span> <span class="n">eigs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_vasprun</span><span class="o">.</span><span class="n">eigenvalues</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">emin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">eigs</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="k">for</span> <span class="n">eigs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_vasprun</span><span class="o">.</span><span class="n">eigenvalues</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">((</span><span class="n">emax</span> <span class="o">-</span> <span class="n">emin</span><span class="p">)</span> <span class="o">/</span> <span class="n">dedos</span><span class="p">)</span></div>



<span class="c1"># Create VaspInputGenerator alias to follow atomate2 terminology</span>
<span class="n">VaspInputGenerator</span> <span class="o">=</span> <span class="n">VaspInputSet</span>


<div class="viewcode-block" id="DictSet">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.DictSet">[docs]</a>
<span class="nd">@deprecated</span><span class="p">(</span><span class="n">VaspInputSet</span><span class="p">,</span> <span class="n">deadline</span><span class="o">=</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">))</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DictSet</span><span class="p">(</span><span class="n">VaspInputSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Alias for VaspInputSet.&quot;&quot;&quot;</span></div>



<span class="c1"># Helper functions to determine valid FFT grids for VASP</span>
<div class="viewcode-block" id="next_num_with_prime_factors">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.next_num_with_prime_factors">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">next_num_with_prime_factors</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">max_prime_factor</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">must_inc_2</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the next number greater than or equal to n that only has the desired prime factors.</span>

<span class="sd">    Args:</span>
<span class="sd">        n (int): Initial guess at the grid density</span>
<span class="sd">        max_prime_factor (int): the maximum prime factor</span>
<span class="sd">        must_inc_2 (bool): 2 must be a prime factor of the result</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: first product of the prime_factors that is &gt;= n</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">max_prime_factor</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must choose a maximum prime factor greater than 2&quot;</span><span class="p">)</span>

    <span class="n">prime_factors</span> <span class="o">=</span> <span class="n">primes_less_than</span><span class="p">(</span><span class="n">max_prime_factor</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">new_val</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">must_inc_2</span> <span class="ow">and</span> <span class="n">new_val</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">cur_val_</span> <span class="o">=</span> <span class="n">new_val</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">prime_factors</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">cur_val_</span> <span class="o">%</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cur_val_</span> <span class="o">//=</span> <span class="n">j</span>
        <span class="k">if</span> <span class="n">cur_val_</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">new_val</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No factorable number found, not possible.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="primes_less_than">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.primes_less_than">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">primes_less_than</span><span class="p">(</span><span class="n">max_val</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the primes less than or equal to the max value.&quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_val</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span></div>



<div class="viewcode-block" id="MITRelaxSet">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.MITRelaxSet">[docs]</a>
<span class="nd">@due</span><span class="o">.</span><span class="n">dcite</span><span class="p">(</span>
    <span class="n">Doi</span><span class="p">(</span><span class="s2">&quot;10.1016/j.commatsci.2011.02.023&quot;</span><span class="p">),</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;A high-throughput infrastructure for density functional theory calculations&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MITRelaxSet</span><span class="p">(</span><span class="n">VaspInputSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Standard implementation of VaspInputSet utilizing parameters in the MIT</span>
<span class="sd">    High-throughput project.</span>
<span class="sd">    The parameters are chosen specifically for a high-throughput project,</span>
<span class="sd">    which means in general pseudopotentials with fewer electrons were chosen.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure (Structure): The Structure to create inputs for. If None, the input</span>
<span class="sd">            set is initialized without a Structure but one must be set separately before</span>
<span class="sd">            the inputs are generated.</span>
<span class="sd">        **kwargs: Keywords supported by VaspInputSet.</span>

<span class="sd">    Please refer:</span>
<span class="sd">        A Jain, G. Hautier, C. Moore, S. P. Ong, C. Fischer, T. Mueller,</span>
<span class="sd">        K. A. Persson, G. Ceder. A high-throughput infrastructure for density</span>
<span class="sd">        functional theory calculations. Computational Materials Science,</span>
<span class="sd">        2011, 50(8), 2295-2310. doi:10.1016/j.commatsci.2011.02.023</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">_load_yaml_config</span><span class="p">(</span><span class="s2">&quot;MITRelaxSet&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="MPRelaxSet">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.MPRelaxSet">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MPRelaxSet</span><span class="p">(</span><span class="n">VaspInputSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implementation of VaspInputSet utilizing parameters in the public</span>
<span class="sd">    Materials Project. Typically, the pseudopotentials chosen contain more</span>
<span class="sd">    electrons than the MIT parameters, and the k-point grid is ~50% more dense.</span>
<span class="sd">    The LDAUU parameters are also different due to the different PSPs used,</span>
<span class="sd">    which result in different fitted values.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure (Structure): The Structure to create inputs for. If None, the input</span>
<span class="sd">            set is initialized without a Structure but one must be set separately before</span>
<span class="sd">            the inputs are generated.</span>
<span class="sd">        **kwargs: Keywords supported by VaspInputSet.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">_load_yaml_config</span><span class="p">(</span><span class="s2">&quot;MPRelaxSet&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="MPScanRelaxSet">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.MPScanRelaxSet">[docs]</a>
<span class="nd">@due</span><span class="o">.</span><span class="n">dcite</span><span class="p">(</span>
    <span class="n">Doi</span><span class="p">(</span><span class="s2">&quot;10.1021/acs.jpclett.0c02405&quot;</span><span class="p">),</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Accurate and Numerically Efficient r2SCAN Meta-Generalized Gradient Approximation&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@due</span><span class="o">.</span><span class="n">dcite</span><span class="p">(</span>
    <span class="n">Doi</span><span class="p">(</span><span class="s2">&quot;10.1103/PhysRevLett.115.036402&quot;</span><span class="p">),</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Strongly Constrained and Appropriately Normed Semilocal Density Functional&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@due</span><span class="o">.</span><span class="n">dcite</span><span class="p">(</span>
    <span class="n">Doi</span><span class="p">(</span><span class="s2">&quot;10.1103/PhysRevB.93.155109&quot;</span><span class="p">),</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Efficient generation of generalized Monkhorst-Pack grids through the use of informatics&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MPScanRelaxSet</span><span class="p">(</span><span class="n">VaspInputSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write a relaxation input set using the accurate and numerically</span>
<span class="sd">    efficient r2SCAN variant of the Strongly Constrained and Appropriately Normed</span>
<span class="sd">    (SCAN) metaGGA density functional.</span>

<span class="sd">    Notes:</span>
<span class="sd">        1. This functional is officially supported in VASP 6.0.0 and above. On older version,</span>
<span class="sd">        source code may be obtained by contacting the authors of the referenced manuscript.</span>
<span class="sd">        The original SCAN functional, available from VASP 5.4.3 onwards, maybe used instead</span>
<span class="sd">        by passing `user_incar_settings={&quot;METAGGA&quot;: &quot;SCAN&quot;}` when instantiating this InputSet.</span>
<span class="sd">        r2SCAN and SCAN are expected to yield very similar results.</span>

<span class="sd">        2. Meta-GGA calculations require POTCAR files that include</span>
<span class="sd">        information on the kinetic energy density of the core-electrons,</span>
<span class="sd">        i.e. &quot;PBE_52&quot;, &quot;PBE_54&quot; or &quot;PBE_64&quot;. Make sure the POTCARs include the</span>
<span class="sd">        following lines (see VASP wiki for more details):</span>

<span class="sd">            $ grep kinetic POTCAR</span>
<span class="sd">            kinetic energy-density</span>
<span class="sd">            mkinetic energy-density pseudized</span>
<span class="sd">            kinetic energy density (partial)</span>

<span class="sd">    Args:</span>
<span class="sd">        bandgap (float): Bandgap of the structure in eV. The bandgap is used to</span>
<span class="sd">            compute the appropriate k-point density and determine the</span>
<span class="sd">            smearing settings.</span>
<span class="sd">            Metallic systems (default, bandgap = 0) use a KSPACING value of 0.22</span>
<span class="sd">            and Methfessel-Paxton order 2 smearing (ISMEAR=2, SIGMA=0.2).</span>
<span class="sd">            Non-metallic systems (bandgap &gt; 0) use the tetrahedron smearing</span>
<span class="sd">            method (ISMEAR=-5, SIGMA=0.05). The KSPACING value is</span>
<span class="sd">            calculated from the bandgap via Eqs. 25 and 29 of Wisesa, McGill,</span>
<span class="sd">            and Mueller [1] (see References). Note that if &#39;user_incar_settings&#39;</span>
<span class="sd">            or &#39;user_kpoints_settings&#39; override KSPACING, the calculation from</span>
<span class="sd">            bandgap is not performed.</span>
<span class="sd">        vdw (str): set &quot;rVV10&quot; to enable SCAN+rVV10, which is a versatile</span>
<span class="sd">            van der Waals density functional by combing the SCAN functional</span>
<span class="sd">            with the rVV10 non-local correlation functional. rvv10 is the only</span>
<span class="sd">            dispersion correction available for SCAN at this time.</span>
<span class="sd">        **kwargs: Keywords supported by VaspInputSet.</span>

<span class="sd">    References:</span>
<span class="sd">        P. Wisesa, K.A. McGill, T. Mueller, Efficient generation of</span>
<span class="sd">        generalized Monkhorst-Pack grids through the use of informatics,</span>
<span class="sd">        Phys. Rev. B. 93 (2016) 1-10. doi:10.1103/PhysRevB.93.155109.</span>

<span class="sd">        James W. Furness, Aaron D. Kaplan, Jinliang Ning, John P. Perdew, and Jianwei Sun.</span>
<span class="sd">        Accurate and Numerically Efficient r2SCAN Meta-Generalized Gradient Approximation.</span>
<span class="sd">        The Journal of Physical Chemistry Letters 11, 8208-8215 (2022) DOI: 10.1021/acs.jpclett.0c02405</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">bandgap</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">auto_kspacing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">user_potcar_functional</span><span class="p">:</span> <span class="n">UserPotcarFunctional</span> <span class="o">=</span> <span class="s2">&quot;PBE_54&quot;</span>
    <span class="n">auto_ismear</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">_load_yaml_config</span><span class="p">(</span><span class="s2">&quot;MPSCANRelaxSet&quot;</span><span class="p">)</span>
    <span class="n">_valid_potcars</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;PBE_52&quot;</span><span class="p">,</span> <span class="s2">&quot;PBE_54&quot;</span><span class="p">,</span> <span class="s2">&quot;PBE_64&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vdw</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">vdw</span> <span class="o">!=</span> <span class="s2">&quot;rvv10&quot;</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Use of van der waals functionals other than rVV10 with SCAN is not supported at this time. &quot;</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Delete any vdw parameters that may have been added to the INCAR</span>
            <span class="n">vdw_par</span> <span class="o">=</span> <span class="n">loadfn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">MODULE_DIR</span><span class="si">}</span><span class="s2">/vdW_parameters.yaml&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">vdw_par</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vdw</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_config_dict</span><span class="p">[</span><span class="s2">&quot;INCAR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>



<div class="viewcode-block" id="MP24RelaxSet">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.MP24RelaxSet">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MP24RelaxSet</span><span class="p">(</span><span class="n">VaspInputSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Materials Project relax set after a 2023-2024 benchmarking effort.</span>

<span class="sd">    By default, this uses r2SCAN as the xc functional.</span>
<span class="sd">    For discussion around this benchmarking effort, see:</span>
<span class="sd">    https://github.com/materialsproject/foundation/pull/26</span>

<span class="sd">    Citation info:</span>
<span class="sd">    - r2SCAN:</span>
<span class="sd">        James W. Furness, Aaron D. Kaplan, Jinliang Ning, John P. Perdew, and Jianwei Sun.</span>
<span class="sd">        Accurate and Numerically Efficient r2SCAN Meta-Generalized Gradient Approximation.</span>
<span class="sd">        J. Phys. Chem. Lett. 11, 8208-8215 (2022) DOI: 10.1021/acs.jpclett.0c02405</span>
<span class="sd">    - r2SCAN-rVV10:</span>
<span class="sd">        Jinliang Ning, Manish Kothakonda, James W. Furness, Aaron D. Kaplan, Sebastian Ehlert,</span>
<span class="sd">            Jan Gerit Brandenburg, John P. Perdew, and Jianwei Sun.</span>
<span class="sd">        Workhorse minimally empirical dispersion-corrected density functional with tests for</span>
<span class="sd">            weakly bound systems: r2SCAN+rVV10.</span>
<span class="sd">        Phys. Rev. B 106, 075422 (2022) DOI: 10.1103/PhysRevB.106.075422</span>
<span class="sd">    - r2SCAN-D4:</span>
<span class="sd">        Sebastian Ehlert, Uwe Huniar, Jinliang Ning, James W. Furness, Jianwei Sun,</span>
<span class="sd">            Aaron D. Kaplan, John P. Perdew, and Jan Gerit Brandenburg.</span>
<span class="sd">        r2SCAN-D4: Dispersion corrected meta-generalized gradient approximation for general chemical applications.</span>
<span class="sd">        J. Chem. Phys. 154, 061101 (2021) DOI: 10.1063/5.0041008</span>
<span class="sd">    - PBE:</span>
<span class="sd">        John P. Perdew, Kieron Burke, and Matthias Ernzerhof,</span>
<span class="sd">        Generalized Gradient Approximation Made Simple,</span>
<span class="sd">        Phys. Rev. Lett. 77, 3865 (1996) DOI: 10.1103/PhysRevLett.77.3865</span>
<span class="sd">    - PBEsol:</span>
<span class="sd">        John P. Perdew, Adrienn Ruzsinszky, Gábor I. Csonka, Oleg A. Vydrov,</span>
<span class="sd">            Gustavo E. Scuseria, Lucian A. Constantin, Xiaolan Zhou, and Kieron Burke.</span>
<span class="sd">        Restoring the Density-Gradient Expansion for Exchange in Solids and Surfaces.</span>
<span class="sd">        Phys. Rev. Lett. 100, 136406 (2009) DOI: 10.1103/PhysRevLett.100.136406</span>
<span class="sd">    - PBE-D4 and PBEsol-D4:</span>
<span class="sd">        Eike Caldeweyher,Jan-Michael Mewes, Sebastian Ehlert, and Stefan Grimme.</span>
<span class="sd">        Extension and evaluation of the D4 London-dispersion model for periodic systems.</span>
<span class="sd">        Phys. Chem. Chem. Phys. 22, 8499-8512 (2020) DOI: 10.1039/D0CP00502A</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">xc_functional</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;r2SCAN&quot;</span><span class="p">,</span> <span class="s2">&quot;PBE&quot;</span><span class="p">,</span> <span class="s2">&quot;PBEsol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;r2SCAN&quot;</span>
    <span class="n">dispersion</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;rVV10&quot;</span><span class="p">,</span> <span class="s2">&quot;D4&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">_load_yaml_config</span><span class="p">(</span><span class="s2">&quot;MP24RelaxSet&quot;</span><span class="p">)</span>
    <span class="n">auto_ismear</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">auto_kspacing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">inherit_incar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>

        <span class="n">to_func</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;r2SCAN&quot;</span><span class="p">:</span> <span class="s2">&quot;R2SCAN&quot;</span><span class="p">,</span>
            <span class="s2">&quot;PBE&quot;</span><span class="p">:</span> <span class="s2">&quot;PE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;PBEsol&quot;</span><span class="p">:</span> <span class="s2">&quot;PS&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">config_updates</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xc_functional</span> <span class="o">==</span> <span class="s2">&quot;r2SCAN&quot;</span><span class="p">:</span>
            <span class="n">config_updates</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;METAGGA&quot;</span><span class="p">:</span> <span class="n">to_func</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">xc_functional</span><span class="p">]}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config_dict</span><span class="p">[</span><span class="s2">&quot;INCAR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;GGA&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">xc_functional</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;PBE&quot;</span><span class="p">,</span> <span class="s2">&quot;PBEsol&quot;</span><span class="p">]:</span>
            <span class="n">config_updates</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;GGA&quot;</span><span class="p">:</span> <span class="n">to_func</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">xc_functional</span><span class="p">]}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config_dict</span><span class="p">[</span><span class="s2">&quot;INCAR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;METAGGA&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown XC functional </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">xc_functional</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersion</span> <span class="o">==</span> <span class="s2">&quot;rVV10&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xc_functional</span> <span class="o">==</span> <span class="s2">&quot;r2SCAN&quot;</span><span class="p">:</span>
                <span class="n">config_updates</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;BPARAM&quot;</span><span class="p">:</span> <span class="mf">11.95</span><span class="p">,</span> <span class="s2">&quot;CPARAM&quot;</span><span class="p">:</span> <span class="mf">0.0093</span><span class="p">,</span> <span class="s2">&quot;LUSE_VDW&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Use of rVV10 with functionals other than r2 / SCAN is not currently supported in VASP.&quot;</span>
                <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersion</span> <span class="o">==</span> <span class="s2">&quot;D4&quot;</span><span class="p">:</span>
            <span class="n">d4_pars</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;r2SCAN&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;S6&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                    <span class="s2">&quot;S8&quot;</span><span class="p">:</span> <span class="mf">0.60187490</span><span class="p">,</span>
                    <span class="s2">&quot;A1&quot;</span><span class="p">:</span> <span class="mf">0.51559235</span><span class="p">,</span>
                    <span class="s2">&quot;A2&quot;</span><span class="p">:</span> <span class="mf">5.77342911</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s2">&quot;PBE&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;S6&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                    <span class="s2">&quot;S8&quot;</span><span class="p">:</span> <span class="mf">0.95948085</span><span class="p">,</span>
                    <span class="s2">&quot;A1&quot;</span><span class="p">:</span> <span class="mf">0.38574991</span><span class="p">,</span>
                    <span class="s2">&quot;A2&quot;</span><span class="p">:</span> <span class="mf">4.80688534</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s2">&quot;PBEsol&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;S6&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                    <span class="s2">&quot;S8&quot;</span><span class="p">:</span> <span class="mf">1.71885698</span><span class="p">,</span>
                    <span class="s2">&quot;A1&quot;</span><span class="p">:</span> <span class="mf">0.47901421</span><span class="p">,</span>
                    <span class="s2">&quot;A2&quot;</span><span class="p">:</span> <span class="mf">5.96771589</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">}</span>
            <span class="n">config_updates</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;IVDW&quot;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="sa">f</span><span class="s2">&quot;VDW_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d4_pars</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">xc_functional</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}}</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">config_updates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config_dict</span><span class="p">[</span><span class="s2">&quot;INCAR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">config_updates</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_sigmoid_interp</span><span class="p">(</span>
        <span class="n">bg</span><span class="p">,</span> <span class="n">min_dk</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.22</span><span class="p">,</span> <span class="n">max_dk</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.43</span><span class="p">,</span> <span class="n">center</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">4.15</span><span class="p">,</span> <span class="n">fac</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">12.0</span>
    <span class="p">):</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">shape</span> <span class="o">*</span> <span class="p">(</span><span class="n">bg</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span>
        <span class="n">sigmoid</span> <span class="o">=</span> <span class="n">delta</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">delta</span><span class="o">**</span><span class="n">fac</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">fac</span><span class="p">)</span>
        <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">min_dk</span> <span class="o">+</span> <span class="n">max_dk</span> <span class="o">+</span> <span class="p">(</span><span class="n">max_dk</span> <span class="o">-</span> <span class="n">min_dk</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigmoid</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_multi_sigmoid_interp</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">bandgap</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">dks</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.22</span><span class="p">,</span> <span class="mf">0.44</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
        <span class="n">shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span>
        <span class="n">center</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.35</span><span class="p">,</span> <span class="mf">6.1</span><span class="p">),</span>
        <span class="n">fac</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
        <span class="n">bg_cut</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4.5</span><span class="p">,),</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">bandgap</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandgap_tol</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">min_bds</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bandgap_tol</span><span class="p">,</span> <span class="o">*</span><span class="n">bg_cut</span><span class="p">]</span>
        <span class="n">max_bds</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">bg_cut</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">icut</span><span class="p">,</span> <span class="n">min_bd</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">min_bds</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">min_bd</span> <span class="o">&lt;=</span> <span class="n">bandgap</span> <span class="o">&lt;</span> <span class="n">max_bds</span><span class="p">[</span><span class="n">icut</span><span class="p">]:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sigmoid_interp</span><span class="p">(</span>
                    <span class="n">bandgap</span><span class="p">,</span>
                    <span class="n">min_dk</span><span class="o">=</span><span class="n">dks</span><span class="p">[</span><span class="n">icut</span><span class="p">],</span>
                    <span class="n">max_dk</span><span class="o">=</span><span class="n">dks</span><span class="p">[</span><span class="n">icut</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                    <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">[</span><span class="n">icut</span><span class="p">],</span>
                    <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">[</span><span class="n">icut</span><span class="p">],</span>
                    <span class="n">fac</span><span class="o">=</span><span class="n">fac</span><span class="p">[</span><span class="n">icut</span><span class="p">],</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">kspacing_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandgap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.22</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_multi_sigmoid_interp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bandgap</span><span class="p">)</span></div>



<div class="viewcode-block" id="MPMetalRelaxSet">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.MPMetalRelaxSet">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MPMetalRelaxSet</span><span class="p">(</span><span class="n">VaspInputSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implementation of VaspInputSet utilizing parameters in the public</span>
<span class="sd">    Materials Project, but with tuning for metals. Key things are a denser</span>
<span class="sd">    k point density, and a.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">MPRelaxSet</span><span class="o">.</span><span class="n">CONFIG</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">incar_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the INCAR config for this calculation type.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ISMEAR&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;SIGMA&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">kpoints_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the kpoints configuration for this calculation type.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;reciprocal_density&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">}</span></div>



<div class="viewcode-block" id="MPHSERelaxSet">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.MPHSERelaxSet">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MPHSERelaxSet</span><span class="p">(</span><span class="n">VaspInputSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Same as the MPRelaxSet, but with HSE parameters and vdW corrections.&quot;&quot;&quot;</span>

    <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">_load_yaml_config</span><span class="p">(</span><span class="s2">&quot;MPHSERelaxSet&quot;</span><span class="p">)</span>
    <span class="n">vdw</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;dftd3&quot;</span><span class="p">,</span> <span class="s2">&quot;dftd3-bj&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config_dict</span><span class="p">[</span><span class="s2">&quot;INCAR&quot;</span><span class="p">][</span><span class="s2">&quot;LASPH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">incar_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the INCAR config for this calculation type.&quot;&quot;&quot;</span>
        <span class="n">updates</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vdw</span><span class="p">:</span>
            <span class="n">hse_vdw_par</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;dftd3&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;VDW_SR&quot;</span><span class="p">:</span> <span class="mf">1.129</span><span class="p">,</span> <span class="s2">&quot;VDW_S8&quot;</span><span class="p">:</span> <span class="mf">0.109</span><span class="p">},</span>
                <span class="s2">&quot;dftd3-bj&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;VDW_A1&quot;</span><span class="p">:</span> <span class="mf">0.383</span><span class="p">,</span> <span class="s2">&quot;VDW_S8&quot;</span><span class="p">:</span> <span class="mf">2.310</span><span class="p">,</span> <span class="s2">&quot;VDW_A2&quot;</span><span class="p">:</span> <span class="mf">5.685</span><span class="p">},</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">vdw_param</span> <span class="o">:=</span> <span class="n">hse_vdw_par</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vdw</span><span class="p">):</span>
                <span class="n">updates</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">vdw_param</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">updates</span></div>



<div class="viewcode-block" id="MPStaticSet">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.MPStaticSet">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MPStaticSet</span><span class="p">(</span><span class="n">VaspInputSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create input files for a static calculation.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure (Structure): Structure from previous run.</span>
<span class="sd">        lepsilon (bool): Whether to add static dielectric calculation</span>
<span class="sd">        lcalcpol (bool): Whether to turn on evaluation of the Berry phase approximations</span>
<span class="sd">            for electronic polarization</span>
<span class="sd">        reciprocal_density (int): For static calculations, we usually set the</span>
<span class="sd">            reciprocal density by volume. This is a convenience arg to change</span>
<span class="sd">            that, rather than using user_kpoints_settings. Defaults to 100,</span>
<span class="sd">            which is ~50% more than that of standard relaxation calculations.</span>
<span class="sd">        small_gap_multiply ([float, float]): If the gap is less than</span>
<span class="sd">            1st index, multiply the default reciprocal_density by the 2nd</span>
<span class="sd">            index.</span>
<span class="sd">        **kwargs: Keywords supported by MPRelaxSet.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lepsilon</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">lcalcpol</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">reciprocal_density</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">small_gap_multiply</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">inherit_incar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">MPRelaxSet</span><span class="o">.</span><span class="n">CONFIG</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">incar_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the INCAR config for this calculation type.&quot;&quot;&quot;</span>
        <span class="n">updates</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;NSW&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;ISMEAR&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span>
            <span class="s2">&quot;LCHARG&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;LORBIT&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
            <span class="s2">&quot;LREAL&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lepsilon</span><span class="p">:</span>
            <span class="c1"># LPEAD=T: numerical evaluation of overlap integral prevents LRF_COMMUTATOR</span>
            <span class="c1"># errors and can lead to better expt. agreement but produces slightly</span>
            <span class="c1"># different results</span>
            <span class="n">updates</span> <span class="o">|=</span> <span class="p">{</span>
                <span class="s2">&quot;IBRION&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
                <span class="s2">&quot;LEPSILON&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;LPEAD&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;NSW&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;EDIFF&quot;</span><span class="p">:</span> <span class="mf">1e-5</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcalcpol</span><span class="p">:</span>
            <span class="n">updates</span><span class="p">[</span><span class="s2">&quot;LCALCPOL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">updates</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">kpoints_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span> <span class="o">|</span> <span class="n">Kpoints</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the kpoints configuration for this calculation type.&quot;&quot;&quot;</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandgap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">small_gap_multiply</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandgap</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">small_gap_multiply</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">small_gap_multiply</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># prefer to use k-point scheme from previous run unless lepsilon = True is specified</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prev_kpoints</span>
            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_kpoints</span><span class="p">,</span> <span class="n">Kpoints</span><span class="p">)</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_kpoints</span><span class="o">.</span><span class="n">style</span> <span class="o">==</span> <span class="n">Kpoints</span><span class="o">.</span><span class="n">supported_modes</span><span class="o">.</span><span class="n">Monkhorst</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lepsilon</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="n">kpoints</span> <span class="o">=</span> <span class="n">Kpoints</span><span class="o">.</span><span class="n">automatic_density_by_vol</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span>
                <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reciprocal_density</span> <span class="o">*</span> <span class="n">factor</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">force_gamma</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">k_div</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Kpoint</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">kp</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">kp</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">kp</span> <span class="k">for</span> <span class="n">kp</span> <span class="ow">in</span> <span class="n">kpoints</span><span class="o">.</span><span class="n">kpts</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">Kpoints</span><span class="o">.</span><span class="n">monkhorst_automatic</span><span class="p">(</span><span class="n">k_div</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;reciprocal_density&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reciprocal_density</span> <span class="o">*</span> <span class="n">factor</span><span class="p">}</span></div>



<div class="viewcode-block" id="MatPESStaticSet">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.MatPESStaticSet">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MatPESStaticSet</span><span class="p">(</span><span class="n">VaspInputSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create input files for a MatPES static calculation.</span>

<span class="sd">    The goal of MatPES is to generate potential energy surface data. This is a distinctly different</span>
<span class="sd">    from the objectives of the MP static calculations, which aims to obtain primarily accurate</span>
<span class="sd">    energies and also electronic structure (DOS). For PES data, force accuracy (and to some extent,</span>
<span class="sd">    stress accuracy) is of paramount importance.</span>

<span class="sd">    The default POTCAR versions have been updated to PBE_54 from the old PBE set used in the</span>
<span class="sd">    MPStaticSet. However, **U values** are still based on PBE. The implicit assumption here is that</span>
<span class="sd">    the PBE_54 and PBE POTCARs are sufficiently similar that the U values fitted to the old PBE</span>
<span class="sd">    functional still applies.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure (Structure): The Structure to create inputs for. If None, the input</span>
<span class="sd">            set is initialized without a Structure but one must be set separately before</span>
<span class="sd">            the inputs are generated.</span>
<span class="sd">        xc_functional (&#39;R2SCAN&#39;|&#39;PBE&#39;): Exchange-correlation functional to use. Defaults to &#39;PBE&#39;.</span>
<span class="sd">        **kwargs: Keywords supported by VaspInputSet.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">xc_functional</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;R2SCAN&quot;</span><span class="p">,</span> <span class="s2">&quot;PBE&quot;</span><span class="p">,</span> <span class="s2">&quot;PBE+U&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PBE&quot;</span>
    <span class="n">prev_incar</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># These are parameters that we will inherit from any previous INCAR supplied. They are mostly parameters related</span>
    <span class="c1"># to symmetry and convergence set by Custodian when errors are encountered in a previous run. Given that our goal</span>
    <span class="c1"># is to have a strictly homogeneous PES data, all other parameters (e.g., ISMEAR, ALGO, etc.) are not inherited.</span>
    <span class="n">inherit_incar</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">|</span> <span class="nb">bool</span> <span class="o">=</span> <span class="p">(</span>  <span class="c1"># type: ignore[assignment]</span>
        <span class="s2">&quot;LPEAD&quot;</span><span class="p">,</span>
        <span class="s2">&quot;NGX&quot;</span><span class="p">,</span>
        <span class="s2">&quot;NGY&quot;</span><span class="p">,</span>
        <span class="s2">&quot;NGZ&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SYMPREC&quot;</span><span class="p">,</span>
        <span class="s2">&quot;IMIX&quot;</span><span class="p">,</span>
        <span class="s2">&quot;LMAXMIX&quot;</span><span class="p">,</span>
        <span class="s2">&quot;KGAMMA&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ISYM&quot;</span><span class="p">,</span>
        <span class="s2">&quot;NCORE&quot;</span><span class="p">,</span>
        <span class="s2">&quot;NPAR&quot;</span><span class="p">,</span>
        <span class="s2">&quot;NELMIN&quot;</span><span class="p">,</span>
        <span class="s2">&quot;IOPT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;NBANDS&quot;</span><span class="p">,</span>
        <span class="s2">&quot;KPAR&quot;</span><span class="p">,</span>
        <span class="s2">&quot;AMIN&quot;</span><span class="p">,</span>
        <span class="s2">&quot;NELMDL&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BMIX&quot;</span><span class="p">,</span>
        <span class="s2">&quot;AMIX_MAG&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BMIX_MAG&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">_load_yaml_config</span><span class="p">(</span><span class="s2">&quot;MatPESStaticSet&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate inputs.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>
        <span class="n">valid_xc_functionals</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;R2SCAN&quot;</span><span class="p">,</span> <span class="s2">&quot;PBE&quot;</span><span class="p">,</span> <span class="s2">&quot;PBE+U&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xc_functional</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_xc_functionals</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unrecognized xc_functional=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">xc_functional</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Supported exchange-correlation functionals are </span><span class="si">{</span><span class="n">valid_xc_functionals</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">default_potcars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;PARENT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;PBE&quot;</span><span class="p">,</span> <span class="s2">&quot;PBE_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Base&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># PBE64Base -&gt; PBE_64</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_potcar_functional</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_potcar_functional</span> <span class="ow">or</span> <span class="n">default_potcars</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_potcar_functional</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="n">default_potcars</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user_potcar_functional</span><span class="si">=}</span><span class="s2"> is inconsistent with the recommended </span><span class="si">{</span><span class="n">default_potcars</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xc_functional</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;R2SCAN&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config_dict</span><span class="p">[</span><span class="s2">&quot;INCAR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;METAGGA&quot;</span><span class="p">:</span> <span class="s2">&quot;R2SCAN&quot;</span><span class="p">,</span> <span class="s2">&quot;ALGO&quot;</span><span class="p">:</span> <span class="s2">&quot;ALL&quot;</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config_dict</span><span class="p">[</span><span class="s2">&quot;INCAR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;GGA&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xc_functional</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;+U&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config_dict</span><span class="p">[</span><span class="s2">&quot;INCAR&quot;</span><span class="p">][</span><span class="s2">&quot;LDAU&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="MPScanStaticSet">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.MPScanStaticSet">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MPScanStaticSet</span><span class="p">(</span><span class="n">MPScanRelaxSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create input files for a static calculation using the accurate and numerically</span>
<span class="sd">    efficient r2SCAN variant of the Strongly Constrained and Appropriately Normed</span>
<span class="sd">    (SCAN) metaGGA functional.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure (Structure): Structure from previous run.</span>
<span class="sd">        bandgap (float): Bandgap of the structure in eV. The bandgap is used to</span>
<span class="sd">            compute the appropriate k-point density and determine the smearing settings.</span>
<span class="sd">        lepsilon (bool): Whether to add static dielectric calculation</span>
<span class="sd">        lcalcpol (bool): Whether to turn on evaluation of the Berry phase approximations</span>
<span class="sd">            for electronic polarization.</span>
<span class="sd">        **kwargs: Keywords supported by MPScanRelaxSet.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lepsilon</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">lcalcpol</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">inherit_incar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">auto_kspacing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">incar_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the INCAR config for this calculation type.&quot;&quot;&quot;</span>
        <span class="n">updates</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;ALGO&quot;</span><span class="p">:</span> <span class="s2">&quot;Fast&quot;</span><span class="p">,</span>
            <span class="s2">&quot;LREAL&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;NSW&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;LORBIT&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
            <span class="s2">&quot;LVHAR&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;ISMEAR&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lepsilon</span><span class="p">:</span>
            <span class="c1"># LPEAD=T: numerical evaluation of overlap integral prevents</span>
            <span class="c1"># LRF_COMMUTATOR errors and can lead to better expt. agreement</span>
            <span class="c1"># but produces slightly different results</span>
            <span class="n">updates</span> <span class="o">|=</span> <span class="p">{</span>
                <span class="s2">&quot;IBRION&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
                <span class="s2">&quot;LEPSILON&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;LPEAD&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;NSW&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;NPAR&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcalcpol</span><span class="p">:</span>
            <span class="n">updates</span><span class="p">[</span><span class="s2">&quot;LCALCPOL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">updates</span></div>



<div class="viewcode-block" id="MP24StaticSet">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.MP24StaticSet">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MP24StaticSet</span><span class="p">(</span><span class="n">MP24RelaxSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create input files for a static calculation using MP24 parameters.</span>

<span class="sd">    For class information, refer to `MP24RelaxSet`.</span>
<span class="sd">    If you use this set, please consider citing the appropriate papers in `MP24RelaxSet`.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure (Structure): Structure from previous run.</span>
<span class="sd">        bandgap (float): Bandgap of the structure in eV. The bandgap is used to</span>
<span class="sd">            compute the appropriate k-point density and determine the smearing settings.</span>
<span class="sd">        lepsilon (bool): Whether to add static dielectric calculation</span>
<span class="sd">        lcalcpol (bool): Whether to turn on evaluation of the Berry phase approximations</span>
<span class="sd">            for electronic polarization.</span>
<span class="sd">        **kwargs: Keywords supported by MP24RelaxSet.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lepsilon</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">lcalcpol</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">inherit_incar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">auto_kspacing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">incar_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the INCAR config for this calculation type.&quot;&quot;&quot;</span>
        <span class="n">updates</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;NSW&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;LORBIT&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
            <span class="s2">&quot;ISMEAR&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lepsilon</span><span class="p">:</span>
            <span class="c1"># LPEAD=T: numerical evaluation of overlap integral prevents</span>
            <span class="c1"># LRF_COMMUTATOR errors and can lead to better expt. agreement</span>
            <span class="c1"># but produces slightly different results</span>
            <span class="n">updates</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;IBRION&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;LEPSILON&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;LPEAD&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;NSW&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;NPAR&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcalcpol</span><span class="p">:</span>
            <span class="n">updates</span><span class="p">[</span><span class="s2">&quot;LCALCPOL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">updates</span></div>



<div class="viewcode-block" id="MPHSEBSSet">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.MPHSEBSSet">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MPHSEBSSet</span><span class="p">(</span><span class="n">VaspInputSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Implementation of a VaspInputSet for HSE band structure computations.</span>

<span class="sd">    Remember that HSE band structures must be self-consistent in VASP. A band structure</span>
<span class="sd">    along symmetry lines for instance needs BOTH a uniform grid with appropriate weights</span>
<span class="sd">    AND a path along the lines with weight 0.</span>

<span class="sd">    Thus, the &quot;uniform&quot; mode is just like regular static SCF but allows adding custom</span>
<span class="sd">    kpoints (e.g., corresponding to known VBM/CBM) to the uniform grid that have zero</span>
<span class="sd">    weight (e.g., for better gap estimate).</span>

<span class="sd">    The &quot;gap&quot; mode behaves just like the &quot;uniform&quot; mode, however, if starting from a</span>
<span class="sd">    previous calculation, the VBM and CBM k-points will automatically be added to</span>
<span class="sd">    ``added_kpoints``.</span>

<span class="sd">    The &quot;line&quot; mode is just like &quot;uniform&quot; mode, but additionally adds k-points along</span>
<span class="sd">    symmetry lines with zero weight.</span>

<span class="sd">    The &quot;uniform_dense&quot; mode is like &quot;uniform&quot; mode but additionally adds a denser</span>
<span class="sd">    uniform mesh with zero weight. This can be useful when calculating Fermi surfaces</span>
<span class="sd">    or BoltzTraP/AMSET electronic transport using hybrid DFT.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure (Structure): Structure to compute</span>
<span class="sd">        added_kpoints (list): a list of kpoints (list of 3 number list) added to the</span>
<span class="sd">            run. The k-points are in fractional coordinates</span>
<span class="sd">        mode (str): &quot;Line&quot; - generate k-points along symmetry lines for bandstructure.</span>
<span class="sd">            &quot;Uniform&quot; - generate uniform k-points grid.</span>
<span class="sd">        reciprocal_density (int): k-point density to use for uniform mesh.</span>
<span class="sd">        copy_chgcar (bool): Whether to copy the CHGCAR of a previous run.</span>
<span class="sd">        kpoints_line_density (int): k-point density for high symmetry lines</span>
<span class="sd">        dedos (float): Energy difference used to set NEDOS, based on the total energy</span>
<span class="sd">            range.</span>
<span class="sd">        optics (bool): Whether to add LOPTICS (used for calculating optical response).</span>
<span class="sd">        nbands_factor (float): Multiplicative factor for NBANDS when starting from a</span>
<span class="sd">            previous calculation. Choose a higher number if you are doing an LOPTICS</span>
<span class="sd">            calculation.</span>
<span class="sd">        **kwargs: Keywords supported by VaspInputSet.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">added_kpoints</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Vector3D</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gap&quot;</span>
    <span class="n">reciprocal_density</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">copy_chgcar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">kpoints_line_density</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">nbands_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.2</span>
    <span class="n">zero_weighted_reciprocal_density</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">dedos</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span>
    <span class="n">optics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">MPHSERelaxSet</span><span class="o">.</span><span class="n">CONFIG</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure mode is set correctly.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;reciprocal_density&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_kpoints_settings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reciprocal_density</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_kpoints_settings</span><span class="p">[</span><span class="s2">&quot;reciprocal_density&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">supported_modes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;line&quot;</span><span class="p">,</span> <span class="s2">&quot;uniform&quot;</span><span class="p">,</span> <span class="s2">&quot;gap&quot;</span><span class="p">,</span> <span class="s2">&quot;uniform_dense&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">supported_modes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Supported modes are: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">supported_modes</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">kpoints_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the kpoints configuration for this calculation type.&quot;&quot;&quot;</span>
        <span class="n">kpoints</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;reciprocal_density&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reciprocal_density</span><span class="p">,</span>
            <span class="s2">&quot;explicit&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;line&quot;</span><span class="p">:</span>
            <span class="c1"># add line_density on top of reciprocal density</span>
            <span class="n">kpoints</span><span class="p">[</span><span class="s2">&quot;zero_weighted_line_density&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints_line_density</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;uniform_dense&quot;</span><span class="p">:</span>
            <span class="n">kpoints</span><span class="p">[</span><span class="s2">&quot;zero_weighted_reciprocal_density&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_weighted_reciprocal_density</span>

        <span class="n">added_kpoints</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">added_kpoints</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_vasprun</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;gap&quot;</span><span class="p">:</span>
            <span class="n">bs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_vasprun</span><span class="o">.</span><span class="n">get_band_structure</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">bs</span><span class="o">.</span><span class="n">is_metal</span><span class="p">():</span>
                <span class="n">added_kpoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bs</span><span class="o">.</span><span class="n">get_vbm</span><span class="p">()[</span><span class="s2">&quot;kpoint&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">)</span>
                <span class="n">added_kpoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bs</span><span class="o">.</span><span class="n">get_cbm</span><span class="p">()[</span><span class="s2">&quot;kpoint&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">)</span>

        <span class="n">kpoints</span><span class="p">[</span><span class="s2">&quot;added_kpoints&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">added_kpoints</span>

        <span class="k">return</span> <span class="n">kpoints</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">incar_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the INCAR config for this calculation type.&quot;&quot;&quot;</span>
        <span class="n">updates</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">NSW</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ISMEAR</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">SIGMA</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">ISYM</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">LCHARG</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">NELMIN</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;uniform&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">added_kpoints</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Automatic setting of nedos using the energy range and the energy step</span>
            <span class="n">nedos</span> <span class="o">=</span> <span class="n">_get_nedos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_vasprun</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dedos</span><span class="p">)</span>

            <span class="c1"># Use tetrahedron method for DOS and optics calculations</span>
            <span class="n">updates</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;ISMEAR&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;NEDOS&quot;</span><span class="p">:</span> <span class="n">nedos</span><span class="p">}</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If line mode or explicit k-points (gap) can&#39;t use ISMEAR=-5</span>
            <span class="c1"># Use small sigma to avoid partial occupancies for small band gap materials</span>
            <span class="n">updates</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;ISMEAR&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;SIGMA&quot;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_vasprun</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Set NBANDS</span>
            <span class="n">nbands</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_vasprun</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;NBANDS&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbands_factor</span><span class="p">))</span>
            <span class="n">updates</span><span class="p">[</span><span class="s2">&quot;NBANDS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nbands</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optics</span><span class="p">:</span>
            <span class="c1"># LREAL not supported with LOPTICS</span>
            <span class="n">updates</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;LOPTICS&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;LREAL&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;CSHIFT&quot;</span><span class="p">:</span> <span class="mf">1e-5</span><span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_vasprun</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_outcar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Turn off spin when magmom for every site is smaller than 0.02.</span>
            <span class="n">updates</span><span class="p">[</span><span class="s2">&quot;ISPIN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_ispin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_vasprun</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_outcar</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">updates</span></div>



<div class="viewcode-block" id="MPNonSCFSet">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.MPNonSCFSet">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MPNonSCFSet</span><span class="p">(</span><span class="n">VaspInputSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Init a MPNonSCFSet. Typically, you would use the classmethod</span>
<span class="sd">    from_prev_calc to initialize from a previous SCF run.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure (Structure): Structure to compute</span>
<span class="sd">        mode (str): Line, Uniform or Boltztrap mode supported.</span>
<span class="sd">        nedos (int): nedos parameter. Default to 2001.</span>
<span class="sd">        dedos (float): setting nedos=0 and uniform mode in from_prev_calc,</span>
<span class="sd">            an automatic nedos will be calculated using the total energy range</span>
<span class="sd">            divided by the energy step dedos</span>
<span class="sd">        reciprocal_density (int): density of k-mesh by reciprocal</span>
<span class="sd">            volume (defaults to 100)</span>
<span class="sd">        kpoints_line_density (int): Line density for Line mode.</span>
<span class="sd">        optics (bool): whether to add dielectric function</span>
<span class="sd">        copy_chgcar: Whether to copy the old CHGCAR when starting from a</span>
<span class="sd">            previous calculation.</span>
<span class="sd">        nbands_factor (float): Multiplicative factor for NBANDS when starting</span>
<span class="sd">            from a previous calculation. Choose a higher number if you are</span>
<span class="sd">            doing an LOPTICS calculation.</span>
<span class="sd">        small_gap_multiply ([float, float]): When starting from a previous</span>
<span class="sd">            calculation, if the gap is less than 1st index, multiply the default</span>
<span class="sd">            reciprocal_density by the 2nd index.</span>
<span class="sd">        **kwargs: Keywords supported by MPRelaxSet.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;line&quot;</span>
    <span class="n">nedos</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2001</span>
    <span class="n">dedos</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.005</span>
    <span class="n">reciprocal_density</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">kpoints_line_density</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">optics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">copy_chgcar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">nbands_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.2</span>
    <span class="n">small_gap_multiply</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">inherit_incar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">MPRelaxSet</span><span class="o">.</span><span class="n">CONFIG</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform inputset validation.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>

        <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="n">valid_modes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;line&quot;</span><span class="p">,</span> <span class="s2">&quot;uniform&quot;</span><span class="p">,</span> <span class="s2">&quot;boltztrap&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_modes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid </span><span class="si">{</span><span class="n">mode</span><span class="si">=}</span><span class="s2">. Supported modes for NonSCF runs are </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">repr</span><span class="p">,</span><span class="w"> </span><span class="n">valid_modes</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="s2">&quot;uniform&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">nedos</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">optics</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;It is recommended to use Uniform mode with a high NEDOS for optics calculations.&quot;</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standardize</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Use of standardize=True with from_prev_run is not &quot;</span>
                <span class="s2">&quot;recommended as there is no guarantee the copied &quot;</span>
                <span class="s2">&quot;files will be appropriate for the standardized&quot;</span>
                <span class="s2">&quot; structure. copy_chgcar is enforced to be false.&quot;</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copy_chgcar</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">incar_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the INCAR config for this calculation type.&quot;&quot;&quot;</span>
        <span class="n">updates</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;LCHARG&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;LORBIT&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
            <span class="s2">&quot;LWAVE&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;NSW&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;ISYM&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;ICHARG&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_vasprun</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Set NBANDS</span>
            <span class="n">n_bands</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_vasprun</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;NBANDS&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbands_factor</span><span class="p">))</span>
            <span class="n">updates</span><span class="p">[</span><span class="s2">&quot;NBANDS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_bands</span>

        <span class="c1"># Automatic setting of NEDOS using the energy range and the energy step</span>
        <span class="n">nedos</span> <span class="o">=</span> <span class="n">_get_nedos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_vasprun</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dedos</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nedos</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">nedos</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;uniform&quot;</span><span class="p">:</span>
            <span class="c1"># Use tetrahedron method for DOS and optics calculations</span>
            <span class="n">updates</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;ISMEAR&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;ISYM&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;NEDOS&quot;</span><span class="p">:</span> <span class="n">nedos</span><span class="p">}</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;line&quot;</span><span class="p">,</span> <span class="s2">&quot;boltztrap&quot;</span><span class="p">}:</span>
            <span class="c1"># If line mode or explicit k-points (boltztrap) can&#39;t use ISMEAR=-5</span>
            <span class="c1"># Use small sigma to avoid partial occupancies for small band gap materials</span>
            <span class="c1"># Use a larger sigma if the material is a metal</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandgap</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandgap</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.01</span>
            <span class="n">updates</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;ISMEAR&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;SIGMA&quot;</span><span class="p">:</span> <span class="n">sigma</span><span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optics</span><span class="p">:</span>
            <span class="c1"># LREAL not supported with LOPTICS = True; automatic NEDOS usually</span>
            <span class="c1"># underestimates, so set it explicitly</span>
            <span class="n">updates</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;LOPTICS&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;LREAL&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;CSHIFT&quot;</span><span class="p">:</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="s2">&quot;NEDOS&quot;</span><span class="p">:</span> <span class="n">nedos</span><span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_vasprun</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_outcar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Turn off spin when magmom for every site is smaller than 0.02.</span>
            <span class="n">updates</span><span class="p">[</span><span class="s2">&quot;ISPIN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_ispin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_vasprun</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_outcar</span><span class="p">)</span>

        <span class="n">updates</span><span class="p">[</span><span class="s2">&quot;MAGMOM&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">updates</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">kpoints_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the KPOINTS configuration for this calculation type.&quot;&quot;&quot;</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandgap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">small_gap_multiply</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandgap</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">small_gap_multiply</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">small_gap_multiply</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;line&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;line_density&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints_line_density</span> <span class="o">*</span> <span class="n">factor</span><span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;boltztrap&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;explicit&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;reciprocal_density&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reciprocal_density</span> <span class="o">*</span> <span class="n">factor</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;reciprocal_density&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reciprocal_density</span> <span class="o">*</span> <span class="n">factor</span><span class="p">}</span></div>



<div class="viewcode-block" id="MPSOCSet">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.MPSOCSet">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MPSOCSet</span><span class="p">(</span><span class="n">VaspInputSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An input set for running spin-orbit coupling (SOC) calculations.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure (Structure): the structure must have the &#39;magmom&#39; site</span>
<span class="sd">            property and each magnetic moment value must have 3</span>
<span class="sd">            components. eg: ``magmom = [[0,0,2], ...]``</span>
<span class="sd">        saxis (tuple): magnetic moment orientation</span>
<span class="sd">        copy_chgcar: Whether to copy the old CHGCAR. Defaults to True.</span>
<span class="sd">        nbands_factor (float): Multiplicative factor for NBANDS. Choose a</span>
<span class="sd">            higher number if you are doing an LOPTICS calculation.</span>
<span class="sd">        reciprocal_density (int): density of k-mesh by reciprocal volume.</span>
<span class="sd">        small_gap_multiply ([float, float]): If the gap is less than</span>
<span class="sd">            1st index, multiply the default reciprocal_density by the 2nd</span>
<span class="sd">            index.</span>
<span class="sd">        lepsilon (bool): Whether to add static dielectric calculation</span>
<span class="sd">        lcalcpol (bool): Whether to turn on evaluation of the Berry phase approximations</span>
<span class="sd">            for electronic polarization</span>
<span class="sd">        magmom (list[list[float]]): Override for the structure magmoms.</span>
<span class="sd">        **kwargs: Keywords supported by VaspInputSet.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">saxis</span><span class="p">:</span> <span class="n">Tuple3Ints</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">nbands_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.2</span>
    <span class="n">lepsilon</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">lcalcpol</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">reciprocal_density</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">small_gap_multiply</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">magmom</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Vector3D</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">inherit_incar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">copy_chgcar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">MPRelaxSet</span><span class="o">.</span><span class="n">CONFIG</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">structure</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;magmom&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">magmom</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The structure must have the &#39;magmom&#39; site property and each magnetic &quot;</span>
                <span class="s2">&quot;moment value must have 3 components. e.g. magmom = [0,0,2]&quot;</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">incar_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the INCAR config for this calculation type.&quot;&quot;&quot;</span>
        <span class="n">updates</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;ISYM&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;LSORBIT&quot;</span><span class="p">:</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ICHARG&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
            <span class="s2">&quot;SAXIS&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saxis</span><span class="p">),</span>
            <span class="s2">&quot;NSW&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;ISMEAR&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span>
            <span class="s2">&quot;LCHARG&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;LORBIT&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
            <span class="s2">&quot;LREAL&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lepsilon</span><span class="p">:</span>
            <span class="c1"># LPEAD=T: numerical evaluation of overlap integral prevents LRF_COMMUTATOR</span>
            <span class="c1"># errors and can lead to better expt. agreement but produces slightly</span>
            <span class="c1"># different results</span>
            <span class="n">updates</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;IBRION&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;LEPSILON&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;LPEAD&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;NSW&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcalcpol</span><span class="p">:</span>
            <span class="n">updates</span><span class="p">[</span><span class="s2">&quot;LCALCPOL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_vasprun</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Set NBANDS</span>
            <span class="n">n_bands</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_vasprun</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;NBANDS&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbands_factor</span><span class="p">))</span>
            <span class="n">updates</span><span class="p">[</span><span class="s2">&quot;NBANDS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_bands</span>
        <span class="k">return</span> <span class="n">updates</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">kpoints_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the kpoints configuration for this calculation type.&quot;&quot;&quot;</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandgap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">small_gap_multiply</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandgap</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">small_gap_multiply</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">small_gap_multiply</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;reciprocal_density&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reciprocal_density</span> <span class="o">*</span> <span class="n">factor</span><span class="p">}</span>

    <span class="nd">@VaspInputSet</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">setter</span>  <span class="c1"># type: ignore[misc, union-attr]</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">structure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">magmom</span><span class="p">:</span>
                <span class="n">structure</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">site_properties</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;magmom&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">magmom</span><span class="p">})</span>

            <span class="c1"># MAGMOM has to be 3D for SOC calculation</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">structure</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;magmom&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Neither the previous structure has magmom property nor magmom provided&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">structure</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">magmom</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="c1"># Project MAGMOM to z-axis</span>
                <span class="n">structure</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">site_properties</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;magmom&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">site</span><span class="o">.</span><span class="n">magmom</span><span class="p">]</span> <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">structure</span><span class="p">]})</span>

        <span class="k">if</span> <span class="n">VaspInputSet</span><span class="o">.</span><span class="n">structure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;structure is None&quot;</span><span class="p">)</span>
        <span class="n">VaspInputSet</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">fset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">)</span></div>



<div class="viewcode-block" id="MPNMRSet">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.MPNMRSet">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MPNMRSet</span><span class="p">(</span><span class="n">VaspInputSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Init a MPNMRSet.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure (Structure): Structure from previous run.</span>
<span class="sd">        mode (str): The NMR calculation to run</span>
<span class="sd">            &quot;cs&quot;: for Chemical Shift</span>
<span class="sd">            &quot;efg&quot; for Electric Field Gradient</span>
<span class="sd">        isotopes (list): list of Isotopes for quadrupole moments</span>
<span class="sd">        reciprocal_density (int): density of k-mesh by reciprocal volume.</span>
<span class="sd">        lepsilon (bool): Whether to add static dielectric calculation</span>
<span class="sd">        lcalcpol (bool): Whether to turn on evaluation of the Berry phase approximations</span>
<span class="sd">            for electronic polarization</span>
<span class="sd">        reciprocal_density (int): For static calculations, we usually set the</span>
<span class="sd">            reciprocal density by volume. This is a convenience arg to change</span>
<span class="sd">            that, rather than using user_kpoints_settings. Defaults to 100,</span>
<span class="sd">            which is ~50% more than that of standard relaxation calculations.</span>
<span class="sd">        small_gap_multiply ([float, float]): If the gap is less than</span>
<span class="sd">            1st index, multiply the default reciprocal_density by the 2nd</span>
<span class="sd">            index.</span>
<span class="sd">        **kwargs: Keywords supported by MPRelaxSet.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;cs&quot;</span><span class="p">,</span> <span class="s2">&quot;efg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;cs&quot;</span>
    <span class="n">isotopes</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">reciprocal_density</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">small_gap_multiply</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">inherit_incar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">MPRelaxSet</span><span class="o">.</span><span class="n">CONFIG</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">incar_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the INCAR config for this calculation type.&quot;&quot;&quot;</span>
        <span class="n">updates</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;NSW&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;ISMEAR&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span>
            <span class="s2">&quot;LCHARG&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;LORBIT&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
            <span class="s2">&quot;LREAL&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;cs&quot;</span><span class="p">:</span>
            <span class="n">updates</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">LCHIMAG</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">EDIFF</span><span class="o">=-</span><span class="mf">1e-10</span><span class="p">,</span>
                <span class="n">ISYM</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">LCHARG</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">LNMR_SYM_RED</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">NELMIN</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="n">NLSPLINE</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">PREC</span><span class="o">=</span><span class="s2">&quot;ACCURATE&quot;</span><span class="p">,</span>
                <span class="n">SIGMA</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;efg&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">isotopes</span> <span class="o">=</span> <span class="p">{</span><span class="n">isotope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">isotope</span> <span class="k">for</span> <span class="n">isotope</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">}</span>
            <span class="n">quad_efg</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">Species</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">get_nmr_quadrupole_moment</span><span class="p">(</span><span class="n">isotopes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">name</span><span class="p">)))</span>
                <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">species</span>
            <span class="p">]</span>
            <span class="n">updates</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">ALGO</span><span class="o">=</span><span class="s2">&quot;FAST&quot;</span><span class="p">,</span>
                <span class="n">EDIFF</span><span class="o">=-</span><span class="mf">1e-10</span><span class="p">,</span>
                <span class="n">ISYM</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">LCHARG</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">LEFG</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">QUAD_EFG</span><span class="o">=</span><span class="n">quad_efg</span><span class="p">,</span>
                <span class="n">NELMIN</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="n">PREC</span><span class="o">=</span><span class="s2">&quot;ACCURATE&quot;</span><span class="p">,</span>
                <span class="n">SIGMA</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">updates</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">kpoints_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the kpoints configuration for this calculation type.&quot;&quot;&quot;</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandgap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">small_gap_multiply</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandgap</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">small_gap_multiply</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">small_gap_multiply</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;reciprocal_density&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reciprocal_density</span> <span class="o">*</span> <span class="n">factor</span><span class="p">}</span></div>



<div class="viewcode-block" id="MVLElasticSet">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.MVLElasticSet">[docs]</a>
<span class="nd">@due</span><span class="o">.</span><span class="n">dcite</span><span class="p">(</span>
    <span class="n">Doi</span><span class="p">(</span><span class="s2">&quot;10.1149/2.0061602jes&quot;</span><span class="p">),</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Elastic Properties of Alkali Superionic Conductor Electrolytes from First Principles Calculations&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MVLElasticSet</span><span class="p">(</span><span class="n">VaspInputSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    MVL denotes VASP input sets that are implemented by the Materials Virtual</span>
<span class="sd">    Lab (https://materialsvirtuallab.org) for various research.</span>

<span class="sd">    This input set is used to calculate elastic constants in VASP. It is used</span>
<span class="sd">    in the following work::</span>

<span class="sd">        Z. Deng, Z. Wang, I.-H. Chu, J. Luo, S. P. Ong.</span>
<span class="sd">        “Elastic Properties of Alkali Superionic Conductor Electrolytes</span>
<span class="sd">        from First Principles Calculations”, J. Electrochem. Soc.</span>
<span class="sd">        2016, 163(2), A67-A74. doi: 10.1149/2.0061602jes</span>

<span class="sd">    To read the elastic constants, you may use the Outcar class which parses the</span>
<span class="sd">    elastic constants.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure (pymatgen.Structure): Input structure.</span>
<span class="sd">        potim (float): POTIM parameter. The default of 0.015 is usually fine,</span>
<span class="sd">            but some structures may require a smaller step.</span>
<span class="sd">        **kwargs: Parameters supported by MPRelaxSet.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">potim</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.015</span>
    <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">MPRelaxSet</span><span class="o">.</span><span class="n">CONFIG</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">incar_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the INCAR config for this calculation type.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;IBRION&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s2">&quot;NFREE&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;POTIM&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">potim</span><span class="p">,</span> <span class="s2">&quot;NPAR&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span></div>



<div class="viewcode-block" id="MVLGWSet">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.MVLGWSet">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MVLGWSet</span><span class="p">(</span><span class="n">VaspInputSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    MVL denotes VASP input sets that are implemented by the Materials Virtual</span>
<span class="sd">    Lab (https://materialsvirtuallab.org) for various research. This is a</span>
<span class="sd">    flexible input set for GW calculations.</span>

<span class="sd">    Note that unlike all other input sets in this module, the PBE_54 series of</span>
<span class="sd">    functional is set as the default. These have much improved performance for</span>
<span class="sd">    GW calculations.</span>

<span class="sd">    A typical sequence is mode=&quot;STATIC&quot; -&gt; mode=&quot;DIAG&quot; -&gt; mode=&quot;GW&quot; -&gt;</span>
<span class="sd">    mode=&quot;BSE&quot;. For all steps other than the first one (static), the</span>
<span class="sd">    recommendation is to use from_prev_calculation on the preceding run in</span>
<span class="sd">    the series.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure (Structure): Input structure.</span>
<span class="sd">        mode (str): Supported modes are &quot;STATIC&quot; (default), &quot;DIAG&quot;, &quot;GW&quot;,</span>
<span class="sd">            and &quot;BSE&quot;.</span>
<span class="sd">        nbands (int): For subsequent calculations, it is generally</span>
<span class="sd">            recommended to perform NBANDS convergence starting from the</span>
<span class="sd">            NBANDS of the previous run for DIAG, and to use the exact same</span>
<span class="sd">            NBANDS for GW and BSE. This parameter is used by</span>
<span class="sd">            from_previous_calculation to set nband.</span>
<span class="sd">        copy_wavecar: Whether to copy the old WAVECAR, WAVEDER and associated</span>
<span class="sd">            files when starting from a previous calculation.</span>
<span class="sd">        nbands_factor (int): Multiplicative factor for NBANDS when starting</span>
<span class="sd">            from a previous calculation. Only applies if mode==&quot;DIAG&quot;.</span>
<span class="sd">            Need to be tested for convergence.</span>
<span class="sd">        reciprocal_density (int): Density of k-mesh by reciprocal atom. Only</span>
<span class="sd">            applies if mode==&quot;STATIC&quot;. Defaults to 100.</span>
<span class="sd">        ncores (int): Numbers of cores used for the calculation. VASP will alter</span>
<span class="sd">            NBANDS if it was not dividable by ncores. Only applies if</span>
<span class="sd">            mode==&quot;DIAG&quot;.</span>
<span class="sd">        **kwargs: All kwargs supported by VaspInputSet. Typically,</span>
<span class="sd">            user_incar_settings is a commonly used option.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">reciprocal_density</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;STATIC&quot;</span>
    <span class="n">copy_wavecar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">nbands_factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">ncores</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="n">nbands</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">force_gamma</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">inherit_incar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># inherit incar from previous run if available</span>
    <span class="n">SUPPORTED_MODES</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;DIAG&quot;</span><span class="p">,</span> <span class="s2">&quot;GW&quot;</span><span class="p">,</span> <span class="s2">&quot;STATIC&quot;</span><span class="p">,</span> <span class="s2">&quot;BSE&quot;</span><span class="p">)</span>
    <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">_load_yaml_config</span><span class="p">(</span><span class="s2">&quot;MVLGWSet&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate input settings.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">MVLGWSet</span><span class="o">.</span><span class="n">SUPPORTED_MODES</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid </span><span class="si">{</span><span class="n">mode</span><span class="si">=}</span><span class="s2">, supported modes are </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">repr</span><span class="p">,</span><span class="w"> </span><span class="n">MVLGWSet</span><span class="o">.</span><span class="n">SUPPORTED_MODES</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">kpoints_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the kpoints configuration for this calculation type.&quot;&quot;&quot;</span>
        <span class="c1"># Generate gamma center k-points mesh grid for GW calc, which is requested</span>
        <span class="c1"># by GW calculation.</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;reciprocal_density&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reciprocal_density</span><span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">incar_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the INCAR config for this calculation type.&quot;&quot;&quot;</span>
        <span class="n">updates</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">nbands</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_vasprun</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;NBANDS&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_vasprun</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;DIAG&quot;</span><span class="p">:</span>
            <span class="c1"># Default parameters for diagonalization calculation.</span>
            <span class="n">updates</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;ALGO&quot;</span><span class="p">:</span> <span class="s2">&quot;Exact&quot;</span><span class="p">,</span> <span class="s2">&quot;NELM&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;LOPTICS&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;LPEAD&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">nbands</span><span class="p">:</span>
                <span class="n">nbands</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">nbands</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbands_factor</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncores</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncores</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;GW&quot;</span><span class="p">:</span>
            <span class="c1"># Default parameters for GW calculation.</span>
            <span class="n">updates</span> <span class="o">|=</span> <span class="p">{</span>
                <span class="s2">&quot;ALGO&quot;</span><span class="p">:</span> <span class="s2">&quot;GW0&quot;</span><span class="p">,</span>
                <span class="s2">&quot;NELM&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;NOMEGA&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
                <span class="s2">&quot;ENCUTGW&quot;</span><span class="p">:</span> <span class="mi">250</span><span class="p">,</span>
                <span class="s2">&quot;EDIFF&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;LOPTICS&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;LPEAD&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;BSE&quot;</span><span class="p">:</span>
            <span class="c1"># Default parameters for BSE calculation.</span>
            <span class="n">updates</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;ALGO&quot;</span><span class="p">:</span> <span class="s2">&quot;BSE&quot;</span><span class="p">,</span> <span class="s2">&quot;ANTIRES&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;NBANDSO&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;NBANDSV&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">nbands</span><span class="p">:</span>
            <span class="n">updates</span><span class="p">[</span><span class="s2">&quot;NBANDS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nbands</span>

        <span class="k">return</span> <span class="n">updates</span>

<div class="viewcode-block" id="MVLGWSet.from_prev_calc">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.MVLGWSet.from_prev_calc">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_prev_calc</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">prev_calc_dir</span><span class="p">:</span> <span class="n">PathLike</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;DIAG&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a set of VASP input files for GW or BSE calculations from a</span>
<span class="sd">        directory of previous Exact Diag VASP run.</span>

<span class="sd">        Args:</span>
<span class="sd">            prev_calc_dir (PathLike): The directory contains the outputs(</span>
<span class="sd">                vasprun.xml of previous VASP run.</span>
<span class="sd">            mode (str): Supported modes are &quot;STATIC&quot;, &quot;DIAG&quot; (default), &quot;GW&quot;,</span>
<span class="sd">                and &quot;BSE&quot;.</span>
<span class="sd">            **kwargs: All kwargs supported by MVLGWSet, other than structure,</span>
<span class="sd">                prev_incar and mode, which are determined from the</span>
<span class="sd">                prev_calc_dir.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">input_set</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">_dummy_structure</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">input_set</span><span class="o">.</span><span class="n">override_from_prev_calc</span><span class="p">(</span><span class="n">prev_calc_dir</span><span class="o">=</span><span class="n">prev_calc_dir</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="MVLSlabSet">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.MVLSlabSet">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MVLSlabSet</span><span class="p">(</span><span class="n">VaspInputSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write a set of slab VASP runs, including both slabs (along the c direction)</span>
<span class="sd">    and orient unit cells (bulk), to ensure the same KPOINTS, POTCAR and INCAR criterion.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure: Structure</span>
<span class="sd">        k_product: default to 50, kpoint number * length for a &amp; b</span>
<span class="sd">            directions, also for c direction in bulk calculations</span>
<span class="sd">        bulk:</span>
<span class="sd">        auto_dipole:</span>
<span class="sd">        set_mix:</span>
<span class="sd">        sort_structure:</span>
<span class="sd">        **kwargs: Other kwargs supported by VaspInputSet.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">k_product</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">bulk</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">auto_dipole</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">set_mix</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">MPRelaxSet</span><span class="o">.</span><span class="n">CONFIG</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">incar_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the INCAR config for this calculation type.&quot;&quot;&quot;</span>
        <span class="n">updates</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;EDIFF&quot;</span><span class="p">:</span> <span class="mf">1e-4</span><span class="p">,</span>
            <span class="s2">&quot;EDIFFG&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.02</span><span class="p">,</span>
            <span class="s2">&quot;ENCUT&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
            <span class="s2">&quot;ISMEAR&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;SIGMA&quot;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
            <span class="s2">&quot;ISIF&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk</span><span class="p">:</span>
            <span class="n">updates</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;ISIF&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;LVTOT&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;NELMIN&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_mix</span><span class="p">:</span>
                <span class="n">updates</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;AMIN&quot;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span> <span class="s2">&quot;AMIX&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s2">&quot;BMIX&quot;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_dipole</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">struct</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">weight</span> <span class="k">for</span> <span class="n">struct</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">]</span>
                <span class="n">center_of_mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">updates</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;IDIPOL&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;LDIPOL&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;DIPOL&quot;</span><span class="p">:</span> <span class="n">center_of_mass</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">updates</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">kpoints_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Kpoints</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the kpoints configuration for this calculation type.</span>

<span class="sd">        k_product, default to 50, is kpoint number * length for a &amp; b</span>
<span class="sd">        directions, also for c direction in bulk calculations</span>
<span class="sd">        Automatic mesh &amp; Gamma is the default setting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># To get input sets, the input structure has to has the same number</span>
        <span class="c1"># of required parameters as a Structure object (ie. 4). Slab</span>
        <span class="c1"># attributes aren&#39;t going to affect the VASP inputs anyways so</span>
        <span class="c1"># converting the slab into a structure should not matter</span>
        <span class="c1"># use k_product to calculate kpoints, k_product = kpts[0][0] * a</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;structure is None&quot;</span><span class="p">)</span>
        <span class="n">lattice_abc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">abc</span>
        <span class="n">kpt_calc</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_product</span> <span class="o">/</span> <span class="n">lattice_abc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">),</span>
            <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_product</span> <span class="o">/</span> <span class="n">lattice_abc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">),</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="c1"># Calculate kpts (c direction) for bulk. (for slab, set to 1)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk</span><span class="p">:</span>
            <span class="n">kpt_calc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_product</span> <span class="o">/</span> <span class="n">lattice_abc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Kpoints</span><span class="p">(</span>
            <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;Generated by pymatgen&#39;s MVLGBSet&quot;</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="n">Kpoints</span><span class="o">.</span><span class="n">supported_modes</span><span class="o">.</span><span class="n">Gamma</span><span class="p">,</span>
            <span class="n">kpts</span><span class="o">=</span><span class="p">[</span><span class="n">cast</span><span class="p">(</span><span class="n">Kpoint</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">kpt_calc</span><span class="p">))],</span>
        <span class="p">)</span>

<div class="viewcode-block" id="MVLSlabSet.as_dict">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.MVLSlabSet.as_dict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbosity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            verbosity (int): Verbosity of dict. e.g. whether to include Structure.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: MSONable MVLGBSet representation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dct</span> <span class="o">=</span> <span class="n">MSONable</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">dct</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;structure&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dct</span></div>
</div>



<div class="viewcode-block" id="MVLGBSet">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.MVLGBSet">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MVLGBSet</span><span class="p">(</span><span class="n">VaspInputSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write a VASP input files for grain boundary calculations, slab or bulk.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure (Structure): provide the structure</span>
<span class="sd">        k_product: Kpoint number * length for a &amp; b directions, also for c direction in</span>
<span class="sd">            bulk calculations. Default to 40.</span>
<span class="sd">        slab_mode (bool): Defaults to False. Use default (False) for a bulk supercell.</span>
<span class="sd">            Use True if you are performing calculations on a slab-like (i.e., surface)</span>
<span class="sd">            of the GB, for example, when you are calculating the work of separation.</span>
<span class="sd">        is_metal (bool): Defaults to True. This determines whether an ISMEAR of 1 is</span>
<span class="sd">            used (for metals) or not (for insulators and semiconductors) by default.</span>
<span class="sd">            Note that it does *not* override user_incar_settings, which can be set by</span>
<span class="sd">            the user to be anything desired.</span>
<span class="sd">        **kwargs:</span>
<span class="sd">            Other kwargs supported by MPRelaxSet.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">k_product</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">40</span>
    <span class="n">slab_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">is_metal</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">MPRelaxSet</span><span class="o">.</span><span class="n">CONFIG</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">kpoints_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Kpoints</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;k_product is kpoint number * length for a &amp; b directions, also for c direction</span>
<span class="sd">        in bulk calculations Automatic mesh &amp; Gamma is the default setting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># use k_product to calculate kpoints, k_product = kpts[0][0] * a</span>
        <span class="n">lengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">abc</span>  <span class="c1"># type: ignore[union-attr]</span>
        <span class="n">kpt_calc</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_product</span> <span class="o">/</span> <span class="n">lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">),</span>
            <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_product</span> <span class="o">/</span> <span class="n">lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">),</span>
            <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_product</span> <span class="o">/</span> <span class="n">lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slab_mode</span><span class="p">:</span>
            <span class="n">kpt_calc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">Kpoints</span><span class="p">(</span>
            <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;Generated by pymatgen&#39;s MVLGBSet&quot;</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="n">Kpoints</span><span class="o">.</span><span class="n">supported_modes</span><span class="o">.</span><span class="n">Gamma</span><span class="p">,</span>
            <span class="n">kpts</span><span class="o">=</span><span class="p">[</span><span class="n">cast</span><span class="p">(</span><span class="n">Kpoint</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">kpt_calc</span><span class="p">))],</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">incar_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the INCAR config for this calculation type.&quot;&quot;&quot;</span>
        <span class="c1"># The default incar setting is used for metallic system, for</span>
        <span class="c1"># insulator or semiconductor, ISMEAR need to be changed.</span>
        <span class="n">updates</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">LCHARG</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">NELM</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
            <span class="n">PREC</span><span class="o">=</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span>
            <span class="n">EDIFFG</span><span class="o">=-</span><span class="mf">0.02</span><span class="p">,</span>
            <span class="n">ICHARG</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">NSW</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
            <span class="n">EDIFF</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_metal</span><span class="p">:</span>
            <span class="n">updates</span><span class="p">[</span><span class="s2">&quot;ISMEAR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">updates</span><span class="p">[</span><span class="s2">&quot;LDAU&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slab_mode</span><span class="p">:</span>
            <span class="c1"># for clean grain boundary and bulk relaxation, full optimization</span>
            <span class="c1"># relaxation (ISIF=3) is used. For slab relaxation (ISIF=2) is used.</span>
            <span class="n">updates</span><span class="p">[</span><span class="s2">&quot;ISIF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">updates</span><span class="p">[</span><span class="s2">&quot;NELMIN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span>

        <span class="k">return</span> <span class="n">updates</span></div>



<div class="viewcode-block" id="MVLRelax52Set">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.MVLRelax52Set">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MVLRelax52Set</span><span class="p">(</span><span class="n">VaspInputSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implementation of VaspInputSet utilizing the public Materials Project</span>
<span class="sd">    parameters for INCAR &amp; KPOINTS and VASP&#39;s recommended PAW potentials for</span>
<span class="sd">    POTCAR.</span>

<span class="sd">    Keynotes from VASP manual:</span>
<span class="sd">        1. Recommended potentials for calculations using VASP.5.2+</span>
<span class="sd">        2. If dimers with short bonds are present in the compound (O2, CO,</span>
<span class="sd">            N2, F2, P2, S2, Cl2), it is recommended to use the h potentials.</span>
<span class="sd">            Specifically, C_h, O_h, N_h, F_h, P_h, S_h, Cl_h</span>
<span class="sd">        3. Released on Oct 28, 2018 by VASP. Please refer to VASP</span>
<span class="sd">            Manual 1.2, 1.3 &amp; 10.2.1 for more details.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure (Structure): input structure.</span>
<span class="sd">        user_potcar_functional (str): choose from &quot;PBE_52&quot;, &quot;PBE_54&quot; and &quot;PBE_64&quot;.</span>
<span class="sd">        **kwargs: Other kwargs supported by VaspInputSet.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">user_potcar_functional</span><span class="p">:</span> <span class="n">UserPotcarFunctional</span> <span class="o">=</span> <span class="s2">&quot;PBE_52&quot;</span>
    <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">_load_yaml_config</span><span class="p">(</span><span class="s2">&quot;MVLRelax52Set&quot;</span><span class="p">)</span>
    <span class="n">_valid_potcars</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;PBE_52&quot;</span><span class="p">,</span> <span class="s2">&quot;PBE_54&quot;</span><span class="p">,</span> <span class="s2">&quot;PBE_64&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="MITNEBSet">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.MITNEBSet">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MITNEBSet</span><span class="p">(</span><span class="n">VaspInputSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write NEB inputs.</span>

<span class="sd">    Note that EDIFF is not on a per atom basis for this input set.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structures</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Structure</span><span class="p">],</span> <span class="n">unset_encut</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            structures: List of Structure objects.</span>
<span class="sd">            unset_encut (bool): Whether to unset ENCUT.</span>
<span class="sd">            **kwargs: Other kwargs supported by VaspInputSet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">structures</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You need at least 3 structures for an NEB, got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">structures</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;sort_structure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">structures</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">MITRelaxSet</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">structures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_structures</span><span class="p">(</span><span class="n">structures</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">unset_encut</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">unset_encut</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config_dict</span><span class="p">[</span><span class="s2">&quot;INCAR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;ENCUT&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;EDIFF&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_dict</span><span class="p">[</span><span class="s2">&quot;INCAR&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config_dict</span><span class="p">[</span><span class="s2">&quot;INCAR&quot;</span><span class="p">][</span><span class="s2">&quot;EDIFF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_dict</span><span class="p">[</span><span class="s2">&quot;INCAR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;EDIFF_PER_ATOM&quot;</span><span class="p">)</span>

        <span class="c1"># NEB specific defaults</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;IMAGES&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">structures</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s2">&quot;IBRION&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;ISYM&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;LCHARG&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;LDAU&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config_dict</span><span class="p">[</span><span class="s2">&quot;INCAR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">defaults</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">poscar</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Poscar</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Poscar for structure of first end point.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Poscar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">poscars</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Poscar</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List of Poscars.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">Poscar</span><span class="p">(</span><span class="n">struct</span><span class="p">)</span> <span class="k">for</span> <span class="n">struct</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_process_structures</span><span class="p">(</span><span class="n">structures</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Structure</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Structure</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove any atoms jumping across the cell.&quot;&quot;&quot;</span>
        <span class="n">input_structures</span> <span class="o">=</span> <span class="n">structures</span>
        <span class="n">structures</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_structures</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">input_structures</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">prev</span> <span class="o">=</span> <span class="n">structures</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">site</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="n">translate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">prev</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">frac_coords</span> <span class="o">-</span> <span class="n">site</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">translate</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">):</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">translate_sites</span><span class="p">([</span><span class="n">idx</span><span class="p">],</span> <span class="n">translate</span><span class="p">,</span> <span class="n">to_unit_cell</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">structures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">structures</span>

<div class="viewcode-block" id="MITNEBSet.write_input">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.MITNEBSet.write_input">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_input</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="p">:</span> <span class="n">PathLike</span><span class="p">,</span>
        <span class="n">make_dir_if_not_present</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">write_cif</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># type: ignore[override]</span>
        <span class="n">write_path_cif</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">write_endpoint_inputs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># type: ignore[override]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        NEB inputs has a special directory structure where inputs are in 00,</span>
<span class="sd">        01, 02, ....</span>

<span class="sd">        Args:</span>
<span class="sd">            output_dir (PathLike): Directory to output the VASP input files</span>
<span class="sd">            make_dir_if_not_present (bool): Set to True if you want the</span>
<span class="sd">                directory (and the whole path) to be created if it is not</span>
<span class="sd">                present.</span>
<span class="sd">            write_cif (bool): If true, writes a CIF along with each POSCAR.</span>
<span class="sd">            write_path_cif (bool): If true, writes a CIF for each image.</span>
<span class="sd">            write_endpoint_inputs (bool): If true, writes input files for</span>
<span class="sd">                running endpoint calculations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">make_dir_if_not_present</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">output_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">incar</span><span class="o">.</span><span class="n">write_file</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;INCAR&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;kpoints is None&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">write_file</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;KPOINTS&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">potcar</span><span class="o">.</span><span class="n">write_file</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;POTCAR&quot;</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">poscar</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">poscars</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">d</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">d</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">poscar</span><span class="o">.</span><span class="n">write_file</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span> <span class="o">/</span> <span class="s2">&quot;POSCAR&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">write_cif</span><span class="p">:</span>
                <span class="n">poscar</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">.cif&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">write_endpoint_inputs</span><span class="p">:</span>
            <span class="n">end_point_param</span> <span class="o">=</span> <span class="n">MITRelaxSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">user_incar_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_incar_settings</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;00&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)):</span>
                <span class="n">end_point_param</span><span class="o">.</span><span class="n">incar</span><span class="o">.</span><span class="n">write_file</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="n">image</span> <span class="o">/</span> <span class="s2">&quot;INCAR&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">end_point_param</span><span class="o">.</span><span class="n">kpoints</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;kpoints of end_point_param is None&quot;</span><span class="p">)</span>
                <span class="n">end_point_param</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">write_file</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="n">image</span> <span class="o">/</span> <span class="s2">&quot;KPOINTS&quot;</span><span class="p">))</span>
                <span class="n">end_point_param</span><span class="o">.</span><span class="n">potcar</span><span class="o">.</span><span class="n">write_file</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="n">image</span> <span class="o">/</span> <span class="s2">&quot;POTCAR&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">write_path_cif</span><span class="p">:</span>
            <span class="n">sites</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">PeriodicSite</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">species</span><span class="p">,</span> <span class="n">site</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lattice</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="p">))</span>
            <span class="p">}</span>
            <span class="n">neb_path</span> <span class="o">=</span> <span class="n">Structure</span><span class="o">.</span><span class="n">from_sites</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">sites</span><span class="p">))</span>
            <span class="n">neb_path</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/path.cif&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="MITMDSet">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.MITMDSet">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MITMDSet</span><span class="p">(</span><span class="n">VaspInputSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write a VASP MD run. This DOES NOT do multiple stage runs.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure (Structure): Input structure.</span>
<span class="sd">        start_temp (float): Starting temperature.</span>
<span class="sd">        end_temp (float): Final temperature.</span>
<span class="sd">        nsteps (int): Number of time steps for simulations. NSW parameter.</span>
<span class="sd">        time_step (float): The time step for the simulation. The POTIM</span>
<span class="sd">            parameter. Defaults to 2fs.</span>
<span class="sd">        spin_polarized (bool): Whether to do spin polarized calculations.</span>
<span class="sd">            The ISPIN parameter. Defaults to False.</span>
<span class="sd">        **kwargs: Other kwargs supported by VaspInputSet.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">start_temp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">end_temp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">300.0</span>
    <span class="n">nsteps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">time_step</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">spin_polarized</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">MITRelaxSet</span><span class="o">.</span><span class="n">CONFIG</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">incar_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the INCAR config for this calculation type.&quot;&quot;&quot;</span>
        <span class="c1"># MD default settings</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;TEBEG&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_temp</span><span class="p">,</span>
            <span class="s2">&quot;TEEND&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_temp</span><span class="p">,</span>
            <span class="s2">&quot;NSW&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">,</span>
            <span class="s2">&quot;EDIFF_PER_ATOM&quot;</span><span class="p">:</span> <span class="mf">0.000001</span><span class="p">,</span>
            <span class="s2">&quot;LSCALU&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;LCHARG&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;LPLANE&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;LWAVE&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;ISMEAR&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;NELMIN&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s2">&quot;LREAL&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;BMIX&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;MAXMIX&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
            <span class="s2">&quot;NELM&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
            <span class="s2">&quot;NSIM&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s2">&quot;ISYM&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;ISIF&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;IBRION&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;NBLOCK&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;KBLOCK&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s2">&quot;SMASS&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;POTIM&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">,</span>
            <span class="s2">&quot;PREC&quot;</span><span class="p">:</span> <span class="s2">&quot;Low&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ISPIN&quot;</span><span class="p">:</span> <span class="mi">2</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_polarized</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;LDAU&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;ENCUT&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">kpoints_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Kpoints</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the kpoints configuration for this calculation type.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Kpoints</span><span class="o">.</span><span class="n">gamma_automatic</span><span class="p">()</span></div>



<div class="viewcode-block" id="MPMDSet">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.MPMDSet">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MPMDSet</span><span class="p">(</span><span class="n">VaspInputSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This a modified version of the old MITMDSet pre 2018/03/12.</span>

<span class="sd">    This set serves as the basis for the amorphous skyline paper.</span>

<span class="sd">    (1) Aykol, M.; Dwaraknath, S. S.; Sun, W.; Persson, K. A. Thermodynamic</span>
<span class="sd">        Limit for Synthesis of Metastable Inorganic Materials. Sci. Adv. 2018,</span>
<span class="sd">        4 (4).</span>

<span class="sd">    Class for writing a VASP MD run. This DOES NOT do multiple stage runs.</span>
<span class="sd">    Precision remains normal, to increase accuracy of stress tensor.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure (Structure): Input structure.</span>
<span class="sd">        start_temp (int): Starting temperature.</span>
<span class="sd">        end_temp (int): Final temperature.</span>
<span class="sd">        nsteps (int): Number of time steps for simulations. NSW parameter.</span>
<span class="sd">        time_step (float): The time step for the simulation. The POTIM</span>
<span class="sd">            parameter. Defaults to None, which will set it automatically</span>
<span class="sd">            to 2.0 fs for non-hydrogen containing structures and 0.5 fs</span>
<span class="sd">            for hydrogen containing structures.</span>
<span class="sd">        spin_polarized (bool): Whether to do spin polarized calculations.</span>
<span class="sd">            The ISPIN parameter. Defaults to False.</span>
<span class="sd">        **kwargs: Other kwargs supported by VaspInputSet.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">start_temp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">end_temp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">300.0</span>
    <span class="n">nsteps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">time_step</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">spin_polarized</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">MPRelaxSet</span><span class="o">.</span><span class="n">CONFIG</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">incar_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the INCAR config for this calculation type.&quot;&quot;&quot;</span>
        <span class="n">updates</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;TEBEG&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_temp</span><span class="p">,</span>
            <span class="s2">&quot;TEEND&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_temp</span><span class="p">,</span>
            <span class="s2">&quot;NSW&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">,</span>
            <span class="s2">&quot;EDIFF_PER_ATOM&quot;</span><span class="p">:</span> <span class="mf">0.00001</span><span class="p">,</span>
            <span class="s2">&quot;LSCALU&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;LCHARG&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;LPLANE&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;LWAVE&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;ISMEAR&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;NELMIN&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s2">&quot;LREAL&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;BMIX&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;MAXMIX&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
            <span class="s2">&quot;NELM&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
            <span class="s2">&quot;NSIM&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s2">&quot;ISYM&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;ISIF&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;IBRION&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;NBLOCK&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;KBLOCK&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s2">&quot;SMASS&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;PREC&quot;</span><span class="p">:</span> <span class="s2">&quot;Normal&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ISPIN&quot;</span><span class="p">:</span> <span class="mi">2</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_polarized</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;LDAU&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;ADDGRID&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;ENCUT&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_polarized</span><span class="p">:</span>
            <span class="n">updates</span><span class="p">[</span><span class="s2">&quot;MAGMOM&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Element</span><span class="p">(</span><span class="s2">&quot;H&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">species</span><span class="p">:</span>
                <span class="n">updates</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;POTIM&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;NSW&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">*</span> <span class="mi">4</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">updates</span><span class="p">[</span><span class="s2">&quot;POTIM&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">updates</span><span class="p">[</span><span class="s2">&quot;POTIM&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span>

        <span class="k">return</span> <span class="n">updates</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">kpoints_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Kpoints</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the kpoints configuration for this calculation type.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Kpoints</span><span class="o">.</span><span class="n">gamma_automatic</span><span class="p">()</span></div>



<div class="viewcode-block" id="MVLNPTMDSet">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.MVLNPTMDSet">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MVLNPTMDSet</span><span class="p">(</span><span class="n">VaspInputSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write a VASP MD run in NPT ensemble.</span>

<span class="sd">    Notes:</span>
<span class="sd">        To eliminate Pulay stress, the default ENCUT is set to a rather large</span>
<span class="sd">        value of ENCUT, which is 1.5 * ENMAX.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">start_temp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">end_temp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">300.0</span>
    <span class="n">nsteps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">time_step</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">spin_polarized</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">MITRelaxSet</span><span class="o">.</span><span class="n">CONFIG</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">incar_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the INCAR config for this calculation type.&quot;&quot;&quot;</span>
        <span class="c1"># NPT-AIMD default settings</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;structure is None&quot;</span><span class="p">)</span>
        <span class="n">updates</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;ALGO&quot;</span><span class="p">:</span> <span class="s2">&quot;Fast&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ISIF&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s2">&quot;LANGEVIN_GAMMA&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">n_elems</span><span class="p">,</span>
            <span class="s2">&quot;LANGEVIN_GAMMA_L&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;MDALGO&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s2">&quot;PMASS&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s2">&quot;PSTRESS&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;SMASS&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;TEBEG&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_temp</span><span class="p">,</span>
            <span class="s2">&quot;TEEND&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_temp</span><span class="p">,</span>
            <span class="s2">&quot;NSW&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">,</span>
            <span class="s2">&quot;EDIFF_PER_ATOM&quot;</span><span class="p">:</span> <span class="mf">0.000001</span><span class="p">,</span>
            <span class="s2">&quot;LSCALU&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;LCHARG&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;LPLANE&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;LWAVE&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;ISMEAR&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;NELMIN&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s2">&quot;LREAL&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;BMIX&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;MAXMIX&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
            <span class="s2">&quot;NELM&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
            <span class="s2">&quot;NSIM&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s2">&quot;ISYM&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;IBRION&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;NBLOCK&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;KBLOCK&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s2">&quot;POTIM&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">,</span>
            <span class="s2">&quot;PREC&quot;</span><span class="p">:</span> <span class="s2">&quot;Low&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ISPIN&quot;</span><span class="p">:</span> <span class="mi">2</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_polarized</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;LDAU&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="c1"># Set NPT-AIMD ENCUT = 1.5 * VASP_default</span>
        <span class="n">enmax</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">potcar</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">keywords</span><span class="p">[</span><span class="s2">&quot;ENMAX&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">n_elems</span><span class="p">)]</span>
        <span class="n">updates</span><span class="p">[</span><span class="s2">&quot;ENCUT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">enmax</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.5</span>
        <span class="k">return</span> <span class="n">updates</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">kpoints_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Kpoints</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the kpoints configuration for this calculation type.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Kpoints</span><span class="o">.</span><span class="n">gamma_automatic</span><span class="p">()</span></div>



<div class="viewcode-block" id="MVLScanRelaxSet">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.MVLScanRelaxSet">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MVLScanRelaxSet</span><span class="p">(</span><span class="n">VaspInputSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write a relax input set using Strongly Constrained and</span>
<span class="sd">    Appropriately Normed (SCAN) semilocal density functional.</span>

<span class="sd">    Notes:</span>
<span class="sd">        1. This functional is only available from VASP.5.4.3 upwards.</span>

<span class="sd">        2. Meta-GGA calculations require POTCAR files that include</span>
<span class="sd">        information on the kinetic energy density of the core-electrons,</span>
<span class="sd">        i.e. &quot;PBE_52&quot;, &quot;PBE_54&quot; or &quot;PBE_64&quot;. Make sure the POTCAR including the</span>
<span class="sd">        following lines (see VASP wiki for more details):</span>

<span class="sd">            $ grep kinetic POTCAR</span>
<span class="sd">            kinetic energy-density</span>
<span class="sd">            mkinetic energy-density pseudized</span>
<span class="sd">            kinetic energy density (partial)</span>

<span class="sd">    Args:</span>
<span class="sd">        structure (Structure): input structure.</span>
<span class="sd">        vdw (str): set &quot;rVV10&quot; to enable SCAN+rVV10, which is a versatile</span>
<span class="sd">            van der Waals density functional by combing the SCAN functional</span>
<span class="sd">            with the rVV10 non-local correlation functional.</span>
<span class="sd">        **kwargs: Other kwargs supported by VaspInputSet.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">user_potcar_functional</span><span class="p">:</span> <span class="n">UserPotcarFunctional</span> <span class="o">=</span> <span class="s2">&quot;PBE_52&quot;</span>
    <span class="n">_valid_potcars</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;PBE_52&quot;</span><span class="p">,</span> <span class="s2">&quot;PBE_54&quot;</span><span class="p">,</span> <span class="s2">&quot;PBE_64&quot;</span><span class="p">)</span>
    <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">MPRelaxSet</span><span class="o">.</span><span class="n">CONFIG</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_potcar_functional</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;PBE_52&quot;</span><span class="p">,</span> <span class="s2">&quot;PBE_54&quot;</span><span class="p">,</span> <span class="s2">&quot;PBE_64&quot;</span><span class="p">}:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;SCAN calculations require PBE_52, PBE_54, or PBE_64!&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">incar_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the INCAR config for this calculation type.&quot;&quot;&quot;</span>
        <span class="n">updates</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;ADDGRID&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;EDIFF&quot;</span><span class="p">:</span> <span class="mf">1e-5</span><span class="p">,</span>
            <span class="s2">&quot;EDIFFG&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">,</span>
            <span class="s2">&quot;LASPH&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;LDAU&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;METAGGA&quot;</span><span class="p">:</span> <span class="s2">&quot;SCAN&quot;</span><span class="p">,</span>
            <span class="s2">&quot;NELM&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vdw</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">vdw</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;rvv10&quot;</span><span class="p">:</span>
            <span class="n">updates</span><span class="p">[</span><span class="s2">&quot;BPARAM&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">15.7</span>  <span class="c1"># The correct BPARAM for SCAN+rVV10</span>
        <span class="k">return</span> <span class="n">updates</span></div>



<div class="viewcode-block" id="LobsterSet">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.LobsterSet">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LobsterSet</span><span class="p">(</span><span class="n">VaspInputSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Input set to prepare VASP runs that can be digested by Lobster (See cohp.de).</span>

<span class="sd">    Args:</span>
<span class="sd">        structure (Structure): input structure.</span>
<span class="sd">        isym (int): ISYM entry for INCAR, only isym=-1 and isym=0 are allowed</span>
<span class="sd">        ismear (int): ISMEAR entry for INCAR, only ismear=-5 and ismear=0 are allowed</span>
<span class="sd">        reciprocal_density (int): density of k-mesh by reciprocal volume</span>
<span class="sd">        user_supplied_basis (dict): dict including basis functions for all elements in</span>
<span class="sd">            structure, e.g. {&quot;Fe&quot;: &quot;3d 3p 4s&quot;, &quot;O&quot;: &quot;2s 2p&quot;}; if not supplied, a</span>
<span class="sd">            standard basis is used</span>
<span class="sd">        address_basis_file (str): address to a file similar to</span>
<span class="sd">            &quot;BASIS_PBE_54_standard.yaml&quot; in pymatgen.io.lobster.lobster_basis</span>
<span class="sd">        user_potcar_settings (dict): dict including potcar settings for all elements in</span>
<span class="sd">            structure, e.g. {&quot;Fe&quot;: &quot;Fe_pv&quot;, &quot;O&quot;: &quot;O&quot;}; if not supplied, a standard basis</span>
<span class="sd">            is used.</span>
<span class="sd">        **kwargs: Other kwargs supported by VaspInputSet.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">isym</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ismear</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span>
    <span class="n">reciprocal_density</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">address_basis_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">user_supplied_basis</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Latest POTCARs are preferred</span>
    <span class="c1"># Choose PBE_54 unless the user specifies a different potcar_functional</span>
    <span class="n">user_potcar_functional</span><span class="p">:</span> <span class="n">UserPotcarFunctional</span> <span class="o">=</span> <span class="s2">&quot;PBE_54&quot;</span>

    <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">MPRelaxSet</span><span class="o">.</span><span class="n">CONFIG</span>
    <span class="n">_valid_potcars</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;PBE_52&quot;</span><span class="p">,</span> <span class="s2">&quot;PBE_54&quot;</span><span class="p">,</span> <span class="s2">&quot;PBE_64&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;Make sure that all parameters are okay! This is a brand new implementation.&quot;</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_potcar_functional</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;PBE_52&quot;</span><span class="p">,</span> <span class="s2">&quot;PBE_64&quot;</span><span class="p">]:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user_potcar_functional</span><span class="si">}</span><span class="s2"> POTCARs with basis functions generated for PBE_54 POTCARs. &quot;</span>
                <span class="s2">&quot;Basis functions for elements with obsoleted, updated or newly added POTCARs in &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user_potcar_functional</span><span class="si">}</span><span class="s2"> will not be available and may cause errors or inaccuracies.&quot;</span><span class="p">,</span>
                <span class="n">BadInputSetWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isym</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">}:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Lobster cannot digest WAVEFUNCTIONS with symmetry. isym must be -1 or 0&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ismear</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">}:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Lobster usually works with ismear=-5 or ismear=0&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_config_dict</span><span class="p">[</span><span class="s2">&quot;POTCAR&quot;</span><span class="p">][</span><span class="s2">&quot;W&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;W_sv&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">kpoints_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the kpoints configuration for this calculation type.&quot;&quot;&quot;</span>
        <span class="c1"># Test if this is okay</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;reciprocal_density&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reciprocal_density</span> <span class="ow">or</span> <span class="mi">310</span><span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">incar_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the INCAR config for this calculation type.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pymatgen.io.lobster</span><span class="w"> </span><span class="kn">import</span> <span class="n">Lobsterin</span>

        <span class="n">potcar_symbols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">potcar_symbols</span>

        <span class="c1"># Predefined basis! Check if the basis is okay! (charge spilling and bandoverlaps!)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_supplied_basis</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">address_basis_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">basis</span> <span class="o">=</span> <span class="n">Lobsterin</span><span class="o">.</span><span class="n">get_basis</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">potcar_symbols</span><span class="o">=</span><span class="n">potcar_symbols</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">address_basis_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">basis</span> <span class="o">=</span> <span class="n">Lobsterin</span><span class="o">.</span><span class="n">get_basis</span><span class="p">(</span>
                <span class="n">structure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span>  <span class="c1"># type: ignore[arg-type]</span>
                <span class="n">potcar_symbols</span><span class="o">=</span><span class="n">potcar_symbols</span><span class="p">,</span>
                <span class="n">address_basis_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">address_basis_file</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_supplied_basis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Test if all elements from structure are in user_supplied_basis</span>
            <span class="k">for</span> <span class="n">atom_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">symbol_set</span><span class="p">:</span>  <span class="c1"># type: ignore[union-attr]</span>
                <span class="k">if</span> <span class="n">atom_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_supplied_basis</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There are no basis functions for the atom type </span><span class="si">{</span><span class="n">atom_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">basis</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_supplied_basis</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">basis</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">lobsterin</span> <span class="o">=</span> <span class="n">Lobsterin</span><span class="p">(</span><span class="n">settingsdict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;basisfunctions&quot;</span><span class="p">:</span> <span class="n">basis</span><span class="p">})</span>
        <span class="n">nbands</span> <span class="o">=</span> <span class="n">lobsterin</span><span class="o">.</span><span class="n">_get_nbands</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;EDIFF&quot;</span><span class="p">:</span> <span class="mf">1e-6</span><span class="p">,</span>
            <span class="s2">&quot;NSW&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;LWAVE&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;ISYM&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">isym</span><span class="p">,</span>
            <span class="s2">&quot;NBANDS&quot;</span><span class="p">:</span> <span class="n">nbands</span><span class="p">,</span>
            <span class="s2">&quot;IBRION&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;ISMEAR&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ismear</span><span class="p">,</span>
            <span class="s2">&quot;LORBIT&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
            <span class="s2">&quot;ICHARG&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;ALGO&quot;</span><span class="p">:</span> <span class="s2">&quot;Normal&quot;</span><span class="p">,</span>
        <span class="p">}</span></div>



<div class="viewcode-block" id="get_vasprun_outcar">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.get_vasprun_outcar">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_vasprun_outcar</span><span class="p">(</span>
    <span class="n">path</span><span class="p">:</span> <span class="n">PathLike</span><span class="p">,</span>
    <span class="n">parse_dos</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">parse_eigen</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Vasprun</span><span class="p">,</span> <span class="n">Outcar</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a Vasprun and Outcar from a directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        path: Path to get the vasprun.xml and OUTCAR.</span>
<span class="sd">        parse_dos: Whether to parse dos. Defaults to True.</span>
<span class="sd">        parse_eigen: Whether to parse eigenvalue. Defaults to True.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Vasprun and Outcar files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">vruns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;vasprun.xml*&quot;</span><span class="p">)))</span>
    <span class="n">outcars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;OUTCAR*&quot;</span><span class="p">)))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">vruns</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">outcars</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to get vasprun.xml/OUTCAR from prev calculation in </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">vsfile_fullpath</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;vasprun.xml&quot;</span><span class="p">)</span>
    <span class="n">outcarfile_fullpath</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;OUTCAR.gz&quot;</span><span class="p">)</span>
    <span class="n">vsfile</span> <span class="o">=</span> <span class="n">vsfile_fullpath</span> <span class="k">if</span> <span class="n">vsfile_fullpath</span> <span class="ow">in</span> <span class="n">vruns</span> <span class="k">else</span> <span class="nb">max</span><span class="p">(</span><span class="n">vruns</span><span class="p">)</span>
    <span class="n">outcarfile</span> <span class="o">=</span> <span class="n">outcarfile_fullpath</span> <span class="k">if</span> <span class="n">outcarfile_fullpath</span> <span class="ow">in</span> <span class="n">outcars</span> <span class="k">else</span> <span class="nb">max</span><span class="p">(</span><span class="n">outcars</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">Vasprun</span><span class="p">(</span><span class="n">vsfile</span><span class="p">,</span> <span class="n">parse_dos</span><span class="o">=</span><span class="n">parse_dos</span><span class="p">,</span> <span class="n">parse_eigen</span><span class="o">=</span><span class="n">parse_eigen</span><span class="p">),</span>
        <span class="n">Outcar</span><span class="p">(</span><span class="n">outcarfile</span><span class="p">),</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="get_structure_from_prev_run">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.get_structure_from_prev_run">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_structure_from_prev_run</span><span class="p">(</span><span class="n">vasprun</span><span class="p">:</span> <span class="n">Vasprun</span><span class="p">,</span> <span class="n">outcar</span><span class="p">:</span> <span class="n">Outcar</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Structure</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process structure from previous run.</span>

<span class="sd">    Args:</span>
<span class="sd">        vasprun (Vasprun): Vasprun that contains the final structure from previous run.</span>
<span class="sd">        outcar (Outcar): Outcar that contains the magnetization info from previous run.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Structure: The magmom-decorated structure that can be passed to get VASP input files, e.g.</span>
<span class="sd">            get_kpoints().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">structure</span> <span class="o">=</span> <span class="n">vasprun</span><span class="o">.</span><span class="n">final_structure</span>

    <span class="n">site_properties</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># MAGMOM</span>
    <span class="k">if</span> <span class="n">vasprun</span><span class="o">.</span><span class="n">is_spin</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">outcar</span> <span class="ow">and</span> <span class="n">outcar</span><span class="o">.</span><span class="n">magnetization</span><span class="p">:</span>
            <span class="n">site_properties</span><span class="p">[</span><span class="s2">&quot;magmom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="s2">&quot;tot&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outcar</span><span class="o">.</span><span class="n">magnetization</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">site_properties</span><span class="p">[</span><span class="s2">&quot;magmom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vasprun</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;MAGMOM&quot;</span><span class="p">]</span>

    <span class="c1"># LDAU</span>
    <span class="k">if</span> <span class="n">vasprun</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LDAU&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;LDAUU&quot;</span><span class="p">,</span> <span class="s2">&quot;LDAUJ&quot;</span><span class="p">,</span> <span class="s2">&quot;LDAUL&quot;</span><span class="p">):</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">vasprun</span><span class="o">.</span><span class="n">incar</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">m</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">l_val</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">structure</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">site</span><span class="o">.</span><span class="n">specie</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
                    <span class="n">m</span><span class="p">[</span><span class="n">site</span><span class="o">.</span><span class="n">specie</span><span class="o">.</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">l_val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">site</span><span class="o">.</span><span class="n">specie</span><span class="o">.</span><span class="n">symbol</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_val</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">structure</span><span class="p">):</span>
                <span class="n">site_properties</span> <span class="o">|=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">l_val</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;length of list </span><span class="si">{</span><span class="n">l_val</span><span class="si">}</span><span class="s2"> not the same as structure&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">structure</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">site_properties</span><span class="o">=</span><span class="n">site_properties</span><span class="p">)</span></div>



<div class="viewcode-block" id="standardize_structure">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.standardize_structure">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">standardize_structure</span><span class="p">(</span>
    <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">,</span>
    <span class="n">sym_prec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">international_monoclinic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Structure</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the symmetrically standardized structure.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure (Structure): The structure.</span>
<span class="sd">        sym_prec (float): Tolerance for symmetry finding for standardization.</span>
<span class="sd">        international_monoclinic (bool): Whether to use international</span>
<span class="sd">            convention (vs Curtarolo) for monoclinic. Defaults True.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The symmetrized structure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sym_finder</span> <span class="o">=</span> <span class="n">SpacegroupAnalyzer</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">symprec</span><span class="o">=</span><span class="n">sym_prec</span><span class="p">)</span>
    <span class="n">new_structure</span> <span class="o">=</span> <span class="n">sym_finder</span><span class="o">.</span><span class="n">get_primitive_standard_structure</span><span class="p">(</span><span class="n">international_monoclinic</span><span class="o">=</span><span class="n">international_monoclinic</span><span class="p">)</span>

    <span class="c1"># The primitive structure finding has had several bugs in the past</span>
    <span class="c1"># defend through validation</span>
    <span class="n">vpa_old</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">volume</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
    <span class="n">vpa_new</span> <span class="o">=</span> <span class="n">new_structure</span><span class="o">.</span><span class="n">volume</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_structure</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">vpa_old</span> <span class="o">-</span> <span class="n">vpa_new</span><span class="p">)</span> <span class="o">/</span> <span class="n">vpa_old</span> <span class="o">&gt;</span> <span class="mf">0.02</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Standardizing cell failed! VPA old: </span><span class="si">{</span><span class="n">vpa_old</span><span class="si">}</span><span class="s2">, VPA new: </span><span class="si">{</span><span class="n">vpa_new</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">matcher</span> <span class="o">=</span> <span class="n">StructureMatcher</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">matcher</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">new_structure</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Standardizing cell failed! Old structure doesn&#39;t match new.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_structure</span></div>



<div class="viewcode-block" id="BadInputSetWarning">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.BadInputSetWarning">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BadInputSetWarning</span><span class="p">(</span><span class="ne">UserWarning</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Warning class for bad but legal VASP inputs.&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="batch_write_input">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.batch_write_input">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">batch_write_input</span><span class="p">(</span>
    <span class="n">structures</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Structure</span><span class="p">],</span>
    <span class="n">vasp_input_set</span><span class="o">=</span><span class="n">MPRelaxSet</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="n">PathLike</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span>
    <span class="n">make_dir_if_not_present</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">subfolder</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sanitize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">include_cif</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">potcar_spec</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">zip_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Batch write VASP input for a sequence of structures to</span>
<span class="sd">    output_dir, following the format output_dir/{group}/{formula}_{number}.</span>

<span class="sd">    Args:</span>
<span class="sd">        structures ([Structure]): Sequence of Structures.</span>
<span class="sd">        vasp_input_set (VaspInputSet): VaspInputSet class that creates</span>
<span class="sd">            VASP input files from structures. Note that a class should be</span>
<span class="sd">            supplied. Defaults to MPRelaxSet.</span>
<span class="sd">        output_dir (str): Directory to output files. Defaults to current</span>
<span class="sd">            directory &quot;.&quot;.</span>
<span class="sd">        make_dir_if_not_present (bool): Create the directory if not present.</span>
<span class="sd">            Defaults to True.</span>
<span class="sd">        subfolder (callable): Function to create subdirectory name from</span>
<span class="sd">            structure. Defaults to simply &quot;formula_count&quot;.</span>
<span class="sd">        sanitize (bool): Boolean indicating whether to sanitize the</span>
<span class="sd">            structure before writing the VASP input files. Sanitized output</span>
<span class="sd">            are generally easier for viewing and certain forms of analysis.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        include_cif (bool): Whether to output a CIF as well. CIF files are</span>
<span class="sd">            generally better supported in visualization programs.</span>
<span class="sd">        potcar_spec (bool): Instead of writing the POTCAR, write a &quot;POTCAR.spec&quot;.</span>
<span class="sd">                This is intended to help sharing an input set with people who might</span>
<span class="sd">                not have a license to specific Potcar files. Given a &quot;POTCAR.spec&quot;,</span>
<span class="sd">                the specific POTCAR file can be re-generated using pymatgen with the</span>
<span class="sd">                &quot;generate_potcar&quot; function in the pymatgen CLI.</span>
<span class="sd">        zip_output (bool): If True, output will be zipped into a file with the</span>
<span class="sd">            same name as the InputSet (e.g., MPStaticSet.zip)</span>
<span class="sd">        **kwargs: Additional kwargs are passed to the vasp_input_set class</span>
<span class="sd">            in addition to structure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">site</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">structures</span><span class="p">):</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">site</span><span class="o">.</span><span class="n">formula</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">subfolder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subdir</span> <span class="o">=</span> <span class="n">subfolder</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="n">subdir</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">formula</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">sanitize</span><span class="p">:</span>
            <span class="n">site</span> <span class="o">=</span> <span class="n">site</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">sanitize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">vasp_input_set</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">v</span><span class="o">.</span><span class="n">write_input</span><span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">),</span>
            <span class="n">make_dir_if_not_present</span><span class="o">=</span><span class="n">make_dir_if_not_present</span><span class="p">,</span>
            <span class="n">include_cif</span><span class="o">=</span><span class="n">include_cif</span><span class="p">,</span>
            <span class="n">potcar_spec</span><span class="o">=</span><span class="n">potcar_spec</span><span class="p">,</span>
            <span class="n">zip_output</span><span class="o">=</span><span class="n">zip_output</span><span class="p">,</span>
        <span class="p">)</span></div>



<span class="n">_dummy_structure</span> <span class="o">=</span> <span class="n">Structure</span><span class="p">(</span>
    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;I&quot;</span><span class="p">],</span>
    <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
    <span class="n">site_properties</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;magmom&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]},</span>
<span class="p">)</span>


<div class="viewcode-block" id="get_valid_magmom_struct">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.get_valid_magmom_struct">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_valid_magmom_struct</span><span class="p">(</span>
    <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">,</span>
    <span class="n">inplace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">spin_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Structure</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make sure that the structure has valid magmoms based on the kind of calculation.</span>

<span class="sd">    Fill in missing Magmom values.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure: The input structure</span>
<span class="sd">        inplace: True: edit magmoms of the input structure; False: return new structure</span>
<span class="sd">        spin_mode: &quot;scalar&quot;/&quot;vector&quot;/&quot;none&quot;/&quot;auto&quot; only first letter (s/v/n) is needed.</span>
<span class="sd">            dictates how the spin configuration will be determined.</span>

<span class="sd">            - auto: read the existing magmom values and decide</span>
<span class="sd">            - scalar: use a single scalar value (for spin up/down)</span>
<span class="sd">            - vector: use a vector value for spin-orbit systems</span>
<span class="sd">            - none: Remove all the magmom information</span>

<span class="sd">    Returns:</span>
<span class="sd">        New structure if inplace is False</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">default_values</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">spin_mode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;n&quot;</span>
        <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">structure</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;magmom&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">site</span><span class="o">.</span><span class="n">properties</span> <span class="ow">or</span> <span class="n">site</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;magmom&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;magmom&quot;</span><span class="p">],</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;v&quot;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Magmom type conflict&quot;</span><span class="p">)</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;s&quot;</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;magmom&quot;</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">site</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;magmom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;magmom&quot;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;magmom&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Magmom type conflict&quot;</span><span class="p">)</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;v&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Unrecognized Magmom Value&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">spin_mode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="n">ret_struct</span> <span class="o">=</span> <span class="n">structure</span> <span class="k">if</span> <span class="n">inplace</span> <span class="k">else</span> <span class="n">structure</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">ret_struct</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;n&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;magmom&quot;</span> <span class="ow">in</span> <span class="n">site</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
                <span class="n">site</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;magmom&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;magmom&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">site</span><span class="o">.</span><span class="n">properties</span> <span class="ow">or</span> <span class="n">site</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;magmom&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">site</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;magmom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_values</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">ret_struct</span></div>



<div class="viewcode-block" id="MPAbsorptionSet">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.MPAbsorptionSet">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MPAbsorptionSet</span><span class="p">(</span><span class="n">VaspInputSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    MP input set for generating frequency dependent dielectrics.</span>

<span class="sd">    Two modes are supported: &quot;IPA&quot; or &quot;RPA&quot;.</span>
<span class="sd">    A typical sequence is mode=&quot;STATIC&quot; -&gt; mode=&quot;IPA&quot; -&gt; mode=&quot;RPA&quot;(optional)</span>
<span class="sd">    For all steps other than the first one (static), the</span>
<span class="sd">    recommendation is to use from_prev_calculation on the preceding run in</span>
<span class="sd">    the series. It is important to ensure Gamma centred kpoints for the RPA step.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure (Structure): Input structure.</span>
<span class="sd">        mode (str): Supported modes are &quot;IPA&quot;, &quot;RPA&quot;</span>
<span class="sd">        copy_wavecar (bool): Whether to copy the WAVECAR from a previous run.</span>
<span class="sd">            Defaults to True.</span>
<span class="sd">        nbands (int): For subsequent calculations, it is generally</span>
<span class="sd">            recommended to perform NBANDS convergence starting from the</span>
<span class="sd">            NBANDS of the previous run for DIAG, and to use the exact same</span>
<span class="sd">            NBANDS for RPA. This parameter is used by</span>
<span class="sd">            from_previous_calculation to set nband.</span>
<span class="sd">        nbands_factor (int): Multiplicative factor for NBANDS when starting</span>
<span class="sd">            from a previous calculation. Only applies if mode==&quot;IPA&quot;.</span>
<span class="sd">            Need to be tested for convergence.</span>
<span class="sd">        reciprocal_density: the k-points density</span>
<span class="sd">        nkred: the reduced number of kpoints to calculate, equal to the k-mesh.</span>
<span class="sd">            Only applies in &quot;RPA&quot; mode because of the q-&gt;0 limit.</span>
<span class="sd">        nedos: the density of DOS, default: 2001.</span>
<span class="sd">        **kwargs: All kwargs supported by VaspInputSet. Typically, user_incar_settings is a</span>
<span class="sd">            commonly used option.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># CONFIG = _load_yaml_config(&quot;MPAbsorptionSet&quot;)</span>

    <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;IPA&quot;</span>
    <span class="n">copy_wavecar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">nbands_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">reciprocal_density</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">400</span>
    <span class="n">nkred</span><span class="p">:</span> <span class="n">Tuple3Ints</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">nedos</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2001</span>
    <span class="n">inherit_incar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">force_gamma</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">MPRelaxSet</span><span class="o">.</span><span class="n">CONFIG</span>
    <span class="n">nbands</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">SUPPORTED_MODES</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;IPA&quot;</span><span class="p">,</span> <span class="s2">&quot;RPA&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate settings.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">SUPPORTED_MODES</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="si">}</span><span class="s2"> not one of the support modes : </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">SUPPORTED_MODES</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">kpoints_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the kpoints configuration for this calculation type.</span>

<span class="sd">        Generate gamma center k-points mesh grid for optical calculation. It is not</span>
<span class="sd">        mandatory for &#39;ALGO = Exact&#39;, but is requested by &#39;ALGO = CHI&#39; calculation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;reciprocal_density&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reciprocal_density</span><span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">incar_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates to the INCAR config for this calculation type.&quot;&quot;&quot;</span>
        <span class="n">updates</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;ALGO&quot;</span><span class="p">:</span> <span class="s2">&quot;Exact&quot;</span><span class="p">,</span>
            <span class="s2">&quot;EDIFF&quot;</span><span class="p">:</span> <span class="mf">1e-8</span><span class="p">,</span>
            <span class="s2">&quot;IBRION&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;ICHARG&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;ISMEAR&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;SIGMA&quot;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
            <span class="s2">&quot;LWAVE&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;LREAL&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># for small cell it&#39;s more efficient to use reciprocal</span>
            <span class="s2">&quot;NELM&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s2">&quot;NSW&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;LOPTICS&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;CSHIFT&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="s2">&quot;NEDOS&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nedos</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;RPA&quot;</span><span class="p">:</span>
            <span class="c1"># Default parameters for the response function calculation. NELM has to be</span>
            <span class="c1"># set to 1. NOMEGA is set to 1000 in order to get smooth spectrum</span>
            <span class="n">updates</span> <span class="o">|=</span> <span class="p">{</span>
                <span class="s2">&quot;ALGO&quot;</span><span class="p">:</span> <span class="s2">&quot;CHI&quot;</span><span class="p">,</span>
                <span class="s2">&quot;NELM&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;NOMEGA&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
                <span class="s2">&quot;EDIFF&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;LOPTICS&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;LWAVE&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_vasprun</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;IPA&quot;</span><span class="p">:</span>
            <span class="n">prev_nbands</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_vasprun</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;NBANDS&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbands</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbands</span>
            <span class="n">updates</span><span class="p">[</span><span class="s2">&quot;NBANDS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">prev_nbands</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbands_factor</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_vasprun</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;RPA&quot;</span><span class="p">:</span>
            <span class="c1"># Since in the optical calculation, only the q-&gt;0 transition is of interest,</span>
            <span class="c1"># we can reduce the number of q by the factor of the number of kpoints in</span>
            <span class="c1"># each corresponding x, y, z directions. This will reduce the computational</span>
            <span class="c1"># work by factor of 1/nkredx*nkredy*nkredz. An isotropic NKRED can be used</span>
            <span class="c1"># for cubic lattices, but using NKREDX, NKREDY, NKREDZ are more sensible for</span>
            <span class="c1"># other lattices.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nkred</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">cast</span><span class="p">(</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_vasprun</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">kpts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkred</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkred</span>
            <span class="p">)</span>
            <span class="n">updates</span> <span class="o">|=</span> <span class="p">{</span>
                <span class="s2">&quot;NKREDX&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkred</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;NKREDY&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkred</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="s2">&quot;NKREDZ&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkred</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="n">updates</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_get_ispin</span><span class="p">(</span><span class="n">vasprun</span><span class="p">:</span> <span class="n">Vasprun</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">outcar</span><span class="p">:</span> <span class="n">Outcar</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Literal</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get value of ISPIN depending on the magnetisation in the OUTCAR and vasprun.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">outcar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">outcar</span><span class="o">.</span><span class="n">magnetization</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Turn off spin when magmom for every site is smaller than 0.02.</span>
        <span class="n">site_magmom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="s2">&quot;tot&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outcar</span><span class="o">.</span><span class="n">magnetization</span><span class="p">])</span>
        <span class="k">return</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">site_magmom</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.02</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">vasprun</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">vasprun</span><span class="o">.</span><span class="n">is_spin</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="mi">2</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_recommended_lreal</span><span class="p">(</span><span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;Auto&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get recommended LREAL flag based on the structure.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;Auto&quot;</span> <span class="k">if</span> <span class="n">structure</span><span class="o">.</span><span class="n">num_sites</span> <span class="o">&gt;</span> <span class="mi">16</span> <span class="k">else</span> <span class="kc">False</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_combine_kpoints</span><span class="p">(</span><span class="o">*</span><span class="n">kpoints_objects</span><span class="p">:</span> <span class="n">Kpoints</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Kpoints</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Combine multiple Kpoints objects.&quot;&quot;&quot;</span>
    <span class="n">_labels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_kpoints</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Kpoint</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_weights</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">kpoints_object</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">kpoints_objects</span><span class="p">):</span>  <span class="c1"># type: ignore[var-annotated]</span>
        <span class="k">if</span> <span class="n">kpoints_object</span><span class="o">.</span><span class="n">style</span> <span class="o">!=</span> <span class="n">Kpoints</span><span class="o">.</span><span class="n">supported_modes</span><span class="o">.</span><span class="n">Reciprocal</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Can only combine kpoints with style=Kpoints.supported_modes.Reciprocal&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kpoints_object</span><span class="o">.</span><span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_labels</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">kpoints_object</span><span class="o">.</span><span class="n">kpts</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kpoints_object</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>

        <span class="n">_kpoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kpoints_object</span><span class="o">.</span><span class="n">kpts</span><span class="p">)</span>
        <span class="n">_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kpoints_object</span><span class="o">.</span><span class="n">kpts_weights</span><span class="p">)</span>

    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">_labels</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">kpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">_kpoints</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">_weights</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">Kpoints</span><span class="p">(</span>
        <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;Combined k-points&quot;</span><span class="p">,</span>
        <span class="n">style</span><span class="o">=</span><span class="n">Kpoints</span><span class="o">.</span><span class="n">supported_modes</span><span class="o">.</span><span class="n">Reciprocal</span><span class="p">,</span>
        <span class="n">num_kpts</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">kpoints</span><span class="p">),</span>
        <span class="n">kpts</span><span class="o">=</span><span class="n">cast</span><span class="p">(</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Kpoint</span><span class="p">],</span> <span class="n">kpoints</span><span class="p">),</span>
        <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
        <span class="n">kpts_weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_apply_incar_updates</span><span class="p">(</span><span class="n">incar</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="n">Incar</span><span class="p">,</span> <span class="n">updates</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">skip</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">())</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply updates to an INCAR file.</span>

<span class="sd">    Args:</span>
<span class="sd">        incar (Incar): An incar.</span>
<span class="sd">        updates (dict): Updates to apply.</span>
<span class="sd">        skip (list of str): Keys to skip.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">updates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">skip</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">incar</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">incar</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_remove_unused_incar_params</span><span class="p">(</span><span class="n">incar</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="n">Incar</span><span class="p">,</span> <span class="n">skip</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">())</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove INCAR parameters that are not actively used by VASP.</span>

<span class="sd">    Args:</span>
<span class="sd">        incar (Incar): An incar.</span>
<span class="sd">        skip (list of str): Keys to skip.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Turn off IBRION/ISIF/POTIM if NSW = 0</span>
    <span class="k">if</span> <span class="n">incar</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NSW&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">opt_flags</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;EDIFFG&quot;</span><span class="p">,</span> <span class="s2">&quot;IBRION&quot;</span><span class="p">,</span> <span class="s2">&quot;ISIF&quot;</span><span class="p">,</span> <span class="s2">&quot;POTIM&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">opt_flag</span> <span class="ow">in</span> <span class="n">opt_flags</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">opt_flag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skip</span><span class="p">:</span>
                <span class="n">incar</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">opt_flag</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Remove MAGMOM if they aren&#39;t used</span>
    <span class="k">if</span> <span class="n">incar</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ISPIN&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s2">&quot;MAGMOM&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skip</span><span class="p">:</span>
        <span class="n">incar</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;MAGMOM&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Turn off +U flags if +U is not even used</span>
    <span class="k">if</span> <span class="n">incar</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LDAU&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">ldau_flags</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;LDAUU&quot;</span><span class="p">,</span> <span class="s2">&quot;LDAUJ&quot;</span><span class="p">,</span> <span class="s2">&quot;LDAUL&quot;</span><span class="p">,</span> <span class="s2">&quot;LDAUTYPE&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ldau_flag</span> <span class="ow">in</span> <span class="n">ldau_flags</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ldau_flag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skip</span><span class="p">:</span>
                <span class="n">incar</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ldau_flag</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_nedos</span><span class="p">(</span><span class="n">vasprun</span><span class="p">:</span> <span class="n">Vasprun</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dedos</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get NEDOS using the energy range and the energy step,</span>
<span class="sd">    defaults to 2000.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">vasprun</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">2000</span>

    <span class="k">if</span> <span class="n">vasprun</span><span class="o">.</span><span class="n">eigenvalues</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;eigenvalues cannot be None.&quot;</span><span class="p">)</span>

    <span class="n">emax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">eigs</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">for</span> <span class="n">eigs</span> <span class="ow">in</span> <span class="n">vasprun</span><span class="o">.</span><span class="n">eigenvalues</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">emin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">eigs</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="k">for</span> <span class="n">eigs</span> <span class="ow">in</span> <span class="n">vasprun</span><span class="o">.</span><span class="n">eigenvalues</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">((</span><span class="n">emax</span> <span class="o">-</span> <span class="n">emin</span><span class="p">)</span> <span class="o">/</span> <span class="n">dedos</span><span class="p">)</span>


<div class="viewcode-block" id="auto_kspacing">
<a class="viewcode-back" href="../../../../pymatgen.io.vasp.html#pymatgen.io.vasp.sets.auto_kspacing">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">auto_kspacing</span><span class="p">(</span><span class="n">bandgap</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">bandgap_tol</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set kspacing based on the bandgap.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">bandgap</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">bandgap</span> <span class="o">&lt;=</span> <span class="n">bandgap_tol</span><span class="p">:</span>  <span class="c1"># metallic</span>
        <span class="k">return</span> <span class="mf">0.22</span>

    <span class="n">rmin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">25.22</span> <span class="o">-</span> <span class="mf">2.87</span> <span class="o">*</span> <span class="n">bandgap</span><span class="p">)</span>  <span class="c1"># Eq. 25</span>
    <span class="n">kspacing</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mf">1.0265</span> <span class="o">/</span> <span class="p">(</span><span class="n">rmin</span> <span class="o">-</span> <span class="mf">1.0183</span><span class="p">)</span>  <span class="c1"># Eq. 29</span>

    <span class="c1"># Cap kspacing at a max of 0.44, per internal benchmarking</span>
    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">kspacing</span><span class="p">,</span> <span class="mf">0.44</span><span class="p">)</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">pymatgen 2025.1.24 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">pymatgen.io.vasp.sets</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2011, Pymatgen Development Team.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    </div>
  </body>
</html>