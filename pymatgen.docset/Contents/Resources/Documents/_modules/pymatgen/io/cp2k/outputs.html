
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pymatgen.io.cp2k.outputs &#8212; pymatgen 2022.4.19 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/basic.css" />
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
 
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-33990148-1']);
  _gaq.push(['_trackPageview']);
</script>

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">pymatgen 2022.4.19 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">pymatgen.io.cp2k.outputs</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <h1>Source code for pymatgen.io.cp2k.outputs</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) Pymatgen Development Team.</span>
<span class="c1"># Distributed under the terms of the MIT License.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module defines the Cp2k output parser along with a few other functions for parsing cp2k-related</span>
<span class="sd">outputs.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">monty.io</span> <span class="kn">import</span> <span class="n">zopen</span>
<span class="kn">from</span> <span class="nn">monty.json</span> <span class="kn">import</span> <span class="n">MSONable</span><span class="p">,</span> <span class="n">jsanitize</span>
<span class="kn">from</span> <span class="nn">monty.re</span> <span class="kn">import</span> <span class="n">regrep</span>

<span class="kn">from</span> <span class="nn">pymatgen.core.structure</span> <span class="kn">import</span> <span class="n">Molecule</span><span class="p">,</span> <span class="n">Structure</span>
<span class="kn">from</span> <span class="nn">pymatgen.core.units</span> <span class="kn">import</span> <span class="n">Ha_to_eV</span>
<span class="kn">from</span> <span class="nn">pymatgen.electronic_structure.core</span> <span class="kn">import</span> <span class="n">Orbital</span><span class="p">,</span> <span class="n">Spin</span>
<span class="kn">from</span> <span class="nn">pymatgen.electronic_structure.dos</span> <span class="kn">import</span> <span class="n">CompleteDos</span><span class="p">,</span> <span class="n">Dos</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.cp2k.sets</span> <span class="kn">import</span> <span class="n">Cp2kInput</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.cp2k.utils</span> <span class="kn">import</span> <span class="n">_postprocessor</span><span class="p">,</span> <span class="n">natural_keys</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.xyz</span> <span class="kn">import</span> <span class="n">XYZ</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Nicholas Winner&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;1.0&quot;</span>
<span class="n">__status__</span> <span class="o">=</span> <span class="s2">&quot;Production&quot;</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="Cp2kOutput"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.Cp2kOutput">[docs]</a><span class="k">class</span> <span class="nc">Cp2kOutput</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for parsing output file from CP2K. The CP2K output file is very flexible in the way that it is returned.</span>
<span class="sd">    This class will automatically parse parameters that should always be present, but other parsing features may be</span>
<span class="sd">    called depending on the run type.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">auto_load</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the Cp2kOutput object.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename: (str) Name of the CP2K output file to parse</span>
<span class="sd">            verbose: (bool) Whether or not to parse with verbosity (will parse lots of data that may not be useful)</span>
<span class="sd">            auto_load (bool): Whether or not to automatically load basic info like energies and structures.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># IO Info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse_files</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Material properties/results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_structure</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lattice</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_structure</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composition</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">efermi</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vbm</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cbm</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">band_gap</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">structures</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ionic_steps</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># parse the basic run parameters always</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse_cp2k_params</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse_input</span><span class="p">()</span>  <span class="c1"># parse the input file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse_global_params</span><span class="p">()</span>  <span class="c1"># Always present, parse the global parameters, most important is what run type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse_atomic_kind_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse_dft_params</span><span class="p">()</span>  <span class="c1"># Present so long as a DFT calculation was performed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse_scf_params</span><span class="p">()</span>

        <span class="c1"># Auto-load will load the most crucial data into the data attribute</span>
        <span class="k">if</span> <span class="n">auto_load</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ran_successfully</span><span class="p">()</span>  <span class="c1"># Only if job completed. No info about convergence etc.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">convergence</span><span class="p">()</span>  <span class="c1"># Checks to see if job converged</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">parse_structures</span><span class="p">()</span>  <span class="c1"># collect all structures from the run</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_energies</span><span class="p">()</span>  <span class="c1"># get total energy for each ionic step</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_forces</span><span class="p">()</span>  <span class="c1"># get forces on all atoms (in order), if available</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_stresses</span><span class="p">()</span>  <span class="c1"># get stress tensor and total stress at each ionic step, if available</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_ionic_steps</span><span class="p">()</span>  <span class="c1"># collect energy, forces, and total stress into ionic steps variable</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">parse_dos</span><span class="p">()</span>  <span class="c1"># Get dos and use to find gap, CBM, and VBM</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_gap</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">vbm</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbm</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parse_mo_eigenvalues</span><span class="p">()</span>  <span class="c1"># Get the eigenvalues of the MOs</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parse_homo_lumo</span><span class="p">()</span>  <span class="c1"># Get the HOMO LUMO gap as printed after the mo eigenvalues (for OT only)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_timing</span><span class="p">()</span>  <span class="c1"># Get timing info (includes total CPU time consumed, but also much more)</span>

            <span class="c1"># TODO: Is this the best way to implement? Should there just be the option to select each individually?</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parse_scf_opt</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parse_opt_steps</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parse_total_numbers</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parse_mulliken</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parse_hirshfeld</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cp2k_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The cp2k version used in the calculation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cp2k_version&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">completed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Did the calculation complete</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;completed&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">c</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_warnings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        How many warnings showed up during the run</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_warnings&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">run_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        What type of run (Energy, MD, etc.) was performed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;global&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Run_type&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">calculation_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the calculation type (what io.vasp.outputs calls run_type)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LDA_TYPES</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;LDA&quot;</span><span class="p">,</span> <span class="s2">&quot;PADE&quot;</span><span class="p">,</span> <span class="s2">&quot;BECKE88&quot;</span><span class="p">,</span> <span class="s2">&quot;BECKE88_LR&quot;</span><span class="p">,</span> <span class="s2">&quot;BECKE88_LR_ADIABATIC&quot;</span><span class="p">,</span> <span class="s2">&quot;BECKE97&quot;</span><span class="p">}</span>

        <span class="n">GGA_TYPES</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;PBE&quot;</span><span class="p">,</span> <span class="s2">&quot;PW92&quot;</span><span class="p">}</span>

        <span class="n">HYBRID_TYPES</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;BLYP&quot;</span><span class="p">,</span> <span class="s2">&quot;B3LYP&quot;</span><span class="p">}</span>

        <span class="n">METAGGA_TYPES</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;TPSS&quot;</span><span class="p">:</span> <span class="s2">&quot;TPSS&quot;</span><span class="p">,</span>
            <span class="s2">&quot;RTPSS&quot;</span><span class="p">:</span> <span class="s2">&quot;revTPSS&quot;</span><span class="p">,</span>
            <span class="s2">&quot;M06L&quot;</span><span class="p">:</span> <span class="s2">&quot;M06-L&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MBJ&quot;</span><span class="p">:</span> <span class="s2">&quot;modified Becke-Johnson&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SCAN&quot;</span><span class="p">:</span> <span class="s2">&quot;SCAN&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MS0&quot;</span><span class="p">:</span> <span class="s2">&quot;MadeSimple0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MS1&quot;</span><span class="p">:</span> <span class="s2">&quot;MadeSimple1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MS2&quot;</span><span class="p">:</span> <span class="s2">&quot;MadeSimple2&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">functional</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dft&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;functional&quot;</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">])</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dft&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hfx&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Interaction_Potential&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">frac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dft&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hfx&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;FRACTION&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">functional</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">rt</span> <span class="o">=</span> <span class="s2">&quot;Mixed: &quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">functional</span><span class="p">)</span>
            <span class="n">functional</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">functional</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">functional</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s2">&quot;HYB&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ip</span> <span class="ow">and</span> <span class="n">frac</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">functional</span> <span class="ow">in</span> <span class="n">HYBRID_TYPES</span><span class="p">):</span>
                <span class="n">rt</span> <span class="o">=</span> <span class="s2">&quot;Hybrid&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">functional</span> <span class="o">=</span> <span class="n">functional</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">functional</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rt</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
            <span class="k">elif</span> <span class="n">functional</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s2">&quot;HYB&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ip</span> <span class="ow">and</span> <span class="n">frac</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">functional</span><span class="p">)</span> <span class="ow">in</span> <span class="n">HYBRID_TYPES</span><span class="p">:</span>
                <span class="n">rt</span> <span class="o">=</span> <span class="s2">&quot;Hybrid&quot;</span>
            <span class="k">elif</span> <span class="n">functional</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s2">&quot;MGGA&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">functional</span> <span class="ow">in</span> <span class="n">METAGGA_TYPES</span><span class="p">:</span>
                <span class="n">rt</span> <span class="o">=</span> <span class="s2">&quot;METAGGA&quot;</span>
            <span class="k">elif</span> <span class="n">functional</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s2">&quot;GGA&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">functional</span> <span class="ow">in</span> <span class="n">GGA_TYPES</span><span class="p">:</span>
                <span class="n">rt</span> <span class="o">=</span> <span class="s2">&quot;GGA&quot;</span>
            <span class="k">elif</span> <span class="n">functional</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s2">&quot;LDA&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">functional</span> <span class="ow">in</span> <span class="n">LDA_TYPES</span><span class="p">:</span>
                <span class="n">rt</span> <span class="o">=</span> <span class="s2">&quot;LDA&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rt</span> <span class="o">=</span> <span class="s2">&quot;Unknown&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_hubbard</span><span class="p">:</span>
            <span class="n">rt</span> <span class="o">+=</span> <span class="s2">&quot;+U&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dft&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vdw&quot;</span><span class="p">):</span>
            <span class="n">rt</span> <span class="o">+=</span> <span class="s2">&quot;+VDW&quot;</span>

        <span class="k">return</span> <span class="n">rt</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">project_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        What project name was used for this calculation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;global&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project_name&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spin_polarized</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Was the calculation spin polarized</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;UKS&quot;</span> <span class="ow">or</span> <span class="s2">&quot;UNRESTRICTED_KOHN_SHAM&quot;</span> <span class="ow">or</span> <span class="s2">&quot;LSD&quot;</span> <span class="ow">or</span> <span class="s2">&quot;SPIN_POLARIZED&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;dft&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_molecule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True if the cp2k output was generated for a molecule (i.e.</span>
<span class="sd">        no periodicity in the cell). Returns false otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;poisson_periodicity&quot;</span><span class="p">,</span> <span class="p">[[</span><span class="s2">&quot;&quot;</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_metal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Was a band gap found? i.e. is it a metal</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_gap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_gap</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_hubbard</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns True if hubbard +U correction was used</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;atomic_kind_info&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;DFT_PLUS_U&quot;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DFT_PLUS_U&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;U_MINUS_J&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="Cp2kOutput.parse_files"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.Cp2kOutput.parse_files">[docs]</a>    <span class="k">def</span> <span class="nf">parse_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Identify files present in the directory with the cp2k output file. Looks for trajectories, dos, and cubes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pdos</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="s2">&quot;*pdos*&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="s2">&quot;PDOS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="s2">&quot;LDOS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pdos</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s2">&quot;list&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="s2">&quot;LDOS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="s2">&quot;PDOS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="s2">&quot;trajectory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="s2">&quot;*pos*.xyz*&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="s2">&quot;forces&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="s2">&quot;*frc*.xyz*&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="s2">&quot;stress&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="s2">&quot;*stress*&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="s2">&quot;*.cell*&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="s2">&quot;electron_density&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="s2">&quot;*ELECTRON_DENSITY*.cube*&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="s2">&quot;spin_density&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="s2">&quot;*SPIN_DENSITY*.cube*&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="s2">&quot;v_hartree&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="s2">&quot;*hartree*.cube*&quot;</span><span class="p">))</span>
        <span class="n">restart</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="s2">&quot;*restart*&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="s2">&quot;restart.bak&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="s2">&quot;restart&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">restart</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s2">&quot;bak&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="s2">&quot;restart.bak&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="s2">&quot;restart&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

        <span class="n">wfn</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="s2">&quot;*.wfn*&quot;</span><span class="p">))</span> <span class="o">+</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="s2">&quot;*.kp*&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="s2">&quot;wfn.bak&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">wfn</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s2">&quot;bak&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="s2">&quot;wfn.bak&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="s2">&quot;wfn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;sort&quot;</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">natural_keys</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cp2kOutput.parse_structures"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.Cp2kOutput.parse_structures">[docs]</a>    <span class="k">def</span> <span class="nf">parse_structures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectory_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lattice_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parses the structures from a cp2k calculation. Static calculations simply use the initial structure.</span>
<span class="sd">        For calculations with ionic motion, the function will look for the appropriate trajectory and lattice</span>
<span class="sd">        files based on naming convention. If no file is given, and no file is found, it is assumed</span>
<span class="sd">        that the lattice/structure remained constant, and the initial lattice/structure is used.</span>
<span class="sd">        Cp2k does not output the trajectory in the main output file by default, so non static calculations have to</span>
<span class="sd">        reference the trajectory file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse_initial_structure</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">lattice_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lattice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_cell_params</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">latfile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">lattice</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">latfile</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">latfile</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
                    <span class="k">else</span> <span class="p">[</span><span class="n">latfile</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;Unable to automatically determine lattice file. More than one exist.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">latfile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">lattice_file</span><span class="p">)</span>
            <span class="n">lattice</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">latfile</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">trajectory_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="s2">&quot;trajectory&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">structures</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_structure</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">final_structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="s2">&quot;trajectory&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">mols</span> <span class="o">=</span> <span class="n">XYZ</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="s2">&quot;trajectory&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">all_molecules</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">structures</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">gs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_structure</span><span class="o">.</span><span class="n">site_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ghost&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mols</span><span class="p">,</span> <span class="n">lattice</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">Structure</span><span class="p">(</span>
                            <span class="n">lattice</span><span class="o">=</span><span class="n">l</span><span class="p">,</span>
                            <span class="n">coords</span><span class="o">=</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">coords</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">sites</span><span class="p">],</span>
                            <span class="n">species</span><span class="o">=</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">specie</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">sites</span><span class="p">],</span>
                            <span class="n">coords_are_cartesian</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">site_properties</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ghost&quot;</span><span class="p">:</span> <span class="n">gs</span><span class="p">}</span> <span class="k">if</span> <span class="n">gs</span> <span class="k">else</span> <span class="p">{},</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">final_structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;Unable to automatically determine trajectory file. More than one exist.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mols</span> <span class="o">=</span> <span class="n">XYZ</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">trajectory_file</span><span class="p">)</span><span class="o">.</span><span class="n">all_molecules</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">structures</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_molecule</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mols</span><span class="p">,</span> <span class="n">lattice</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">Structure</span><span class="p">(</span>
                            <span class="n">lattice</span><span class="o">=</span><span class="n">l</span><span class="p">,</span>
                            <span class="n">coords</span><span class="o">=</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">coords</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">sites</span><span class="p">],</span>
                            <span class="n">species</span><span class="o">=</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">specie</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">sites</span><span class="p">],</span>
                            <span class="n">coords_are_cartesian</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">structures</span> <span class="o">=</span> <span class="n">mols</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">final_structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">final_structure</span><span class="o">.</span><span class="n">set_charge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_structure</span><span class="o">.</span><span class="n">charge</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cp2kOutput.parse_initial_structure"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.Cp2kOutput.parse_initial_structure">[docs]</a>    <span class="k">def</span> <span class="nf">parse_initial_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the initial structure from the main cp2k output file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;- Atoms:\s+(\d+)&quot;</span><span class="p">)</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;num_atoms&quot;</span><span class="p">:</span> <span class="n">pattern</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_pattern</span><span class="p">(</span>
            <span class="n">patterns</span><span class="o">=</span><span class="n">patterns</span><span class="p">,</span>
            <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">terminate_on_match</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">postprocess</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">coord_table</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="n">zopen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="k">if</span> <span class="s2">&quot;Atom  Kind  Element       X           Y           Z          Z(eff)       Mass&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;num_atoms&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="p">[]:</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                        <span class="n">coord_table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">break</span>

        <span class="n">lattice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_cell_params</span><span class="p">()</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;atomic_kind_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;atomic_kind_info&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;pseudo_potential&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;NONE&quot;</span><span class="p">:</span>
                <span class="n">gs</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;kind_number&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gs</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;kind_number&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coord_table</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;atomic_kind_info&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;kind_number&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">v</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;atomic_kind_list&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_molecule</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initial_structure</span> <span class="o">=</span> <span class="n">Molecule</span><span class="p">(</span>
                <span class="n">species</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">coord_table</span><span class="p">],</span>
                <span class="n">coords</span><span class="o">=</span><span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">6</span><span class="p">])]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">coord_table</span><span class="p">],</span>
                <span class="n">site_properties</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ghost&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">gs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">coord_table</span><span class="p">]},</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initial_structure</span> <span class="o">=</span> <span class="n">Structure</span><span class="p">(</span>
                <span class="n">lattice</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">species</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">coord_table</span><span class="p">],</span>
                <span class="n">coords</span><span class="o">=</span><span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">6</span><span class="p">])]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">coord_table</span><span class="p">],</span>
                <span class="n">coords_are_cartesian</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">site_properties</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ghost&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">gs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">coord_table</span><span class="p">]},</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initial_structure</span><span class="o">.</span><span class="n">set_charge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">][</span><span class="s2">&quot;DFT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CHARGE&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_structure</span><span class="o">.</span><span class="n">composition</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_structure</span></div>

<div class="viewcode-block" id="Cp2kOutput.ran_successfully"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.Cp2kOutput.ran_successfully">[docs]</a>    <span class="k">def</span> <span class="nf">ran_successfully</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sanity checks that the program ran successfully. Looks at the bottom of the CP2K output file</span>
<span class="sd">        for the &quot;PROGRAM ENDED&quot; line, which is printed when successfully ran. Also grabs the number</span>
<span class="sd">        of warnings issued.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">program_ended_at</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;PROGRAM ENDED AT\s+(\w+)&quot;</span><span class="p">)</span>
        <span class="n">num_warnings</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;The number of warnings for this run is : (\d+)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_pattern</span><span class="p">(</span>
            <span class="n">patterns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;completed&quot;</span><span class="p">:</span> <span class="n">program_ended_at</span><span class="p">},</span>
            <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">terminate_on_match</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">postprocess</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_pattern</span><span class="p">(</span>
            <span class="n">patterns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;num_warnings&quot;</span><span class="p">:</span> <span class="n">num_warnings</span><span class="p">},</span>
            <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">terminate_on_match</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">postprocess</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">completed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The provided CP2K job did not finish running! Cannot parse the file reliably.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cp2kOutput.convergence"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.Cp2kOutput.convergence">[docs]</a>    <span class="k">def</span> <span class="nf">convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether or not the SCF and geometry optimization cycles converged.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># SCF Loops</span>
        <span class="n">uncoverged_inner_loop</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(Leaving inner SCF loop)&quot;</span><span class="p">)</span>
        <span class="n">scf_converged</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(SCF run converged)|(SCF run NOT converged)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_pattern</span><span class="p">(</span>
            <span class="n">patterns</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;uncoverged_inner_loop&quot;</span><span class="p">:</span> <span class="n">uncoverged_inner_loop</span><span class="p">,</span>
                <span class="s2">&quot;scf_converged&quot;</span><span class="p">:</span> <span class="n">scf_converged</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">terminate_on_match</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">postprocess</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;scf_converged&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;scf_converged&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;scf_converged&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># GEO_OPT</span>
        <span class="n">geo_opt_not_converged</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(MAXIMUM NUMBER OF OPTIMIZATION STEPS REACHED)&quot;</span><span class="p">)</span>
        <span class="n">geo_opt_converged</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(GEOMETRY OPTIMIZATION COMPLETED)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_pattern</span><span class="p">(</span>
            <span class="n">patterns</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;geo_opt_converged&quot;</span><span class="p">:</span> <span class="n">geo_opt_converged</span><span class="p">,</span>
                <span class="s2">&quot;geo_opt_not_converged&quot;</span><span class="p">:</span> <span class="n">geo_opt_not_converged</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">terminate_on_match</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">postprocess</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;scf_converged&quot;</span><span class="p">]):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;There is at least one unconverged SCF cycle in the provided cp2k calculation&quot;</span><span class="p">,</span>
                <span class="ne">UserWarning</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;geo_opt_not_converged&quot;</span><span class="p">]):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Geometry optimization did not converge&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cp2kOutput.parse_energies"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.Cp2kOutput.parse_energies">[docs]</a>    <span class="k">def</span> <span class="nf">parse_energies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the total energy from a CP2K calculation. Presently, the energy reported in the trajectory (pos.xyz) file</span>
<span class="sd">        takes presidence over the energy reported in the main output file. This is because the trajectory file keeps</span>
<span class="sd">        track of energies in between restarts, while the main output file may or may not depending on whether</span>
<span class="sd">        a particular machine overwrites or appends it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;trajectory&quot;</span><span class="p">):</span>
            <span class="n">toten_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;.*E\s+\=\s+(-?\d+.\d+)&quot;</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="n">regrep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="s2">&quot;trajectory&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;total_energy&quot;</span><span class="p">:</span> <span class="n">toten_pattern</span><span class="p">},</span> <span class="n">postprocess</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;total_energy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">matches</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_energy&quot;</span><span class="p">,</span> <span class="p">[[]])],</span> <span class="n">Ha_to_eV</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">toten_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Total FORCE_EVAL.*\s(-?\d+.\d+)&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_pattern</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;total_energy&quot;</span><span class="p">:</span> <span class="n">toten_pattern</span><span class="p">},</span>
                <span class="n">terminate_on_match</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">postprocess</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;total_energy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_energy&quot;</span><span class="p">,</span> <span class="p">[]),</span> <span class="n">Ha_to_eV</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_energy&quot;</span><span class="p">,</span> <span class="p">[])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>

<div class="viewcode-block" id="Cp2kOutput.parse_forces"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.Cp2kOutput.parse_forces">[docs]</a>    <span class="k">def</span> <span class="nf">parse_forces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the forces from the output file</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="s2">&quot;forces&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;forces&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">step</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">XYZ</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="s2">&quot;forces&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">all_molecules</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">header_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;ATOMIC FORCES.+Z&quot;</span>
            <span class="n">row_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\s+\d+\s+\d+\s+\w+\s+(-?\d+\.\d+)\s+(-?\d+\.\d+)\s+(-?\d+\.\d+)&quot;</span>
            <span class="n">footer_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;SUM OF ATOMIC FORCES&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;forces&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_table_pattern</span><span class="p">(</span>
                <span class="n">header_pattern</span><span class="o">=</span><span class="n">header_pattern</span><span class="p">,</span>
                <span class="n">row_pattern</span><span class="o">=</span><span class="n">row_pattern</span><span class="p">,</span>
                <span class="n">footer_pattern</span><span class="o">=</span><span class="n">footer_pattern</span><span class="p">,</span>
                <span class="n">postprocess</span><span class="o">=</span><span class="n">_postprocessor</span><span class="p">,</span>
                <span class="n">last_one_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span></div>

    <span class="c1"># TODO stress file still parses correctly, but the other is not rigorously tested</span>
<div class="viewcode-block" id="Cp2kOutput.parse_stresses"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.Cp2kOutput.parse_stresses">[docs]</a>    <span class="k">def</span> <span class="nf">parse_stresses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the stresses from the output file.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="s2">&quot;stress&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="s2">&quot;stress&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">skip_header</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="p">[</span><span class="n">dat</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dat</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">dat</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;stress_tensor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">]),</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">]),</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">11</span><span class="p">])]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">header_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;STRESS\|\s+x\s+y\s+z&quot;</span>
            <span class="n">row_pattern</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">r</span><span class="s2">&quot;STRESS\|\s+[?:x|y|z]\s+(-?\d+\.\d+E?[-|\+]?\d+)\s+&quot;</span>
                <span class="sa">r</span><span class="s2">&quot;(-?\d+\.\d+E?[-|\+]?\d+)\s+(-?\d+\.\d+E?[-|\+]?\d+).*$&quot;</span>
            <span class="p">)</span>
            <span class="n">footer_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;^$&quot;</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_table_pattern</span><span class="p">(</span>
                <span class="n">header_pattern</span><span class="o">=</span><span class="n">header_pattern</span><span class="p">,</span>
                <span class="n">row_pattern</span><span class="o">=</span><span class="n">row_pattern</span><span class="p">,</span>
                <span class="n">footer_pattern</span><span class="o">=</span><span class="n">footer_pattern</span><span class="p">,</span>
                <span class="n">postprocess</span><span class="o">=</span><span class="n">_postprocessor</span><span class="p">,</span>
                <span class="n">last_one_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">def</span> <span class="nf">chunks</span><span class="p">(</span><span class="n">lst</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Yield successive n-sized chunks from lst.&quot;&quot;&quot;</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">),</span> <span class="n">n</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">lst</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">n</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;stress_tensor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chunks</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span></div>

<div class="viewcode-block" id="Cp2kOutput.parse_ionic_steps"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.Cp2kOutput.parse_ionic_steps">[docs]</a>    <span class="k">def</span> <span class="nf">parse_ionic_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the ionic step info. If already parsed, this will just assimilate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_structures</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_energy&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_energies</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;forces&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_forces</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stress_tensor&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_stresses</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ionic_steps</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;structure&quot;</span><span class="p">:</span> <span class="n">structure</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="n">energy</span><span class="p">,</span> <span class="s2">&quot;stress_tensor&quot;</span><span class="p">:</span> <span class="n">stress</span><span class="p">,</span> <span class="s2">&quot;forces&quot;</span><span class="p">:</span> <span class="n">forces</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">structure</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">stress</span><span class="p">,</span> <span class="n">forces</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_energy&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stress_tensor&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;forces&quot;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="p">)</span>
        <span class="p">]</span></div>

<div class="viewcode-block" id="Cp2kOutput.parse_cp2k_params"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.Cp2kOutput.parse_cp2k_params">[docs]</a>    <span class="k">def</span> <span class="nf">parse_cp2k_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the CP2K general parameters from CP2K output file into a dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+CP2K\|.+(\d\.\d)&quot;</span><span class="p">)</span>
        <span class="n">input_file</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+CP2K\|\s+Input file name\s+(.+)$&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_pattern</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;cp2k_version&quot;</span><span class="p">:</span> <span class="n">version</span><span class="p">,</span> <span class="s2">&quot;input_filename&quot;</span><span class="p">:</span> <span class="n">input_file</span><span class="p">},</span>
            <span class="n">terminate_on_match</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">postprocess</span><span class="o">=</span><span class="n">_postprocessor</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Cp2kOutput.parse_plus_u_params"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.Cp2kOutput.parse_plus_u_params">[docs]</a>    <span class="k">def</span> <span class="nf">parse_plus_u_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the DFT+U params</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+DFT\+U\|\s+Method\s+()$&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_pattern</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;dft_plus_u_method&quot;</span><span class="p">:</span> <span class="n">method</span><span class="p">},</span> <span class="n">terminate_on_match</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">postprocess</span><span class="o">=</span><span class="n">_postprocessor</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Cp2kOutput.parse_input"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.Cp2kOutput.parse_input">[docs]</a>    <span class="k">def</span> <span class="nf">parse_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load in the input set from the input file (if it can be found)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;input_filename&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">input_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;input_filename&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;.gz&quot;</span><span class="p">,</span> <span class="s2">&quot;.GZ&quot;</span><span class="p">,</span> <span class="s2">&quot;.z&quot;</span><span class="p">,</span> <span class="s2">&quot;.Z&quot;</span><span class="p">,</span> <span class="s2">&quot;.bz2&quot;</span><span class="p">,</span> <span class="s2">&quot;.BZ2&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">input_filename</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">Cp2kInput</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">input_filename</span> <span class="o">+</span> <span class="n">ext</span><span class="p">))</span>
                <span class="k">return</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Original input file not found. Some info may be lost.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cp2kOutput.parse_global_params"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.Cp2kOutput.parse_global_params">[docs]</a>    <span class="k">def</span> <span class="nf">parse_global_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the GLOBAL section parameters from CP2K output file into a dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+GLOBAL\|\s+([\w+\s]*)\s+(\w+)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_pattern</span><span class="p">({</span><span class="s2">&quot;global&quot;</span><span class="p">:</span> <span class="n">pat</span><span class="p">},</span> <span class="n">terminate_on_match</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;global&quot;</span><span class="p">]:</span>
            <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">_postprocessor</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;global&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;global&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="Cp2kOutput.parse_dft_params"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.Cp2kOutput.parse_dft_params">[docs]</a>    <span class="k">def</span> <span class="nf">parse_dft_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the DFT parameters (as well as functional, HF, vdW params)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+DFT\|\s+(\w.*)\s\s\s(.*)$&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_pattern</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;dft&quot;</span><span class="p">:</span> <span class="n">pat</span><span class="p">},</span>
            <span class="n">terminate_on_match</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">postprocess</span><span class="o">=</span><span class="n">_postprocessor</span><span class="p">,</span>
            <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;dft&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;dft&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;dft&quot;</span><span class="p">][</span><span class="s2">&quot;cutoffs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;dft&quot;</span><span class="p">][</span><span class="s2">&quot;cutoffs&quot;</span><span class="p">][</span><span class="s2">&quot;density&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;dft&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;Cutoffs:_density&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;dft&quot;</span><span class="p">][</span><span class="s2">&quot;cutoffs&quot;</span><span class="p">][</span><span class="s2">&quot;gradient&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;dft&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;gradient&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;dft&quot;</span><span class="p">][</span><span class="s2">&quot;cutoffs&quot;</span><span class="p">][</span><span class="s2">&quot;tau&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;dft&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;tau&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Functional</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s2">&quot;FORCE_EVAL/DFT/XC/XC_FUNCTIONAL&quot;</span><span class="p">):</span>
            <span class="n">xcfuncs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s2">&quot;force_eval&quot;</span><span class="p">][</span><span class="s2">&quot;dft&quot;</span><span class="p">][</span><span class="s2">&quot;xc&quot;</span><span class="p">][</span><span class="s2">&quot;xc_functional&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">subsections</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">xcfuncs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;dft&quot;</span><span class="p">][</span><span class="s2">&quot;functional&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xcfuncs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s2">&quot;force_eval&quot;</span><span class="p">][</span><span class="s2">&quot;dft&quot;</span><span class="p">][</span><span class="s2">&quot;xc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">subsections</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;XC_FUNCTIONAL&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;dft&quot;</span><span class="p">][</span><span class="s2">&quot;functional&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">section_parameters</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">functional</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+FUNCTIONAL\|\s+(.+):&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_pattern</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;functional&quot;</span><span class="p">:</span> <span class="n">functional</span><span class="p">},</span>
                <span class="n">terminate_on_match</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">postprocess</span><span class="o">=</span><span class="n">_postprocessor</span><span class="p">,</span>
                <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;dft&quot;</span><span class="p">][</span><span class="s2">&quot;functional&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;functional&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>

        <span class="c1"># DFT+U</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;dft&quot;</span><span class="p">][</span><span class="s2">&quot;dft_plus_u&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_hubbard</span>

        <span class="c1"># HF exchange info</span>
        <span class="n">hfx</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+HFX_INFO\|\s+(.+):\s+(.*)$&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_pattern</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;hfx&quot;</span><span class="p">:</span> <span class="n">hfx</span><span class="p">},</span>
            <span class="n">terminate_on_match</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">postprocess</span><span class="o">=</span><span class="n">_postprocessor</span><span class="p">,</span>
            <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;dft&quot;</span><span class="p">][</span><span class="s2">&quot;hfx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;hfx&quot;</span><span class="p">))</span>

        <span class="c1"># Van der waals correction</span>
        <span class="n">vdw</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+vdW POTENTIAL\|(.+)$&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_pattern</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;vdw&quot;</span><span class="p">:</span> <span class="n">vdw</span><span class="p">},</span>
            <span class="n">terminate_on_match</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">postprocess</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
            <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vdw&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;dft&quot;</span><span class="p">][</span><span class="s2">&quot;vdw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;vdw&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">poisson_periodic</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;poisson_periodicity&quot;</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;POISSON\| Periodicity\s+(\w+)&quot;</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_pattern</span><span class="p">(</span><span class="n">poisson_periodic</span><span class="p">,</span> <span class="n">terminate_on_match</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cp2kOutput.parse_qs_params"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.Cp2kOutput.parse_qs_params">[docs]</a>    <span class="k">def</span> <span class="nf">parse_qs_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the DFT parameters (as well as functional, HF, vdW params)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+QS\|\s+(\w.*)\s\s\s(.*)$&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_pattern</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;QS&quot;</span><span class="p">:</span> <span class="n">pat</span><span class="p">},</span>
            <span class="n">terminate_on_match</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">postprocess</span><span class="o">=</span><span class="n">_postprocessor</span><span class="p">,</span>
            <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;QS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;QS&quot;</span><span class="p">])</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;QS&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s2">&quot;grid_level&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s2">&quot;Number&quot;</span><span class="p">):</span>
                <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;QS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;QS&quot;</span><span class="p">][</span><span class="s2">&quot;Multi_grid_cutoffs_[a.u.]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span></div>

<div class="viewcode-block" id="Cp2kOutput.parse_overlap_condition"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.Cp2kOutput.parse_overlap_condition">[docs]</a>    <span class="k">def</span> <span class="nf">parse_overlap_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the overlap condition number</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">overlap_condition</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\|A\|\*\|A\^-1\|.+=\s+(-?\d+\.\d+E[+\-]?\d+)\s+Log&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_pattern</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;overlap_condition_number&quot;</span><span class="p">:</span> <span class="n">overlap_condition</span><span class="p">},</span>
            <span class="n">terminate_on_match</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">postprocess</span><span class="o">=</span><span class="n">_postprocessor</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Cp2kOutput.parse_scf_params"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.Cp2kOutput.parse_scf_params">[docs]</a>    <span class="k">def</span> <span class="nf">parse_scf_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the most import SCF parameters: the max number of scf cycles (max_scf),</span>
<span class="sd">        the convergence cutoff for scf (eps_scf),</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">max_scf</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;max_scf:\s+(\d+)&quot;</span><span class="p">)</span>
        <span class="n">eps_scf</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;eps_scf:\s+(\d+)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_pattern</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;max_scf&quot;</span><span class="p">:</span> <span class="n">max_scf</span><span class="p">,</span> <span class="s2">&quot;eps_scf&quot;</span><span class="p">:</span> <span class="n">eps_scf</span><span class="p">},</span>
            <span class="n">terminate_on_match</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;scf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;scf&quot;</span><span class="p">][</span><span class="s2">&quot;max_scf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;max_scf&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;max_scf&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;scf&quot;</span><span class="p">][</span><span class="s2">&quot;eps_scf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;eps_scf&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;eps_scf&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Cp2kOutput.parse_cell_params"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.Cp2kOutput.parse_cell_params">[docs]</a>    <span class="k">def</span> <span class="nf">parse_cell_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the lattice parameters (initial) from the output file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cell_volume</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+CELL\|\sVolume.*\s(\d+\.\d+)&quot;</span><span class="p">)</span>
        <span class="n">vectors</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+CELL\| Vector.*\s(-?\d+\.\d+)\s+(-?\d+\.\d+)\s+(-?\d+\.\d+)&quot;</span><span class="p">)</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+CELL\| Angle.*\s(\d+\.\d+)&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">read_pattern</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;cell_volume&quot;</span><span class="p">:</span> <span class="n">cell_volume</span><span class="p">,</span> <span class="s2">&quot;lattice&quot;</span><span class="p">:</span> <span class="n">vectors</span><span class="p">,</span> <span class="s2">&quot;angles&quot;</span><span class="p">:</span> <span class="n">angles</span><span class="p">},</span>
            <span class="n">terminate_on_match</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">postprocess</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
            <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;lattice&quot;</span><span class="p">])</span>
        <span class="n">lattices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">lattices</span></div>

<div class="viewcode-block" id="Cp2kOutput.parse_atomic_kind_info"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.Cp2kOutput.parse_atomic_kind_info">[docs]</a>    <span class="k">def</span> <span class="nf">parse_atomic_kind_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse info on what atomic kinds are present and what basis/pseudopotential is describing each of them.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kinds</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Atomic kind: (\w+)&quot;</span><span class="p">)</span>
        <span class="n">orbital_basis_set</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Orbital Basis Set\s+(.+$)&quot;</span><span class="p">)</span>
        <span class="n">potential_information</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?:Potential information for\s+(.+$))|(?:atomic kind are GHOST atoms)&quot;</span><span class="p">)</span>
        <span class="n">auxiliary_basis_set</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Auxiliary Fit Basis Set\s+(.+$)&quot;</span><span class="p">)</span>
        <span class="n">core_electrons</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Total number of core electrons\s+(\d+)&quot;</span><span class="p">)</span>
        <span class="n">valence_electrons</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Total number of valence electrons\s+(\d+)&quot;</span><span class="p">)</span>
        <span class="n">pseudo_energy</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Total Pseudopotential Energy.+(-?\d+.\d+)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_pattern</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;kinds&quot;</span><span class="p">:</span> <span class="n">kinds</span><span class="p">,</span>
                <span class="s2">&quot;orbital_basis_set&quot;</span><span class="p">:</span> <span class="n">orbital_basis_set</span><span class="p">,</span>
                <span class="s2">&quot;potential_info&quot;</span><span class="p">:</span> <span class="n">potential_information</span><span class="p">,</span>
                <span class="s2">&quot;auxiliary_basis_set&quot;</span><span class="p">:</span> <span class="n">auxiliary_basis_set</span><span class="p">,</span>
                <span class="s2">&quot;core_electrons&quot;</span><span class="p">:</span> <span class="n">core_electrons</span><span class="p">,</span>
                <span class="s2">&quot;valence_electrons&quot;</span><span class="p">:</span> <span class="n">valence_electrons</span><span class="p">,</span>
                <span class="s2">&quot;pseudo_energy&quot;</span><span class="p">:</span> <span class="n">pseudo_energy</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">terminate_on_match</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">postprocess</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
            <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">atomic_kind_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">_kinds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;kinds&quot;</span><span class="p">])):</span>
            <span class="k">if</span> <span class="n">_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_kinds</span><span class="p">:</span>
                <span class="n">_kinds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">kind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">_kinds</span><span class="p">):</span>
            <span class="n">atomic_kind_info</span><span class="p">[</span><span class="n">kind</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;orbital_basis_set&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;orbital_basis_set&quot;</span><span class="p">)[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;pseudo_potential&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;potential_info&quot;</span><span class="p">)[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;kind_number&quot;</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;valence_electrons&quot;</span><span class="p">):</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;valence_electrons&quot;</span><span class="p">)[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;potential_info&quot;</span><span class="p">)[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;NONE&quot;</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;potential_info&quot;</span><span class="p">)[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">atomic_kind_info</span><span class="p">[</span><span class="n">kind</span><span class="p">][</span><span class="s2">&quot;valence_electrons&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">atomic_kind_info</span><span class="p">[</span><span class="n">kind</span><span class="p">][</span><span class="s2">&quot;valence_electrons&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">atomic_kind_info</span><span class="p">[</span><span class="n">kind</span><span class="p">][</span><span class="s2">&quot;core_electrons&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;core_electrons&quot;</span><span class="p">)[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">atomic_kind_info</span><span class="p">[</span><span class="n">kind</span><span class="p">][</span><span class="s2">&quot;core_electrons&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">atomic_kind_info</span><span class="p">[</span><span class="n">kind</span><span class="p">][</span><span class="s2">&quot;auxiliary_basis_set&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;auxiliary_basis_set&quot;</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                <span class="n">atomic_kind_info</span><span class="p">[</span><span class="n">kind</span><span class="p">][</span><span class="s2">&quot;auxiliary_basis_set&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">atomic_kind_info</span><span class="p">[</span><span class="n">kind</span><span class="p">][</span><span class="s2">&quot;total_pseudopotential_energy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_pseudopotential_energy&quot;</span><span class="p">)[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">Ha_to_eV</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">atomic_kind_info</span><span class="p">[</span><span class="n">kind</span><span class="p">][</span><span class="s2">&quot;total_pseudopotential_energy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">with</span> <span class="n">zopen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s2">&quot;MOLECULE KIND INFORMATION&quot;</span><span class="p">):</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s2">&quot;Atomic kind&quot;</span><span class="p">):</span>
                    <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s2">&quot;DFT+U correction&quot;</span><span class="p">):</span>
                    <span class="n">atomic_kind_info</span><span class="p">[</span><span class="n">_kinds</span><span class="p">[</span><span class="n">j</span><span class="p">]][</span><span class="s2">&quot;DFT_PLUS_U&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;L&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                        <span class="s2">&quot;U_MINUS_J&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="p">}</span>
                <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;atomic_kind_info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomic_kind_info</span></div>

<div class="viewcode-block" id="Cp2kOutput.parse_total_numbers"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.Cp2kOutput.parse_total_numbers">[docs]</a>    <span class="k">def</span> <span class="nf">parse_total_numbers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse total numbers (not usually important)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">atomic_kinds</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;- Atomic kinds:\s+(\d+)&quot;</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;- Atoms:\s+(\d+)&quot;</span>
        <span class="n">shell_sets</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;- Shell sets:\s+(\d+)&quot;</span>
        <span class="n">shells</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;- Shells:\s+(\d+)&quot;</span>
        <span class="n">primitive_funcs</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;- Primitive Cartesian functions:\s+(\d+)&quot;</span>
        <span class="n">cart_base_funcs</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;- Cartesian basis functions:\s+(\d+)&quot;</span>
        <span class="n">spher_base_funcs</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;- Spherical basis functions:\s+(\d+)&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">read_pattern</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;atomic_kinds&quot;</span><span class="p">:</span> <span class="n">atomic_kinds</span><span class="p">,</span>
                <span class="s2">&quot;atoms&quot;</span><span class="p">:</span> <span class="n">atoms</span><span class="p">,</span>
                <span class="s2">&quot;shell_sets&quot;</span><span class="p">:</span> <span class="n">shell_sets</span><span class="p">,</span>
                <span class="s2">&quot;shells&quot;</span><span class="p">:</span> <span class="n">shells</span><span class="p">,</span>
                <span class="s2">&quot;primitive_cartesian_functions&quot;</span><span class="p">:</span> <span class="n">primitive_funcs</span><span class="p">,</span>
                <span class="s2">&quot;cartesian_basis_functions&quot;</span><span class="p">:</span> <span class="n">cart_base_funcs</span><span class="p">,</span>
                <span class="s2">&quot;spherical_basis_functions&quot;</span><span class="p">:</span> <span class="n">spher_base_funcs</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">terminate_on_match</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Cp2kOutput.parse_scf_opt"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.Cp2kOutput.parse_scf_opt">[docs]</a>    <span class="k">def</span> <span class="nf">parse_scf_opt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the SCF cycles (not usually important)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">header</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;Step\s+Update method\s+Time\s+Convergence\s+Total energy\s+Change&quot;</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;\s+\-+&quot;</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">r</span><span class="s2">&quot;(\d+)&quot;</span>
            <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;\s+([A-Za-z\./_]+\s?[A-Za-z\./]+)&quot;</span>
            <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;\s+(-?\d+\.\d+(?:[eE][+\-]?\d+)?)&quot;</span>
            <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;\s+(-?\d+\.\d+(?:[eE][+\-]?\d+)?)&quot;</span>
            <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;(\s+-?\d+\.\d+(?:[eE][+\-]?\d+)?)?&quot;</span>
            <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;\s+(-?\d+\.\d+(?:[eE][+\-]?\d+)?)&quot;</span>
            <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;(\s+-?\d+\.\d+(?:[eE][+\-]?\d+)?)?&quot;</span>
        <span class="p">)</span>

        <span class="n">footer</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;^$&quot;</span>

        <span class="n">scfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_table_pattern</span><span class="p">(</span>
            <span class="n">header_pattern</span><span class="o">=</span><span class="n">header</span><span class="p">,</span>
            <span class="n">row_pattern</span><span class="o">=</span><span class="n">row</span><span class="p">,</span>
            <span class="n">footer_pattern</span><span class="o">=</span><span class="n">footer</span><span class="p">,</span>
            <span class="n">last_one_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">strip</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;HFX_MEM_INFO&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;electronic_steps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;convergence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;scf_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">scfs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;scf_time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;convergence&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">if</span> <span class="n">j</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;electronic_steps&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">])</span></div>

<div class="viewcode-block" id="Cp2kOutput.parse_timing"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.Cp2kOutput.parse_timing">[docs]</a>    <span class="k">def</span> <span class="nf">parse_timing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the timing info (how long did the run take).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">r</span><span class="s2">&quot;SUBROUTINE\s+CALLS\s+ASD\s+SELF TIME\s+TOTAL TIME&quot;</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;\s+MAXIMUM\s+AVERAGE\s+MAXIMUM\s+AVERAGE\s+MAXIMUM&quot;</span>
        <span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(\w+)\s+(.+)\s+(\d+\.\d+)\s+(\d+\.\d+)\s+(\d+\.\d+)\s+(\d+\.\d+)\s+(\d+\.\d+)&quot;</span>
        <span class="n">footer</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\-+&quot;</span>

        <span class="n">timing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_table_pattern</span><span class="p">(</span>
            <span class="n">header_pattern</span><span class="o">=</span><span class="n">header</span><span class="p">,</span>
            <span class="n">row_pattern</span><span class="o">=</span><span class="n">row</span><span class="p">,</span>
            <span class="n">footer_pattern</span><span class="o">=</span><span class="n">footer</span><span class="p">,</span>
            <span class="n">last_one_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">postprocess</span><span class="o">=</span><span class="n">_postprocessor</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timing</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">timing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timing</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;calls&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span>
                <span class="s2">&quot;asd&quot;</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="s2">&quot;self_time&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;average&quot;</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s2">&quot;maximum&quot;</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">4</span><span class="p">]},</span>
                <span class="s2">&quot;total_time&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;average&quot;</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="s2">&quot;maximum&quot;</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">6</span><span class="p">]},</span>
            <span class="p">}</span></div>

<div class="viewcode-block" id="Cp2kOutput.parse_opt_steps"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.Cp2kOutput.parse_opt_steps">[docs]</a>    <span class="k">def</span> <span class="nf">parse_opt_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the geometry optimization information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># &quot;Information at step =&quot; Summary block (floating point terms)</span>
        <span class="n">total_energy</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+Total Energy\s+=\s+(-?\d+.\d+)&quot;</span><span class="p">)</span>
        <span class="n">real_energy_change</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+Real energy change\s+=\s+(-?\d+.\d+)&quot;</span><span class="p">)</span>
        <span class="n">prediced_change_in_energy</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+Predicted change in energy\s+=\s+(-?\d+.\d+)&quot;</span><span class="p">)</span>
        <span class="n">scaling_factor</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+Scaling factor\s+=\s+(-?\d+.\d+)&quot;</span><span class="p">)</span>
        <span class="n">step_size</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+Step size\s+=\s+(-?\d+.\d+)&quot;</span><span class="p">)</span>
        <span class="n">trust_radius</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+Trust radius\s+=\s+(-?\d+.\d+)&quot;</span><span class="p">)</span>
        <span class="n">used_time</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+Used time\s+=\s+(-?\d+.\d+)&quot;</span><span class="p">)</span>

        <span class="c1"># For RUN_TYPE=CELL_OPT</span>
        <span class="n">pressure_deviation</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+Pressure Deviation.*=\s+(-?\d+.\d+)&quot;</span><span class="p">)</span>
        <span class="n">pressure_tolerance</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+Pressure Tolerance.*=\s+(-?\d+.\d+)&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">read_pattern</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;total_energy&quot;</span><span class="p">:</span> <span class="n">total_energy</span><span class="p">,</span>
                <span class="s2">&quot;real_energy_change&quot;</span><span class="p">:</span> <span class="n">real_energy_change</span><span class="p">,</span>
                <span class="s2">&quot;predicted_change_in_energy&quot;</span><span class="p">:</span> <span class="n">prediced_change_in_energy</span><span class="p">,</span>
                <span class="s2">&quot;scaling_factor&quot;</span><span class="p">:</span> <span class="n">scaling_factor</span><span class="p">,</span>
                <span class="s2">&quot;step_size&quot;</span><span class="p">:</span> <span class="n">step_size</span><span class="p">,</span>
                <span class="s2">&quot;trust_radius&quot;</span><span class="p">:</span> <span class="n">trust_radius</span><span class="p">,</span>
                <span class="s2">&quot;used_time&quot;</span><span class="p">:</span> <span class="n">used_time</span><span class="p">,</span>
                <span class="s2">&quot;pressure_deviation&quot;</span><span class="p">:</span> <span class="n">pressure_deviation</span><span class="p">,</span>
                <span class="s2">&quot;pressure_tolerance&quot;</span><span class="p">:</span> <span class="n">pressure_tolerance</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">terminate_on_match</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">postprocess</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># &quot;Information at step =&quot; Summary block (bool terms)</span>
        <span class="n">decrease_in_energy</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+Decrease in energy\s+=\s+(\w+)&quot;</span><span class="p">)</span>
        <span class="n">converged_step_size</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+Convergence in step size\s+=\s+(\w+)&quot;</span><span class="p">)</span>
        <span class="n">converged_rms_step</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+Convergence in RMS step\s+=\s+(\w+)&quot;</span><span class="p">)</span>
        <span class="n">converged_in_grad</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+Conv\. in gradients\s+=\s+(\w+)&quot;</span><span class="p">)</span>
        <span class="n">converged_in_rms_grad</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+Conv\. in RMS gradients\s+=\s+(\w+)&quot;</span><span class="p">)</span>
        <span class="n">pressure_converged</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+Conv\. for  PRESSURE\s+=\s+(\w+)&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">read_pattern</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;decrease_in_energy&quot;</span><span class="p">:</span> <span class="n">decrease_in_energy</span><span class="p">,</span>
                <span class="s2">&quot;converged_step_size&quot;</span><span class="p">:</span> <span class="n">converged_step_size</span><span class="p">,</span>
                <span class="s2">&quot;converged_rms_step&quot;</span><span class="p">:</span> <span class="n">converged_rms_step</span><span class="p">,</span>
                <span class="s2">&quot;converged_in_grad&quot;</span><span class="p">:</span> <span class="n">converged_in_grad</span><span class="p">,</span>
                <span class="s2">&quot;converged_in_rms_grad&quot;</span><span class="p">:</span> <span class="n">converged_in_rms_grad</span><span class="p">,</span>
                <span class="s2">&quot;pressure_converged&quot;</span><span class="p">:</span> <span class="n">pressure_converged</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">terminate_on_match</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">postprocess</span><span class="o">=</span><span class="n">_postprocessor</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Cp2kOutput.parse_mulliken"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.Cp2kOutput.parse_mulliken">[docs]</a>    <span class="k">def</span> <span class="nf">parse_mulliken</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the mulliken population analysis info for each step</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">header</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;Mulliken Population Analysis.+Net charge&quot;</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\s+(\d)\s+(\w+)\s+(\d+)\s+(-?\d+\.\d+)\s+(-?\d+\.\d+)&quot;</span>
        <span class="n">footer</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;.+Total charge&quot;</span>

        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_table_pattern</span><span class="p">(</span>
            <span class="n">header_pattern</span><span class="o">=</span><span class="n">header</span><span class="p">,</span>
            <span class="n">row_pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">,</span>
            <span class="n">footer_pattern</span><span class="o">=</span><span class="n">footer</span><span class="p">,</span>
            <span class="n">last_one_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found data, but not yet implemented!&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cp2kOutput.parse_hirshfeld"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.Cp2kOutput.parse_hirshfeld">[docs]</a>    <span class="k">def</span> <span class="nf">parse_hirshfeld</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        parse the hirshfeld population analysis for each step</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_polarized</span>
        <span class="n">header</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;Hirshfeld Charges.+Net charge&quot;</span>
        <span class="n">footer</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;^$&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">uks</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\s+(\d)\s+(\w+)\s+(\d+)\s+(-?\d+\.\d+)\s+(-?\d+\.\d+)\s+(-?\d+\.\d+)&quot;</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_table_pattern</span><span class="p">(</span>
                <span class="n">header_pattern</span><span class="o">=</span><span class="n">header</span><span class="p">,</span>
                <span class="n">row_pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">,</span>
                <span class="n">footer_pattern</span><span class="o">=</span><span class="n">footer</span><span class="p">,</span>
                <span class="n">last_one_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ionic_step</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">population</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">net_charge</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">ionic_step</span><span class="p">:</span>
                    <span class="n">population</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                    <span class="n">net_charge</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                <span class="n">hirshfeld</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;population&quot;</span><span class="p">:</span> <span class="n">population</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="s2">&quot;net_charge&quot;</span><span class="p">:</span> <span class="n">net_charge</span><span class="p">[</span><span class="n">j</span><span class="p">]}</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">population</span><span class="p">))]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add_site_property</span><span class="p">(</span><span class="s2">&quot;hirshfield&quot;</span><span class="p">,</span> <span class="n">hirshfeld</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">r</span><span class="s2">&quot;\s+(\d)\s+(\w+)\s+(\d+)\s+(-?\d+\.\d+)\s+&quot;</span>
                <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;(-?\d+\.\d+)\s+(-?\d+\.\d+)\s+(-?\d+\.\d+)\s+(-?\d+\.\d+)&quot;</span>
            <span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_table_pattern</span><span class="p">(</span>
                <span class="n">header_pattern</span><span class="o">=</span><span class="n">header</span><span class="p">,</span>
                <span class="n">row_pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">,</span>
                <span class="n">footer_pattern</span><span class="o">=</span><span class="n">footer</span><span class="p">,</span>
                <span class="n">last_one_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ionic_step</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">population</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">net_charge</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">spin_moment</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">ionic_step</span><span class="p">:</span>
                    <span class="n">population</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">site</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">5</span><span class="p">]))</span>
                    <span class="n">spin_moment</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
                    <span class="n">net_charge</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
                <span class="n">hirshfeld</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;population&quot;</span><span class="p">:</span> <span class="n">population</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                        <span class="s2">&quot;net_charge&quot;</span><span class="p">:</span> <span class="n">net_charge</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                        <span class="s2">&quot;spin_moment&quot;</span><span class="p">:</span> <span class="n">spin_moment</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                    <span class="p">}</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">population</span><span class="p">))</span>
                <span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add_site_property</span><span class="p">(</span><span class="s2">&quot;hirshfield&quot;</span><span class="p">,</span> <span class="n">hirshfeld</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cp2kOutput.parse_mo_eigenvalues"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.Cp2kOutput.parse_mo_eigenvalues">[docs]</a>    <span class="k">def</span> <span class="nf">parse_mo_eigenvalues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the MO eigenvalues from the cp2k output file. Will get the eigenvalues (and band gap)</span>
<span class="sd">        at each ionic step (if more than one exist).</span>

<span class="sd">        Everything is decomposed by spin channel. If calculation was performed without spin polarization,</span>
<span class="sd">        then only Spin.up will be present, which represents the average of up and down.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">eigenvalues</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">band_gap</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">efermi</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">with</span> <span class="n">zopen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s2">&quot; occupied subspace spin&quot;</span><span class="p">):</span>
                        <span class="n">eigenvalues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;occupied&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">Spin</span><span class="o">.</span><span class="n">up</span><span class="p">:</span> <span class="p">[],</span> <span class="n">Spin</span><span class="o">.</span><span class="n">down</span><span class="p">:</span> <span class="p">[]},</span>
                                <span class="s2">&quot;unoccupied&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">Spin</span><span class="o">.</span><span class="n">up</span><span class="p">:</span> <span class="p">[],</span> <span class="n">Spin</span><span class="o">.</span><span class="n">down</span><span class="p">:</span> <span class="p">[]},</span>
                            <span class="p">}</span>
                        <span class="p">)</span>
                        <span class="n">efermi</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">Spin</span><span class="o">.</span><span class="n">up</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">Spin</span><span class="o">.</span><span class="n">down</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">})</span>
                        <span class="nb">next</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s2">&quot;Fermi&quot;</span><span class="p">):</span>
                                <span class="n">efermi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">Spin</span><span class="o">.</span><span class="n">up</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                                <span class="k">break</span>
                            <span class="n">eigenvalues</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;occupied&quot;</span><span class="p">][</span><span class="n">Spin</span><span class="o">.</span><span class="n">up</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">Ha_to_eV</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span>
                        <span class="nb">next</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s2">&quot; occupied subspace spin&quot;</span><span class="p">):</span>
                            <span class="nb">next</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                                <span class="n">line</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s2">&quot;Fermi&quot;</span><span class="p">):</span>
                                    <span class="n">efermi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">Spin</span><span class="o">.</span><span class="n">down</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                                    <span class="k">break</span>
                                <span class="n">eigenvalues</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;occupied&quot;</span><span class="p">][</span><span class="n">Spin</span><span class="o">.</span><span class="n">down</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                                    <span class="p">[</span><span class="n">Ha_to_eV</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
                                <span class="p">)</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s2">&quot; unoccupied subspace spin&quot;</span><span class="p">):</span>
                        <span class="nb">next</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s2">&quot;WARNING : did not converge&quot;</span><span class="p">):</span>
                                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                                    <span class="s2">&quot;Convergence of eigenvalues for unoccupied subspace spin 1 did NOT converge&quot;</span>
                                <span class="p">)</span>
                                <span class="nb">next</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                                <span class="nb">next</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                                <span class="nb">next</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                                <span class="n">line</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                                <span class="n">eigenvalues</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;unoccupied&quot;</span><span class="p">][</span><span class="n">Spin</span><span class="o">.</span><span class="n">up</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                                    <span class="p">[</span><span class="n">Ha_to_eV</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
                                <span class="p">)</span>
                                <span class="nb">next</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                                <span class="n">line</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                                <span class="k">break</span>

                            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s2">&quot;convergence&quot;</span><span class="p">):</span>
                                <span class="n">line</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

                            <span class="k">if</span> <span class="p">(</span>
                                <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s2">&quot;eigenvalues&quot;</span><span class="p">)</span>
                                <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s2">&quot;HOMO&quot;</span><span class="p">)</span>
                                <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
                            <span class="p">):</span>
                                <span class="k">break</span>
                            <span class="n">eigenvalues</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;unoccupied&quot;</span><span class="p">][</span><span class="n">Spin</span><span class="o">.</span><span class="n">up</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">Ha_to_eV</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s2">&quot; unoccupied subspace spin&quot;</span><span class="p">):</span>
                            <span class="nb">next</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s2">&quot;WARNING : did not converge&quot;</span><span class="p">):</span>
                                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                                        <span class="s2">&quot;Convergence of eigenvalues for unoccupied subspace spin 2 did NOT converge&quot;</span>
                                    <span class="p">)</span>
                                    <span class="nb">next</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                                    <span class="nb">next</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                                    <span class="nb">next</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                                    <span class="n">line</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                                    <span class="n">eigenvalues</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;unoccupied&quot;</span><span class="p">][</span><span class="n">Spin</span><span class="o">.</span><span class="n">down</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                                        <span class="p">[</span><span class="n">Ha_to_eV</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
                                    <span class="p">)</span>
                                    <span class="k">break</span>

                                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s2">&quot;convergence&quot;</span><span class="p">):</span>
                                    <span class="n">line</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

                                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s2">&quot;HOMO&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">):</span>
                                    <span class="nb">next</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                                    <span class="k">break</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">eigenvalues</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;unoccupied&quot;</span><span class="p">][</span><span class="n">Spin</span><span class="o">.</span><span class="n">down</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                                        <span class="p">[</span><span class="n">Ha_to_eV</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
                                    <span class="p">)</span>
                                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                                    <span class="k">break</span>
                                <span class="n">line</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">eigenvalues</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">{</span><span class="s2">&quot;occupied&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">Spin</span><span class="o">.</span><span class="n">up</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Spin</span><span class="o">.</span><span class="n">down</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span> <span class="s2">&quot;unoccupied&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">Spin</span><span class="o">.</span><span class="n">up</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Spin</span><span class="o">.</span><span class="n">down</span><span class="p">:</span> <span class="kc">None</span><span class="p">}}</span>
                    <span class="p">]</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Convergence of eigenvalues for one or more subspaces did NOT converge&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;eigenvalues&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eigenvalues</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;band_gap&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">band_gap</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No MO eigenvalues detected.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># self.data will always contained the eigenvalues resolved by spin channel. The average vbm, cbm, gap,</span>
        <span class="c1"># and fermi are saved as class attributes, as there is (usually) no asymmetry in these values for</span>
        <span class="c1"># common materials</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_polarized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;vbm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">Spin</span><span class="o">.</span><span class="n">up</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;occupied&quot;</span><span class="p">][</span><span class="n">Spin</span><span class="o">.</span><span class="n">up</span><span class="p">]),</span>
                <span class="n">Spin</span><span class="o">.</span><span class="n">down</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;occupied&quot;</span><span class="p">][</span><span class="n">Spin</span><span class="o">.</span><span class="n">down</span><span class="p">]),</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cbm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">Spin</span><span class="o">.</span><span class="n">up</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;unoccupied&quot;</span><span class="p">][</span><span class="n">Spin</span><span class="o">.</span><span class="n">up</span><span class="p">]</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span>
                <span class="n">Spin</span><span class="o">.</span><span class="n">down</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;unoccupied&quot;</span><span class="p">][</span><span class="n">Spin</span><span class="o">.</span><span class="n">down</span><span class="p">]</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vbm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;vbm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cbm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cbm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">efermi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">efermi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;vbm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">Spin</span><span class="o">.</span><span class="n">up</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;occupied&quot;</span><span class="p">][</span><span class="n">Spin</span><span class="o">.</span><span class="n">up</span><span class="p">]),</span>
                <span class="n">Spin</span><span class="o">.</span><span class="n">down</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cbm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">Spin</span><span class="o">.</span><span class="n">up</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;unoccupied&quot;</span><span class="p">][</span><span class="n">Spin</span><span class="o">.</span><span class="n">up</span><span class="p">]),</span>
                <span class="n">Spin</span><span class="o">.</span><span class="n">down</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vbm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;vbm&quot;</span><span class="p">][</span><span class="n">Spin</span><span class="o">.</span><span class="n">up</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cbm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cbm&quot;</span><span class="p">][</span><span class="n">Spin</span><span class="o">.</span><span class="n">up</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">efermi</span> <span class="o">=</span> <span class="n">efermi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">Spin</span><span class="o">.</span><span class="n">up</span><span class="p">]</span>

        <span class="n">num_occ</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;occupied&quot;</span><span class="p">][</span><span class="n">Spin</span><span class="o">.</span><span class="n">up</span><span class="p">])</span>
        <span class="n">num_unocc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;unoccupied&quot;</span><span class="p">][</span><span class="n">Spin</span><span class="o">.</span><span class="n">up</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;tdos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dos</span><span class="p">(</span>
            <span class="n">efermi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vbm</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">,</span>
            <span class="n">energies</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;occupied&quot;</span><span class="p">][</span><span class="n">Spin</span><span class="o">.</span><span class="n">up</span><span class="p">])</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;unoccupied&quot;</span><span class="p">][</span><span class="n">Spin</span><span class="o">.</span><span class="n">down</span><span class="p">]),</span>
            <span class="n">densities</span><span class="o">=</span><span class="p">{</span>
                <span class="n">Spin</span><span class="o">.</span><span class="n">up</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_occ</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_unocc</span><span class="p">)],</span>
                <span class="n">Spin</span><span class="o">.</span><span class="n">down</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_occ</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_unocc</span><span class="p">)],</span>
            <span class="p">},</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Cp2kOutput.parse_homo_lumo"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.Cp2kOutput.parse_homo_lumo">[docs]</a>    <span class="k">def</span> <span class="nf">parse_homo_lumo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the HOMO - LUMO gap in [eV]. Returns the last value. For gaps/eigenvalues decomposed by</span>
<span class="sd">        spin up/spin down channel and over many ionic steps, see parse_mo_eigenvalues()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;HOMO.*-.*LUMO.*gap.*\s(-?\d+.\d+)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_pattern</span><span class="p">(</span>
            <span class="n">patterns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;band_gap&quot;</span><span class="p">:</span> <span class="n">pattern</span><span class="p">},</span>
            <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">terminate_on_match</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">postprocess</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">bg</span> <span class="o">=</span> <span class="p">{</span><span class="n">Spin</span><span class="o">.</span><span class="n">up</span><span class="p">:</span> <span class="p">[],</span> <span class="n">Spin</span><span class="o">.</span><span class="n">down</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;band_gap&quot;</span><span class="p">])):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_polarized</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">bg</span><span class="p">[</span><span class="n">Spin</span><span class="o">.</span><span class="n">up</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;band_gap&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bg</span><span class="p">[</span><span class="n">Spin</span><span class="o">.</span><span class="n">down</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;band_gap&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bg</span><span class="p">[</span><span class="n">Spin</span><span class="o">.</span><span class="n">up</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;band_gap&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">bg</span><span class="p">[</span><span class="n">Spin</span><span class="o">.</span><span class="n">down</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;band_gap&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;band_gap&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">band_gap</span> <span class="o">=</span> <span class="p">(</span><span class="n">bg</span><span class="p">[</span><span class="n">Spin</span><span class="o">.</span><span class="n">up</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bg</span><span class="p">[</span><span class="n">Spin</span><span class="o">.</span><span class="n">down</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">bg</span><span class="p">[</span><span class="n">Spin</span><span class="o">.</span><span class="n">up</span><span class="p">]</span> <span class="ow">and</span> <span class="n">bg</span><span class="p">[</span><span class="n">Spin</span><span class="o">.</span><span class="n">down</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Cp2kOutput.parse_dos"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.Cp2kOutput.parse_dos">[docs]</a>    <span class="k">def</span> <span class="nf">parse_dos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pdos_files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ldos_files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the pdos_ALPHA files created by cp2k, and assimilate them into a CompleteDos object.</span>
<span class="sd">        Either provide a list of PDOS file paths, or use glob to find the .pdos_ALPHA extension in</span>
<span class="sd">        the calculation directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            pdos_files (list): list of pdos file paths, otherwise they will be inferred</span>
<span class="sd">            ldos_Files (list): list of ldos file paths, otherwise they will be inferred</span>
<span class="sd">            sigma (float): Gaussian smearing parameter, if desired. Because cp2k is generally</span>
<span class="sd">                used as a gamma-point only code, this is often needed to get smooth DOS that</span>
<span class="sd">                are comparable to k-point averaged DOS</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pdos_files</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pdos_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="s2">&quot;PDOS&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">ldos_files</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ldos_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="s2">&quot;LDOS&quot;</span><span class="p">]</span>

        <span class="c1"># Parse specie projected dos</span>
        <span class="n">tdos</span><span class="p">,</span> <span class="n">pdoss</span><span class="p">,</span> <span class="n">ldoss</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">pdos_file</span> <span class="ow">in</span> <span class="n">pdos_files</span><span class="p">:</span>
            <span class="n">_pdos</span><span class="p">,</span> <span class="n">_tdos</span> <span class="o">=</span> <span class="n">parse_dos</span><span class="p">(</span><span class="n">pdos_file</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_pdos</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">pdoss</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">orbital</span> <span class="ow">in</span> <span class="n">_pdos</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                        <span class="n">pdoss</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">orbital</span><span class="p">]</span><span class="o">.</span><span class="n">densities</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_pdos</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">orbital</span><span class="p">]</span><span class="o">.</span><span class="n">densities</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pdoss</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_pdos</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tdos</span><span class="p">:</span>
                <span class="n">tdos</span> <span class="o">=</span> <span class="n">_tdos</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_tdos</span><span class="o">.</span><span class="n">densities</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tdos</span><span class="o">.</span><span class="n">densities</span><span class="p">:</span>
                        <span class="n">tdos</span><span class="o">.</span><span class="n">densities</span><span class="p">[</span><span class="n">Spin</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">))]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">tdos</span><span class="o">.</span><span class="n">densities</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tdos</span><span class="o">.</span><span class="n">densities</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_tdos</span><span class="o">.</span><span class="n">densities</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="c1"># parse any site-projected dos</span>
        <span class="k">for</span> <span class="n">ldos_file</span> <span class="ow">in</span> <span class="n">ldos_files</span><span class="p">:</span>
            <span class="n">_pdos</span> <span class="o">=</span> <span class="n">parse_dos</span><span class="p">(</span><span class="n">ldos_file</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_pdos</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ldoss</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">orbital</span> <span class="ow">in</span> <span class="n">_pdos</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                        <span class="n">ldoss</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">orbital</span><span class="p">]</span><span class="o">.</span><span class="n">densities</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_pdos</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">orbital</span><span class="p">]</span><span class="o">.</span><span class="n">densities</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ldoss</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_pdos</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;pdos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jsanitize</span><span class="p">(</span><span class="n">pdoss</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;ldos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jsanitize</span><span class="p">(</span><span class="n">ldoss</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;tdos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tdos</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tdos&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">band_gap</span> <span class="o">=</span> <span class="n">tdos</span><span class="o">.</span><span class="n">get_gap</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cbm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vbm</span> <span class="o">=</span> <span class="n">tdos</span><span class="o">.</span><span class="n">get_cbm_vbm</span><span class="p">()</span>

        <span class="c1"># If number of site-projected dos == number of sites, assume they are bijective</span>
        <span class="c1"># and create the CompleteDos object</span>
        <span class="n">_ldoss</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_structure</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ldoss</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_structure</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">lds</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ldoss</span><span class="p">):</span>
                <span class="n">_ldoss</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_structure</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="n">Orbital</span><span class="p">(</span><span class="n">orb</span><span class="p">):</span> <span class="n">lds</span><span class="p">[</span><span class="n">orb</span><span class="p">]</span><span class="o">.</span><span class="n">densities</span> <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">lds</span><span class="p">}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cdos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CompleteDos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_structure</span><span class="p">,</span> <span class="n">total_dos</span><span class="o">=</span><span class="n">tdos</span><span class="p">,</span> <span class="n">pdoss</span><span class="o">=</span><span class="n">_ldoss</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_gauss_smear</span><span class="p">(</span><span class="n">densities</span><span class="p">,</span> <span class="n">energies</span><span class="p">,</span> <span class="n">npts</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">width</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">densities</span>

        <span class="sd">&quot;&quot;&quot;Return a gaussian smeared DOS&quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npts</span><span class="p">)</span>
        <span class="n">e_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">energies</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">energies</span><span class="p">),</span> <span class="n">npts</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">_pd</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span> <span class="n">densities</span><span class="p">):</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(((</span><span class="n">e_s</span> <span class="o">-</span> <span class="n">e</span><span class="p">)</span> <span class="o">/</span> <span class="n">width</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">+=</span> <span class="n">_pd</span> <span class="o">*</span> <span class="n">weight</span>

        <span class="k">return</span> <span class="n">d</span>

<div class="viewcode-block" id="Cp2kOutput.read_pattern"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.Cp2kOutput.read_pattern">[docs]</a>    <span class="k">def</span> <span class="nf">read_pattern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">terminate_on_match</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">postprocess</span><span class="o">=</span><span class="nb">str</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function originally comes from pymatgen.io.vasp.outputs Outcar class</span>

<span class="sd">        General pattern reading. Uses monty&#39;s regrep method. Takes the same</span>
<span class="sd">        arguments.</span>

<span class="sd">        Args:</span>
<span class="sd">            patterns (dict): A dict of patterns, e.g.,</span>
<span class="sd">                {&quot;energy&quot;: r&quot;energy\\(sigma-&gt;0\\)\\s+=\\s+([\\d\\-.]+)&quot;}.</span>
<span class="sd">            reverse (bool): Read files in reverse. Defaults to false. Useful for</span>
<span class="sd">                large files, esp OUTCARs, especially when used with</span>
<span class="sd">                terminate_on_match.</span>
<span class="sd">            terminate_on_match (bool): Whether to terminate when there is at</span>
<span class="sd">                least one match in each key in pattern.</span>
<span class="sd">            postprocess (callable): A post processing function to convert all</span>
<span class="sd">                matches. Defaults to str, i.e., no change.</span>

<span class="sd">        Renders accessible:</span>
<span class="sd">            Any attribute in patterns. For example,</span>
<span class="sd">            {&quot;energy&quot;: r&quot;energy\\(sigma-&gt;0\\)\\s+=\\s+([\\d\\-.]+)&quot;} will set the</span>
<span class="sd">            value of self.data[&quot;energy&quot;] = [[-1234], [-3453], ...], to the</span>
<span class="sd">            results from regex and postprocess. Note that the returned values</span>
<span class="sd">            are lists of lists, because you can grep multiple items on one line.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">regrep</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
            <span class="n">patterns</span><span class="p">,</span>
            <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">,</span>
            <span class="n">terminate_on_match</span><span class="o">=</span><span class="n">terminate_on_match</span><span class="p">,</span>
            <span class="n">postprocess</span><span class="o">=</span><span class="n">postprocess</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">patterns</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">matches</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">[])]</span></div>

<div class="viewcode-block" id="Cp2kOutput.read_table_pattern"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.Cp2kOutput.read_table_pattern">[docs]</a>    <span class="k">def</span> <span class="nf">read_table_pattern</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">header_pattern</span><span class="p">,</span>
        <span class="n">row_pattern</span><span class="p">,</span>
        <span class="n">footer_pattern</span><span class="p">,</span>
        <span class="n">postprocess</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">attribute_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">last_one_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">strip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function originally comes from pymatgen.io.vasp.outputs Outcar class</span>

<span class="sd">        Parse table-like data. A table composes of three parts: header,</span>
<span class="sd">        main body, footer. All the data matches &quot;row pattern&quot; in the main body</span>
<span class="sd">        will be returned.</span>

<span class="sd">        Args:</span>
<span class="sd">            header_pattern (str): The regular expression pattern matches the</span>
<span class="sd">                table header. This pattern should match all the text</span>
<span class="sd">                immediately before the main body of the table. For multiple</span>
<span class="sd">                sections table match the text until the section of</span>
<span class="sd">                interest. MULTILINE and DOTALL options are enforced, as a</span>
<span class="sd">                result, the &quot;.&quot; meta-character will also match &quot;\n&quot; in this</span>
<span class="sd">                section.</span>
<span class="sd">            row_pattern (str): The regular expression matches a single line in</span>
<span class="sd">                the table. Capture interested field using regular expression</span>
<span class="sd">                groups.</span>
<span class="sd">            footer_pattern (str): The regular expression matches the end of the</span>
<span class="sd">                table. E.g. a long dash line.</span>
<span class="sd">            postprocess (callable): A post processing function to convert all</span>
<span class="sd">                matches. Defaults to str, i.e., no change.</span>
<span class="sd">            attribute_name (str): Name of this table. If present the parsed data</span>
<span class="sd">                will be attached to &quot;data. e.g. self.data[&quot;efg&quot;] = [...]</span>
<span class="sd">            last_one_only (bool): All the tables will be parsed, if this option</span>
<span class="sd">                is set to True, only the last table will be returned. The</span>
<span class="sd">                enclosing list will be removed. i.e. Only a single table will</span>
<span class="sd">                be returned. Default to be True.</span>
<span class="sd">            strip (list): Whether or not to strip contents out of the file before</span>
<span class="sd">                reading for a table pattern. This is mainly used by parse_scf_opt(),</span>
<span class="sd">                to strip HFX info out of the SCF loop start or DFT+U warnings out</span>
<span class="sd">                of the SCF loop iterations.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of tables. 1) A table is a list of rows. 2) A row if either a list of</span>
<span class="sd">            attribute values in case the the capturing group is defined without name in</span>
<span class="sd">            row_pattern, or a dict in case that named capturing groups are defined by</span>
<span class="sd">            row_pattern.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">zopen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">strip</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span>
                            <span class="ow">not</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                            <span class="ow">and</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                            <span class="ow">and</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">strip</span>
                        <span class="p">)</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">table_pattern_text</span> <span class="o">=</span> <span class="n">header_pattern</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;\s*^(?P&lt;table_body&gt;(?:\s+&quot;</span> <span class="o">+</span> <span class="n">row_pattern</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;)+)\s+&quot;</span> <span class="o">+</span> <span class="n">footer_pattern</span>
        <span class="n">table_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">table_pattern_text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
        <span class="n">rp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">row_pattern</span><span class="p">)</span>
        <span class="n">tables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mt</span> <span class="ow">in</span> <span class="n">table_pattern</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
            <span class="n">table_body_text</span> <span class="o">=</span> <span class="n">mt</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;table_body&quot;</span><span class="p">)</span>
            <span class="n">table_contents</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">table_body_text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
                <span class="n">ml</span> <span class="o">=</span> <span class="n">rp</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ml</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">ml</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">processed_line</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">postprocess</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">processed_line</span> <span class="o">=</span> <span class="p">[</span><span class="n">postprocess</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ml</span><span class="o">.</span><span class="n">groups</span><span class="p">()]</span>
                <span class="n">table_contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">processed_line</span><span class="p">)</span>
            <span class="n">tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table_contents</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">last_one_only</span><span class="p">:</span>
            <span class="n">retained_data</span> <span class="o">=</span> <span class="n">tables</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">retained_data</span> <span class="o">=</span> <span class="n">tables</span>
        <span class="k">if</span> <span class="n">attribute_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">attribute_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">retained_data</span>
        <span class="k">return</span> <span class="n">retained_data</span></div>

<div class="viewcode-block" id="Cp2kOutput.as_dict"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.Cp2kOutput.as_dict">[docs]</a>    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return dictionary representation of the output</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;total_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timing</span><span class="p">[</span><span class="s2">&quot;CP2K&quot;</span><span class="p">][</span><span class="s2">&quot;total_time&quot;</span><span class="p">][</span><span class="s2">&quot;maximum&quot;</span><span class="p">]</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;run_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_type</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">][</span><span class="s2">&quot;global&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;global&quot;</span><span class="p">)</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">][</span><span class="s2">&quot;dft&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dft&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">][</span><span class="s2">&quot;scf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scf&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">][</span><span class="s2">&quot;qs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;QS&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">][</span><span class="s2">&quot;run_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_type</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">][</span><span class="s2">&quot;calculation_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculation_type</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">][</span><span class="s2">&quot;structure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_structure</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">][</span><span class="s2">&quot;atomic_kind_info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;atomic_kind_info&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">][</span><span class="s2">&quot;cp2k_input&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;ran_successfully&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">completed</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;cp2k_version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cp2k_version</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;structure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_structure</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;forces&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;forces&quot;</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;stress&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stress_tensor&quot;</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;ionic_steps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">MSONable</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">step</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ionic_steps</span>
        <span class="p">]</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;composition&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;energy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_energy</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;energy_per_atom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_energy</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">num_atoms</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;bandgap&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbm</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">vbm</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbm</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">vbm</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;cbm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbm</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;vbm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vbm</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;efermi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">efermi</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;is_metal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_metal</span>
        <span class="k">return</span> <span class="n">d</span></div></div>


<span class="c1"># TODO should store as pandas? Maybe it should be stored as a dict so it&#39;s python native</span>
<div class="viewcode-block" id="parse_energy_file"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.parse_energy_file">[docs]</a><span class="k">def</span> <span class="nf">parse_energy_file</span><span class="p">(</span><span class="n">energy_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses energy file for calculations with multiple ionic steps.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;step&quot;</span><span class="p">,</span>
        <span class="s2">&quot;kinetic_energy&quot;</span><span class="p">,</span>
        <span class="s2">&quot;temp&quot;</span><span class="p">,</span>
        <span class="s2">&quot;potential_energy&quot;</span><span class="p">,</span>
        <span class="s2">&quot;conserved_quantity&quot;</span><span class="p">,</span>
        <span class="s2">&quot;used_time&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">energy_file</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;kinetic_energy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;kinetic_energy&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">Ha_to_eV</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;potential_energy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;potential_energy&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">Ha_to_eV</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;conserved_quantity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;conserved_quantity&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">Ha_to_eV</span>
    <span class="n">df</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">d</span></div>


<div class="viewcode-block" id="parse_dos"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.outputs.html#pymatgen.io.cp2k.outputs.parse_dos">[docs]</a><span class="k">def</span> <span class="nf">parse_dos</span><span class="p">(</span><span class="n">dos_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spin_channel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse a single DOS file created by cp2k. Must contain one PDOS snapshot. i.e. you cannot</span>
<span class="sd">    use this cannot deal with multiple concatenated dos files.</span>

<span class="sd">    Args:</span>
<span class="sd">        dos_file (list): list of pdos_ALPHA file paths</span>
<span class="sd">        spin_channel (int): Which spin channel the file corresponds to. By default, CP2K will</span>
<span class="sd">            write the file with ALPHA or BETA in the filename (for spin up or down), but</span>
<span class="sd">            you can specify this here, in case you have a manual file name.</span>
<span class="sd">            spin_channel == 1 --&gt; spin up, spin_channel == -1 --&gt; spin down.</span>
<span class="sd">        total (bool): Whether to grab the total occupations, or the orbital decomposed ones.</span>
<span class="sd">        sigma (float): width for gaussian smearing, if desired</span>

<span class="sd">    Returns:</span>
<span class="sd">        Everything necessary to create a dos object, in dict format:</span>
<span class="sd">            (1) orbital decomposed DOS dict:</span>
<span class="sd">                i.e. pdoss = {specie: {orbital.s: {Spin.up: ... }, orbital.px: {Spin.up: ... } ...}}</span>
<span class="sd">            (2) energy levels of this dos file</span>
<span class="sd">            (3) fermi energy (in eV).</span>
<span class="sd">        DOS object is not created here</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">spin_channel</span><span class="p">:</span>
        <span class="n">spin</span> <span class="o">=</span> <span class="n">Spin</span><span class="p">(</span><span class="n">spin_channel</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spin</span> <span class="o">=</span> <span class="n">Spin</span><span class="o">.</span><span class="n">down</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">dos_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s2">&quot;BETA&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">Spin</span><span class="o">.</span><span class="n">up</span>

    <span class="k">with</span> <span class="n">zopen</span><span class="p">(</span><span class="n">dos_file</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;atomic kind\s(.*)\sat iter&quot;</span><span class="p">,</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;list\s(\d+)\s(.*)\sat iter&quot;</span><span class="p">,</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">header</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s{2,}&quot;</span><span class="p">,</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">dos_file</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">cp2k_to_pmg_labels</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;p&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;px&quot;</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;dxy&quot;</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;f&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;f_3&quot;</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;d-2&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;dxy&quot;</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;d-1&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;dyz&quot;</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;d0&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;dz2&quot;</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;d+1&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;dxz&quot;</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;d+2&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;dx2&quot;</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;f-3&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;f_3&quot;</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;f-2&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;f_2&quot;</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;f-1&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;f_1&quot;</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;f0&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;f0&quot;</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;f+1&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;f1&quot;</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;f+2&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;f2&quot;</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;f+3&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;f3&quot;</span>
            <span class="k">return</span> <span class="n">x</span>

        <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="n">cp2k_to_pmg_labels</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">header</span><span class="p">]</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">occupations</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="n">Ha_to_eV</span>
        <span class="n">energies</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">occupations</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">o</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">vbmtop</span> <span class="o">=</span> <span class="n">i</span>

        <span class="c1"># set fermi level to be vbm plus tolerance for</span>
        <span class="c1"># PMG compatability</span>
        <span class="c1"># *not* middle of the gap, which pdos might report</span>
        <span class="n">efermi</span> <span class="o">=</span> <span class="n">energies</span><span class="p">[</span><span class="n">vbmtop</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-6</span>

        <span class="c1"># for pymatgen&#39;s dos class. VASP creates an evenly spaced grid of energy states, which leads to 0 density</span>
        <span class="c1"># states in the band gap. CP2K does not do this. PMG&#39;s Dos class was created with VASP in mind so the way</span>
        <span class="c1"># it searches for vbm and cbm relies on grid points in between VBM and CBM, so here we introduce trivial ones</span>
        <span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span> <span class="n">vbmtop</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">energies</span><span class="p">[</span><span class="n">vbmtop</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="n">energies</span><span class="p">[</span><span class="n">vbmtop</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">vbmtop</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">pdos</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">kind</span><span class="p">:</span> <span class="p">{</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">Orbital</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span> <span class="n">Dos</span><span class="p">(</span><span class="n">efermi</span><span class="o">=</span><span class="n">efermi</span><span class="p">,</span> <span class="n">energies</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span> <span class="n">densities</span><span class="o">=</span><span class="p">{</span><span class="n">spin</span><span class="p">:</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]})</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">total</span><span class="p">:</span>
            <span class="n">tdos</span> <span class="o">=</span> <span class="n">Dos</span><span class="p">(</span><span class="n">efermi</span><span class="o">=</span><span class="n">efermi</span><span class="p">,</span> <span class="n">energies</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span> <span class="n">densities</span><span class="o">=</span><span class="p">{</span><span class="n">spin</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)})</span>
            <span class="k">return</span> <span class="n">pdos</span><span class="p">,</span> <span class="n">tdos</span>
        <span class="k">return</span> <span class="n">pdos</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">pymatgen 2022.4.19 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">pymatgen.io.cp2k.outputs</a></li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2011, Pymatgen Development Team.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.4.0.
    </div>
<div class="footer">This page uses <a href="http://analytics.google.com/">
Google Analytics</a> to collect statistics. You can disable it by blocking
the JavaScript coming from www.google-analytics.com.
<script type="text/javascript">
  (function() {
    var ga = document.createElement('script');
    ga.src = ('https:' == document.location.protocol ?
              'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    ga.setAttribute('async', 'true');
    document.documentElement.firstChild.appendChild(ga);
  })();
</script>
</div>

  </body>
</html>