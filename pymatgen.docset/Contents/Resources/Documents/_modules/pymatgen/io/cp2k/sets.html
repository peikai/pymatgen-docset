
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pymatgen.io.cp2k.sets &#8212; pymatgen 2022.11.7 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/basic.css" />
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
 
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-33990148-1']);
  _gaq.push(['_trackPageview']);
</script>

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">pymatgen 2022.11.7 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">pymatgen.io.cp2k.sets</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <h1>Source code for pymatgen.io.cp2k.sets</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module defines input sets for CP2K and is a work in progress. The structure/philosophy</span>
<span class="sd">of this module is based on the Vasp input sets in Pymatgen. These sets are meant to contain</span>
<span class="sd">tested parameters that will result in successful, reproducible, consistent calculations without</span>
<span class="sd">need for intervention 99% of the time. 99% of the time, you only need to provide a pymatgen</span>
<span class="sd">structure object and let the defaults take over from there.</span>

<span class="sd">The sets are intended to be very general, e.g. a set for geometry relaxation, and so most of the</span>
<span class="sd">time, if you have specific needs, you can simply specify them via the keyword argument</span>
<span class="sd">override_default_params (see Section.update() method). If you have the need to create a new input</span>
<span class="sd">set (say for a standardized high throughput calculation) then you can create a new child of the</span>
<span class="sd">Cp2kInputSet class.</span>

<span class="sd">In order to implement a new Set within the current code structure, follow this 3 step flow:</span>
<span class="sd">    (1) Inherit from Cp2kInputSet or one of its children and call the super() constructor</span>
<span class="sd">    (2) Create the new sections and insert them into self and its subsections as needed</span>
<span class="sd">    (3) Call self.update(override_default_params) in order to allow user settings.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">ruamel.yaml</span> <span class="kn">import</span> <span class="n">YAML</span>

<span class="kn">from</span> <span class="nn">pymatgen.core</span> <span class="kn">import</span> <span class="n">SETTINGS</span>
<span class="kn">from</span> <span class="nn">pymatgen.core.lattice</span> <span class="kn">import</span> <span class="n">Lattice</span>
<span class="kn">from</span> <span class="nn">pymatgen.core.structure</span> <span class="kn">import</span> <span class="n">Element</span><span class="p">,</span> <span class="n">Molecule</span><span class="p">,</span> <span class="n">Structure</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.cp2k.inputs</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DOS</span><span class="p">,</span>
    <span class="n">LDOS</span><span class="p">,</span>
    <span class="n">PBE</span><span class="p">,</span>
    <span class="n">PDOS</span><span class="p">,</span>
    <span class="n">QS</span><span class="p">,</span>
    <span class="n">Band_Structure</span><span class="p">,</span>
    <span class="n">BasisFile</span><span class="p">,</span>
    <span class="n">BasisInfo</span><span class="p">,</span>
    <span class="n">BrokenSymmetry</span><span class="p">,</span>
    <span class="n">Cell</span><span class="p">,</span>
    <span class="n">Coord</span><span class="p">,</span>
    <span class="n">Cp2kInput</span><span class="p">,</span>
    <span class="n">Dft</span><span class="p">,</span>
    <span class="n">E_Density_Cube</span><span class="p">,</span>
    <span class="n">ForceEval</span><span class="p">,</span>
    <span class="n">GaussianTypeOrbitalBasisSet</span><span class="p">,</span>
    <span class="n">Global</span><span class="p">,</span>
    <span class="n">GthPotential</span><span class="p">,</span>
    <span class="n">Keyword</span><span class="p">,</span>
    <span class="n">Kind</span><span class="p">,</span>
    <span class="n">Kpoints</span><span class="p">,</span>
    <span class="n">Mgrid</span><span class="p">,</span>
    <span class="n">MO_Cubes</span><span class="p">,</span>
    <span class="n">OrbitalTransformation</span><span class="p">,</span>
    <span class="n">PotentialFile</span><span class="p">,</span>
    <span class="n">PotentialInfo</span><span class="p">,</span>
    <span class="n">Scf</span><span class="p">,</span>
    <span class="n">Section</span><span class="p">,</span>
    <span class="n">SectionList</span><span class="p">,</span>
    <span class="n">Smear</span><span class="p">,</span>
    <span class="n">Subsys</span><span class="p">,</span>
    <span class="n">V_Hartree_Cube</span><span class="p">,</span>
    <span class="n">Xc_Functional</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.cp2k.utils</span> <span class="kn">import</span> <span class="n">get_truncated_coulomb_cutoff</span><span class="p">,</span> <span class="n">get_unique_site_indices</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.vasp.inputs</span> <span class="kn">import</span> <span class="n">Kpoints</span> <span class="k">as</span> <span class="n">VaspKpoints</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.vasp.inputs</span> <span class="kn">import</span> <span class="n">Kpoints_supported_modes</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Nicholas Winner&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;2.0&quot;</span>
<span class="n">__email__</span> <span class="o">=</span> <span class="s2">&quot;nwinner@berkeley.edu&quot;</span>
<span class="n">__date__</span> <span class="o">=</span> <span class="s2">&quot;September 2022&quot;</span>


<div class="viewcode-block" id="DftSet"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet">[docs]</a><span class="k">class</span> <span class="nc">DftSet</span><span class="p">(</span><span class="n">Cp2kInput</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base for an input set using the Quickstep module (i.e. a DFT calculation). The DFT section is</span>
<span class="sd">    pretty vast in CP2K, so this set hopes to make the DFT setup fairly simple. The provided</span>
<span class="sd">    parameters are pretty conservative, and so they should not need to be changed very often.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span> <span class="o">|</span> <span class="n">Molecule</span><span class="p">,</span>
        <span class="n">project_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;CP2K&quot;</span><span class="p">,</span>
        <span class="n">basis_and_potential</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">xc_functionals</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">multiplicity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">ot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">energy_gap</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">qs_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;GPW&quot;</span><span class="p">,</span>
        <span class="n">eps_default</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-12</span><span class="p">,</span>
        <span class="n">eps_scf</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">,</span>
        <span class="n">max_scf</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">minimizer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;DIIS&quot;</span><span class="p">,</span>
        <span class="n">preconditioner</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;FULL_SINGLE_INVERSE&quot;</span><span class="p">,</span>
        <span class="n">algorithm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;IRAC&quot;</span><span class="p">,</span>
        <span class="n">linesearch</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;2PNT&quot;</span><span class="p">,</span>
        <span class="n">rotation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">occupation_preconditioner</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">cutoff</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">rel_cutoff</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
        <span class="n">ngrids</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">progression_factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">override_default_params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">wfn_restart_file_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">kpoints</span><span class="p">:</span> <span class="n">VaspKpoints</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">smearing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            structure: Pymatgen structure or molecule object</span>
<span class="sd">            ot (bool): Whether or not to use orbital transformation method for matrix</span>
<span class="sd">                diagonalization. OT is the flagship scf solver of CP2K, and will provide</span>
<span class="sd">                speed-ups for this part of the calculation, but the system must have a band gap</span>
<span class="sd">                for OT to be used (higher band-gap --&gt; faster convergence).</span>
<span class="sd">            energy_gap (float): Estimate of energy gap for pre-conditioner. Default is -1, leaving</span>
<span class="sd">                it up to cp2k.</span>
<span class="sd">            eps_default (float): Replaces all EPS_XX Keywords in the DFT section value, ensuring</span>
<span class="sd">                an overall accuracy of at least this much.</span>
<span class="sd">            eps_scf (float): The convergence criteria for leaving the SCF loop. Default is 1e-6.</span>
<span class="sd">                Should ensure reasonable results, but is not applicable to all situations.</span>
<span class="sd">                    Note: eps_scf is *not* in units of energy, as in most DFT codes. For OT method,</span>
<span class="sd">                    it is the largest gradient of the energy with respect to changing any of the</span>
<span class="sd">                    molecular orbital coefficients. For diagonalization, it is the largest change</span>
<span class="sd">                    in the density matrix from the last step.</span>
<span class="sd">            max_scf (int): The max number of SCF cycles before terminating the solver. NOTE: With</span>
<span class="sd">                the OT solver, this corresponds to the max number of INNER scf loops, and then</span>
<span class="sd">                the outer loops are set with outer_max_scf, while with diagonalization it</span>
<span class="sd">                corresponds to the overall (INNER*OUTER) number of SCF steps, with the</span>
<span class="sd">                inner loop limit set by</span>
<span class="sd">            minimizer (str): The minimization scheme. DIIS can be as much as 50% faster than the</span>
<span class="sd">                more robust conjugate gradient method, and so it is chosen as default. Switch to CG</span>
<span class="sd">                if dealing with a difficult system.</span>
<span class="sd">            preconditioner (str): Pre-conditioner for the OT method. FULL_SINGLE_INVERSE is very</span>
<span class="sd">                robust and compatible with non-integer occupations from IRAC+rotation. FULL_ALL is</span>
<span class="sd">                considered &quot;best&quot; but needs algorithm to be set to STRICT. Only change from these</span>
<span class="sd">                two when simulation cell gets to be VERY large, in which case FULL_KINETIC might be</span>
<span class="sd">                preferred.</span>
<span class="sd">            algorithm (str): Algorithm for the OT method. STRICT assumes that the orbitals are</span>
<span class="sd">                strictly orthogonal to each other, which works well for wide gap ionic systems,</span>
<span class="sd">                but can diverge for systems with small gaps, fractional occupations, and some</span>
<span class="sd">                other cases. IRAC (iterative refinement of the approximate congruency)</span>
<span class="sd">                transformation is not analytically correct and uses a truncated polynomial</span>
<span class="sd">                expansion, but is robust to the problems with STRICT, and so is the default.</span>
<span class="sd">            linesearch (str): Linesearch method for CG. 2PNT is the default, and is the fastest,</span>
<span class="sd">                but is not as robust as 3PNT. 2PNT is required as of cp2k v9.1 for compatibility</span>
<span class="sd">                with irac+rotation. This may be upgraded in the future. 3PNT can be good for wide</span>
<span class="sd">                gapped transition metal systems as an alternative.</span>
<span class="sd">            rotation (bool): Whether or not to allow for rotation of the orbitals in the OT method.</span>
<span class="sd">                This equates to allowing for fractional occupations in the calculation.</span>
<span class="sd">            occupation_preconditioner (bool): Whether or not to account for fractional occupations</span>
<span class="sd">                in the preconditioner. This method is not fully integrated as of cp2k v9.1 and is</span>
<span class="sd">                set to false by default.</span>
<span class="sd">            cutoff (int): Cutoff energy (in Ry) for the finest level of the multigrid. A high</span>
<span class="sd">                cutoff will allow you to have very accurate calculations PROVIDED that REL_CUTOFF</span>
<span class="sd">                is appropriate. By default cutoff is set to 0, leaving it up to the set.</span>
<span class="sd">            rel_cutoff (int): This cutoff decides how the Gaussians are mapped onto the different</span>
<span class="sd">                levels of the multigrid. If REL_CUTOFF is too low, then even if you have a high</span>
<span class="sd">                CUTOFF, all Gaussians will be mapped onto the coarsest level of the multi-grid,</span>
<span class="sd">                and thus the effective integration grid for the calculation may still be too</span>
<span class="sd">                coarse. By default 50Ry is chosen, which should be sufficient given the cutoff is</span>
<span class="sd">                large enough.</span>
<span class="sd">            ngrids (int): number of multi-grids to use. CP2K default is 4, but the molopt basis</span>
<span class="sd">                files recommend 5.</span>
<span class="sd">            progression_factor (int): Divisor of CUTOFF to get the cutoff for the next level of</span>
<span class="sd">                the multigrid.</span>
<span class="sd">            wfn_restart_file_name (str): RESTART file for the initial wavefunction guess.</span>
<span class="sd">            kpoints (Kpoints): kpoints object from pymatgen.io.vasp.inputs.Kpoints. By default,</span>
<span class="sd">                CP2K runs with gamma point only.</span>
<span class="sd">            smearing (bool): whether or not to activate smearing (should be done for systems</span>
<span class="sd">                containing no (or a very small) band gap.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;CP2K_INPUT&quot;</span><span class="p">,</span> <span class="n">subsections</span><span class="o">=</span><span class="p">{})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">structure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basis_and_potential</span> <span class="o">=</span> <span class="n">basis_and_potential</span> <span class="k">if</span> <span class="n">basis_and_potential</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span> <span class="o">=</span> <span class="n">project_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charge</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">charge</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">multiplicity</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">Molecule</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">multiplicity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">spin_multiplicity</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">multiplicity</span> <span class="o">=</span> <span class="n">multiplicity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ot</span> <span class="o">=</span> <span class="n">ot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qs_method</span> <span class="o">=</span> <span class="n">qs_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy_gap</span> <span class="o">=</span> <span class="n">energy_gap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eps_default</span> <span class="o">=</span> <span class="n">eps_default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eps_scf</span> <span class="o">=</span> <span class="n">eps_scf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_scf</span> <span class="o">=</span> <span class="n">max_scf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minimizer</span> <span class="o">=</span> <span class="n">minimizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preconditioner</span> <span class="o">=</span> <span class="n">preconditioner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">algorithm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotation</span> <span class="o">=</span> <span class="n">rotation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">occupation_preconditioner</span> <span class="o">=</span> <span class="n">occupation_preconditioner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linesearch</span> <span class="o">=</span> <span class="n">linesearch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">=</span> <span class="n">cutoff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rel_cutoff</span> <span class="o">=</span> <span class="n">rel_cutoff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngrids</span> <span class="o">=</span> <span class="n">ngrids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progression_factor</span> <span class="o">=</span> <span class="n">progression_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">override_default_params</span> <span class="o">=</span> <span class="n">override_default_params</span> <span class="k">if</span> <span class="n">override_default_params</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfn_restart_file_name</span> <span class="o">=</span> <span class="n">wfn_restart_file_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span> <span class="o">=</span> <span class="n">kpoints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smearing</span> <span class="o">=</span> <span class="n">smearing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

        <span class="c1"># Enable force and energy evaluations (most calculations)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">ForceEval</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">:</span>
            <span class="c1"># As of cp2k v2022.1 kpoint module is not fully integrated, so even specifying</span>
            <span class="c1"># 0,0,0 will disable certain features. So, you have to drop it all together to</span>
            <span class="c1"># get full support</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">style</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Kpoints_supported_modes</span><span class="o">.</span><span class="n">Gamma</span><span class="p">,</span> <span class="n">Kpoints_supported_modes</span><span class="o">.</span><span class="n">Monkhorst</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">kpts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">style</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Kpoints_supported_modes</span><span class="o">.</span><span class="n">Reciprocal</span><span class="p">,</span> <span class="n">Kpoints_supported_modes</span><span class="o">.</span><span class="n">Cartesian</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">kpts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">ot</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;As of 2022.1, kpoints not supported with OT. Defaulting to diagonalization&quot;</span><span class="p">)</span>
                <span class="n">ot</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Build the global section</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Global</span><span class="p">(</span>
            <span class="n">project_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project_name&quot;</span><span class="p">,</span> <span class="s2">&quot;CP2K&quot;</span><span class="p">),</span>
            <span class="n">run_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;run_type&quot;</span><span class="p">,</span> <span class="s2">&quot;ENERGY_FORCE&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

        <span class="c1"># Build the QS Section</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">QS</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qs_method</span><span class="p">,</span> <span class="n">eps_default</span><span class="o">=</span><span class="n">eps_default</span><span class="p">,</span> <span class="n">eps_pgf_orb</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;eps_pgf_orb&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">max_scf</span> <span class="o">=</span> <span class="n">max_scf</span> <span class="k">if</span> <span class="n">max_scf</span> <span class="k">else</span> <span class="mi">20</span> <span class="k">if</span> <span class="n">ot</span> <span class="k">else</span> <span class="mi">400</span>  <span class="c1"># If ot, max_scf is for inner loop</span>
        <span class="n">scf</span> <span class="o">=</span> <span class="n">Scf</span><span class="p">(</span><span class="n">eps_scf</span><span class="o">=</span><span class="n">eps_scf</span><span class="p">,</span> <span class="n">max_scf</span><span class="o">=</span><span class="n">max_scf</span><span class="p">,</span> <span class="n">subsections</span><span class="o">=</span><span class="p">{})</span>

        <span class="k">if</span> <span class="n">ot</span><span class="p">:</span>
            <span class="n">scf</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="n">OrbitalTransformation</span><span class="p">(</span>
                    <span class="n">minimizer</span><span class="o">=</span><span class="n">minimizer</span><span class="p">,</span>
                    <span class="n">preconditioner</span><span class="o">=</span><span class="n">preconditioner</span><span class="p">,</span>
                    <span class="n">energy_gap</span><span class="o">=</span><span class="n">energy_gap</span><span class="p">,</span>
                    <span class="n">algorithm</span><span class="o">=</span><span class="n">algorithm</span><span class="p">,</span>
                    <span class="n">linesearch</span><span class="o">=</span><span class="n">linesearch</span><span class="p">,</span>
                    <span class="n">rotation</span><span class="o">=</span><span class="n">rotation</span><span class="p">,</span>
                    <span class="n">occupation_preconditioner</span><span class="o">=</span><span class="n">occupation_preconditioner</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">scf</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="n">Section</span><span class="p">(</span>
                    <span class="s2">&quot;OUTER_SCF&quot;</span><span class="p">,</span>
                    <span class="n">subsections</span><span class="o">=</span><span class="p">{},</span>
                    <span class="n">keywords</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;MAX_SCF&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;MAX_SCF&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;outer_max_scf&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)),</span>
                        <span class="s2">&quot;EPS_SCF&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;EPS_SCF&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;outer_eps_scf&quot;</span><span class="p">,</span> <span class="n">eps_scf</span><span class="p">)),</span>
                    <span class="p">},</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scf</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Section</span><span class="p">(</span><span class="s2">&quot;DIAGONALIZATION&quot;</span><span class="p">,</span> <span class="n">subsections</span><span class="o">=</span><span class="p">{}))</span>
            <span class="n">mixing_kwds</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;ALPHA&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;ALPHA&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)),</span>
                <span class="s2">&quot;BETA&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;BETA&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;beta&quot;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)),</span>
                <span class="s2">&quot;NBUFFER&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;NBUFFER&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nbuffer&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)),</span>
                <span class="s2">&quot;N_SIMPLE_MIX&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;N_SIMPLE_MIX&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;n_simple_mix&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
                <span class="s2">&quot;METHOD&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;METHOD&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mixing_method&quot;</span><span class="p">,</span> <span class="s2">&quot;BROYDEN_MIXING&quot;</span><span class="p">)),</span>
            <span class="p">}</span>
            <span class="n">mixing</span> <span class="o">=</span> <span class="n">Section</span><span class="p">(</span><span class="s2">&quot;MIXING&quot;</span><span class="p">,</span> <span class="n">keywords</span><span class="o">=</span><span class="n">mixing_kwds</span><span class="p">,</span> <span class="n">subsections</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">scf</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">mixing</span><span class="p">)</span>
            <span class="n">scf</span><span class="p">[</span><span class="s2">&quot;MAX_DIIS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;MAX_DIIS&quot;</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>

        <span class="c1"># Get basis, potential, and xc info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basis_and_potential</span> <span class="o">=</span> <span class="n">DftSet</span><span class="o">.</span><span class="n">get_basis_and_potential</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_and_potential</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basis_set_file_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_and_potential</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;basis_filenames&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">potential_file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_and_potential</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;potential_filename&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xc_functionals</span> <span class="o">=</span> <span class="n">DftSet</span><span class="o">.</span><span class="n">get_xc_functionals</span><span class="p">(</span>
            <span class="n">xc_functionals</span><span class="o">=</span><span class="n">xc_functionals</span>
        <span class="p">)</span>  <span class="c1"># kwargs.get(&quot;xc_functional&quot;, &quot;PBE&quot;))</span>

        <span class="c1"># create the subsys (structure)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_subsys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>

        <span class="c1"># Create the multigrid for FFTs</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">:</span>
            <span class="n">basis_sets</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_and_potential</span><span class="p">[</span><span class="n">el</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;basis&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">symbol_set</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">=</span> <span class="n">DftSet</span><span class="o">.</span><span class="n">get_cutoff_from_basis</span><span class="p">(</span><span class="n">basis_sets</span><span class="o">=</span><span class="n">basis_sets</span><span class="p">,</span> <span class="n">rel_cutoff</span><span class="o">=</span><span class="n">rel_cutoff</span><span class="p">)</span>

        <span class="n">mgrid</span> <span class="o">=</span> <span class="n">Mgrid</span><span class="p">(</span>
            <span class="n">cutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">,</span>
            <span class="n">rel_cutoff</span><span class="o">=</span><span class="n">rel_cutoff</span><span class="p">,</span>
            <span class="n">ngrids</span><span class="o">=</span><span class="n">ngrids</span><span class="p">,</span>
            <span class="n">progression_factor</span><span class="o">=</span><span class="n">progression_factor</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">smearing</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ot</span><span class="p">:</span>
            <span class="n">scf</span><span class="p">[</span><span class="s2">&quot;ADDED_MOS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;ADDED_MOS&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spin_polarized&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">scf</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Smear</span><span class="p">(</span><span class="n">elec_temp</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;elec_temp&quot;</span><span class="p">,</span> <span class="mi">300</span><span class="p">)))</span>

        <span class="c1"># Set the DFT calculation with global parameters</span>
        <span class="n">dft</span> <span class="o">=</span> <span class="n">Dft</span><span class="p">(</span>
            <span class="n">MULTIPLICITY</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span>
            <span class="n">CHARGE</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span>
            <span class="n">uks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spin_polarized&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">basis_set_filenames</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_set_file_names</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_set_file_names</span> <span class="k">else</span> <span class="p">[],</span>
            <span class="n">potential_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">potential_file_name</span><span class="p">,</span>
            <span class="n">subsections</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;QS&quot;</span><span class="p">:</span> <span class="n">qs</span><span class="p">,</span> <span class="s2">&quot;SCF&quot;</span><span class="p">:</span> <span class="n">scf</span><span class="p">,</span> <span class="s2">&quot;MGRID&quot;</span><span class="p">:</span> <span class="n">mgrid</span><span class="p">},</span>
            <span class="n">wfn_restart_file_name</span><span class="o">=</span><span class="n">wfn_restart_file_name</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Set kpoints only if user supplies them</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">:</span>
            <span class="n">dft</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Kpoints</span><span class="o">.</span><span class="n">from_kpoints</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">))</span>

        <span class="c1"># Create subsections and insert into them</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dft</span><span class="p">)</span>

        <span class="n">xc_functional</span> <span class="o">=</span> <span class="n">Xc_Functional</span><span class="p">(</span><span class="n">functionals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xc_functionals</span><span class="p">)</span>
        <span class="n">xc</span> <span class="o">=</span> <span class="n">Section</span><span class="p">(</span><span class="s2">&quot;XC&quot;</span><span class="p">,</span> <span class="n">subsections</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;XC_FUNCTIONAL&quot;</span><span class="p">:</span> <span class="n">xc_functional</span><span class="p">})</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">][</span><span class="s2">&quot;DFT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">xc</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">][</span><span class="s2">&quot;DFT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Section</span><span class="p">(</span><span class="s2">&quot;PRINT&quot;</span><span class="p">,</span> <span class="n">subsections</span><span class="o">=</span><span class="p">{}))</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">Molecule</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">activate_nonperiodic</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;print_forces&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_forces</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;print_dos&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_dos</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;print_pdos&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_pdos</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;print_ldos&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_ldos</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;print_mo_cubes&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_mo_cubes</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;print_v_hartree&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_v_hartree</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;print_e_density&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_e_density</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;print_bandstructure&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_bandstructure</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kpoints_line_density&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">override_default_params</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

<div class="viewcode-block" id="DftSet.get_basis_and_potential"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.get_basis_and_potential">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_basis_and_potential</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">basis_and_potential</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a dictionary of basis and potential info for constructing the input file.</span>

<span class="sd">        data in basis_and_potential argument can be specified in several ways:</span>

<span class="sd">            Strategy 1: Element-specific info (takes precedence)</span>

<span class="sd">                1. Provide a basis and potential object:</span>

<span class="sd">                    el: {&#39;basis&#39;: obj, &#39;potential&#39;: obj}</span>

<span class="sd">                2. Provide a hash of the object that matches the keys in the pmg configured cp2k data files.</span>

<span class="sd">                    el: {&#39;basis&#39;: hash, &#39;potential&#39;: hash}</span>

<span class="sd">                3. Provide the name of the basis and potential AND the basis_filenames and potential_filename</span>
<span class="sd">                keywords specifying where to find these objects</span>

<span class="sd">                    el: {</span>
<span class="sd">                        &#39;basis&#39;: name, &#39;potential&#39;: name, &#39;basis_filenames&#39;: [filenames],</span>
<span class="sd">                        &#39;potential_filename&#39;: filename</span>
<span class="sd">                    }</span>

<span class="sd">            Strategy 2: global descriptors</span>

<span class="sd">                In this case, any elements not present in the argument will be dealt with by searching the pmg</span>
<span class="sd">                configured cp2k data files to find a objects matching your requirements.</span>

<span class="sd">                    - functional: Find potential and basis that have been optimized for a specific functional like PBE.</span>
<span class="sd">                        Can be None if you do not require them to match.</span>
<span class="sd">                    - basis_type: type of basis to search for (e.g. DZVP-MOLOPT).</span>
<span class="sd">                    - aux_basis_type: type of basis to search for (e.g. pFIT). Some elements do not have all aux types</span>
<span class="sd">                        available. Use aux_basis_type that is universal to avoid issues, or avoid using this strategy.</span>
<span class="sd">                    - potential_type: &quot;Pseudopotential&quot; or &quot;All Electron&quot;</span>

<span class="sd">                ***BE WARNED*** CP2K data objects can have the same name, this will sort those and choose the first one</span>
<span class="sd">                that matches.</span>

<span class="sd">        Will raise an error if no basis/potential info can be found according to the input.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;basis_filenames&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">functional</span> <span class="o">=</span> <span class="n">basis_and_potential</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;functional&quot;</span><span class="p">,</span> <span class="n">SETTINGS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PMG_DEFAULT_CP2K_FUNCTIONAL&quot;</span><span class="p">))</span>
        <span class="n">basis_type</span> <span class="o">=</span> <span class="n">basis_and_potential</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;basis_type&quot;</span><span class="p">,</span> <span class="n">SETTINGS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PMG_DEFAULT_CP2K_BASIS_TYPE&quot;</span><span class="p">))</span>
        <span class="n">potential_type</span> <span class="o">=</span> <span class="n">basis_and_potential</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;potential_type&quot;</span><span class="p">,</span> <span class="n">SETTINGS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PMG_DEFAULT_POTENTIAL_TYPE&quot;</span><span class="p">,</span> <span class="s2">&quot;Pseudopotential&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">aux_basis_type</span> <span class="o">=</span> <span class="n">basis_and_potential</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;aux_basis_type&quot;</span><span class="p">,</span> <span class="n">SETTINGS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PMG_DEFAULT_CP2K_AUX_BASIS_TYPE&quot;</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">structure</span><span class="o">.</span><span class="n">symbol_set</span><span class="p">:</span>
            <span class="n">possible_basis_sets</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">possible_potentials</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">basis</span><span class="p">,</span> <span class="n">aux_basis</span><span class="p">,</span> <span class="n">potential</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="n">desired_basis</span><span class="p">,</span> <span class="n">desired_aux_basis</span><span class="p">,</span> <span class="n">desired_potential</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="n">have_element_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PMG_CP2K_DATA_DIR&quot;</span><span class="p">),</span> <span class="n">el</span><span class="p">))</span>

            <span class="c1"># Necessary if matching data to cp2k data files</span>
            <span class="k">if</span> <span class="n">have_element_file</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PMG_CP2K_DATA_DIR&quot;</span><span class="p">),</span> <span class="n">el</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">yaml</span> <span class="o">=</span> <span class="n">YAML</span><span class="p">(</span><span class="n">typ</span><span class="o">=</span><span class="s2">&quot;unsafe&quot;</span><span class="p">,</span> <span class="n">pure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">DATA</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">DATA</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;basis_sets&quot;</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No standard basis sets available in data directory for </span><span class="si">{</span><span class="n">el</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">DATA</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;potentials&quot;</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No standard potentials available in data directory for </span><span class="si">{</span><span class="n">el</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Give precedence to explicitly listing info for the element</span>
            <span class="k">if</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">basis_and_potential</span><span class="p">:</span>
                <span class="n">_basis</span> <span class="o">=</span> <span class="n">basis_and_potential</span><span class="p">[</span><span class="n">el</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;basis&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_basis</span><span class="p">,</span> <span class="n">GaussianTypeOrbitalBasisSet</span><span class="p">):</span>
                    <span class="n">possible_basis_sets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_basis</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">have_element_file</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">_basis</span> <span class="ow">in</span> <span class="n">DATA</span><span class="p">[</span><span class="s2">&quot;basis_sets&quot;</span><span class="p">]:</span>
                        <span class="n">possible_basis_sets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GaussianTypeOrbitalBasisSet</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">DATA</span><span class="p">[</span><span class="s2">&quot;basis_sets&quot;</span><span class="p">][</span><span class="n">_basis</span><span class="p">]))</span>
                    <span class="k">elif</span> <span class="n">_basis</span><span class="p">:</span>
                        <span class="n">desired_basis</span> <span class="o">=</span> <span class="n">GaussianTypeOrbitalBasisSet</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">_basis</span><span class="p">)</span>

                <span class="n">_aux_basis</span> <span class="o">=</span> <span class="n">basis_and_potential</span><span class="p">[</span><span class="n">el</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;aux_basis&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_aux_basis</span><span class="p">,</span> <span class="n">GaussianTypeOrbitalBasisSet</span><span class="p">):</span>
                    <span class="n">aux_basis</span> <span class="o">=</span> <span class="n">_aux_basis</span>
                <span class="k">elif</span> <span class="n">have_element_file</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">_aux_basis</span> <span class="ow">in</span> <span class="n">DATA</span><span class="p">[</span><span class="s2">&quot;basis_sets&quot;</span><span class="p">]:</span>
                        <span class="n">aux_basis</span> <span class="o">=</span> <span class="n">GaussianTypeOrbitalBasisSet</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">DATA</span><span class="p">[</span><span class="s2">&quot;basis_sets&quot;</span><span class="p">][</span><span class="n">_aux_basis</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="n">_aux_basis</span><span class="p">:</span>
                        <span class="n">desired_aux_basis</span> <span class="o">=</span> <span class="n">GaussianTypeOrbitalBasisSet</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">_aux_basis</span><span class="p">)</span>

                <span class="n">_potential</span> <span class="o">=</span> <span class="n">basis_and_potential</span><span class="p">[</span><span class="n">el</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;potential&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_potential</span><span class="p">,</span> <span class="n">GthPotential</span><span class="p">):</span>
                    <span class="n">possible_potentials</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_potential</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">have_element_file</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">_potential</span> <span class="ow">in</span> <span class="n">DATA</span><span class="p">[</span><span class="s2">&quot;potentials&quot;</span><span class="p">]:</span>
                        <span class="n">possible_potentials</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GthPotential</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">DATA</span><span class="p">[</span><span class="s2">&quot;potentials&quot;</span><span class="p">][</span><span class="n">_potential</span><span class="p">]))</span>
                    <span class="k">elif</span> <span class="n">_potential</span><span class="p">:</span>
                        <span class="n">desired_potential</span> <span class="o">=</span> <span class="n">GthPotential</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">_potential</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">basis_and_potential</span><span class="p">[</span><span class="n">el</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;basis_filename&quot;</span><span class="p">):</span>
                    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;basis_filenames&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">basis_and_potential</span><span class="p">[</span><span class="n">el</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;basis_filename&quot;</span><span class="p">))</span>
                <span class="n">pfn1</span> <span class="o">=</span> <span class="n">basis_and_potential</span><span class="p">[</span><span class="n">el</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;potential_filename&quot;</span><span class="p">)</span>
                <span class="n">pfn2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;potential_filename&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pfn1</span> <span class="ow">and</span> <span class="n">pfn2</span> <span class="ow">and</span> <span class="n">pfn1</span> <span class="o">!=</span> <span class="n">pfn2</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Provided potentials have more than one corresponding file.&quot;</span>
                        <span class="s2">&quot;CP2K does not support multiple potential filenames&quot;</span>
                    <span class="p">)</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;potential_filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis_and_potential</span><span class="p">[</span><span class="n">el</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;potential_filename&quot;</span><span class="p">)</span>

            <span class="c1"># Else, if functional/basis settings are provided, create objects to search the data files</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">basis_type</span> <span class="ow">and</span> <span class="n">have_element_file</span><span class="p">:</span>
                    <span class="n">desired_basis</span> <span class="o">=</span> <span class="n">GaussianTypeOrbitalBasisSet</span><span class="p">(</span>
                        <span class="n">element</span><span class="o">=</span><span class="n">Element</span><span class="p">(</span><span class="n">el</span><span class="p">),</span>
                        <span class="n">potential</span><span class="o">=</span><span class="n">potential_type</span><span class="p">,</span>
                        <span class="n">info</span><span class="o">=</span><span class="n">BasisInfo</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">basis_type</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">functional</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="n">desired_potential</span> <span class="o">=</span> <span class="n">GthPotential</span><span class="p">(</span>
                        <span class="n">element</span><span class="o">=</span><span class="n">Element</span><span class="p">(</span><span class="n">el</span><span class="p">),</span> <span class="n">potential</span><span class="o">=</span><span class="n">potential_type</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">PotentialInfo</span><span class="p">(</span><span class="n">xc</span><span class="o">=</span><span class="n">functional</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">aux_basis_type</span> <span class="ow">and</span> <span class="n">have_element_file</span><span class="p">:</span>
                    <span class="n">desired_aux_basis</span> <span class="o">=</span> <span class="n">GaussianTypeOrbitalBasisSet</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="n">BasisInfo</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">aux_basis_type</span><span class="p">))</span>

            <span class="c1"># If basis/potential are not explicit, match the desired ones to available ones in the element file</span>
            <span class="k">if</span> <span class="n">desired_basis</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">_possible_basis</span> <span class="ow">in</span> <span class="n">DATA</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;basis_sets&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">possible_basis</span> <span class="o">=</span> <span class="n">GaussianTypeOrbitalBasisSet</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">_possible_basis</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">desired_basis</span><span class="o">.</span><span class="n">softmatch</span><span class="p">(</span><span class="n">possible_basis</span><span class="p">):</span>
                        <span class="n">possible_basis_sets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">possible_basis</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">desired_aux_basis</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">_possible_basis</span> <span class="ow">in</span> <span class="n">DATA</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;basis_sets&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">possible_basis</span> <span class="o">=</span> <span class="n">GaussianTypeOrbitalBasisSet</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">_possible_basis</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">desired_aux_basis</span><span class="o">.</span><span class="n">softmatch</span><span class="p">(</span><span class="n">possible_basis</span><span class="p">):</span>
                        <span class="n">aux_basis</span> <span class="o">=</span> <span class="n">possible_basis</span>
                        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;basis_filenames&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aux_basis</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="n">desired_potential</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">_possible_potential</span> <span class="ow">in</span> <span class="n">DATA</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;potentials&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">possible_potential</span> <span class="o">=</span> <span class="n">GthPotential</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">_possible_potential</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">desired_potential</span><span class="o">.</span><span class="n">softmatch</span><span class="p">(</span><span class="n">possible_potential</span><span class="p">):</span>
                        <span class="n">possible_potentials</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">possible_potential</span><span class="p">)</span>

            <span class="n">possible_basis_sets</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">electrons</span><span class="p">,</span> <span class="n">possible_basis_sets</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">electrons</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">possible_potentials</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">electrons</span><span class="p">,</span> <span class="n">possible_potentials</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">electrons</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

            <span class="k">def</span> <span class="nf">match_elecs</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">possible_potentials</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">electrons</span> <span class="o">==</span> <span class="n">p</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">electrons</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">p</span>

            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">possible_basis_sets</span><span class="p">:</span>
                <span class="n">fb</span> <span class="o">=</span> <span class="n">match_elecs</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">basis</span> <span class="o">=</span> <span class="n">b</span>
                    <span class="n">potential</span> <span class="o">=</span> <span class="n">fb</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">basis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">basis_and_potential</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;basis&quot;</span><span class="p">):</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to validate basis for </span><span class="si">{</span><span class="n">el</span><span class="si">}</span><span class="s2">. Exact name provided will be put in input file.&quot;</span><span class="p">)</span>
                    <span class="n">basis</span> <span class="o">=</span> <span class="n">basis_and_potential</span><span class="p">[</span><span class="n">el</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;basis&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No explicit basis found and matching has failed.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">aux_basis</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">basis_and_potential</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;aux_basis&quot;</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unable to validate auxiliary basis for </span><span class="si">{</span><span class="n">el</span><span class="si">}</span><span class="s2">. Exact name provided will be put in input file.&quot;</span>
                <span class="p">)</span>
                <span class="n">aux_basis</span> <span class="o">=</span> <span class="n">basis_and_potential</span><span class="p">[</span><span class="n">el</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;aux_basis&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">potential</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">basis_and_potential</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;potential&quot;</span><span class="p">):</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Unable to validate potential for </span><span class="si">{</span><span class="n">el</span><span class="si">}</span><span class="s2">. &quot;</span> <span class="s2">&quot; Exact name provided will be put in input file.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">potential</span> <span class="o">=</span> <span class="n">basis_and_potential</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;potential&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No explicit potential found and matching has failed.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">basis</span><span class="o">.</span><span class="n">filename</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;basis_filenames&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">pfn1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;potential_filename&quot;</span><span class="p">)</span>
            <span class="n">pfn2</span> <span class="o">=</span> <span class="n">potential</span><span class="o">.</span><span class="n">filename</span>
            <span class="k">if</span> <span class="n">pfn1</span> <span class="ow">and</span> <span class="n">pfn2</span> <span class="ow">and</span> <span class="n">pfn1</span> <span class="o">!=</span> <span class="n">pfn2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Provided potentials have more than one corresponding file.&quot;</span>
                    <span class="s2">&quot;CP2K does not support multiple potential filenames&quot;</span>
                <span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;potential_filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pfn2</span>

            <span class="n">data</span><span class="p">[</span><span class="n">el</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;basis&quot;</span><span class="p">:</span> <span class="n">basis</span><span class="p">,</span>
                <span class="s2">&quot;aux_basis&quot;</span><span class="p">:</span> <span class="n">aux_basis</span><span class="p">,</span>
                <span class="s2">&quot;potential&quot;</span><span class="p">:</span> <span class="n">potential</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="DftSet.get_cutoff_from_basis"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.get_cutoff_from_basis">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_cutoff_from_basis</span><span class="p">(</span><span class="n">basis_sets</span><span class="p">,</span> <span class="n">rel_cutoff</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Given a basis and a relative cutoff. Determine the ideal cutoff variable&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">basis_sets</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="o">.</span><span class="n">exponents</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Basis set </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2"> contains missing exponent info. Please specify cutoff manually&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_soft_exponents</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">potential</span> <span class="o">==</span> <span class="s2">&quot;All Electron&quot;</span><span class="p">:</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="mf">1.2</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="n">Element</span><span class="p">(</span><span class="s2">&quot;H&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mf">1.512</span>  <span class="c1"># Hard radius defaults for gapw</span>
                <span class="n">threshold</span> <span class="o">=</span> <span class="mf">1e-4</span>  <span class="c1"># Default for gapw</span>
                <span class="n">max_lshell</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">lmax</span><span class="p">)</span>
                <span class="n">exponent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">radius</span><span class="o">**</span><span class="n">max_lshell</span> <span class="o">/</span> <span class="n">threshold</span><span class="p">)</span> <span class="o">/</span> <span class="n">radius</span><span class="o">**</span><span class="mi">2</span>
                <span class="k">return</span> <span class="p">[[</span><span class="n">exponent</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="n">exponents</span>

        <span class="n">exponents</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_soft_exponents</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">basis_sets</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">exponents</span><span class="p">]</span>
        <span class="n">exponents</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">exponents</span><span class="p">))</span>
        <span class="n">cutoff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">exponents</span><span class="p">)))</span> <span class="o">*</span> <span class="n">rel_cutoff</span>
        <span class="k">return</span> <span class="n">cutoff</span></div>

<div class="viewcode-block" id="DftSet.get_xc_functionals"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.get_xc_functionals">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_xc_functionals</span><span class="p">(</span><span class="n">xc_functionals</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get XC functionals. If simplified names are provided in kwargs, they</span>
<span class="sd">        will be expanded into their corresponding X and C names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">xc_functionals</span> <span class="k">if</span> <span class="n">xc_functionals</span> <span class="k">else</span> <span class="n">SETTINGS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PMG_DEFAULT_CP2K_FUNCTIONAL&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No XC functional provided. Specify kwarg xc_functional or configure your pmgrc.yaml file&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">names</span><span class="p">]</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>
        <span class="n">cp2k_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;LDA&quot;</span><span class="p">,</span> <span class="s2">&quot;LSDA&quot;</span><span class="p">]:</span>
                <span class="n">cp2k_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;PADE&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;SCAN&quot;</span><span class="p">:</span>
                <span class="n">cp2k_names</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;MGGA_X_SCAN&quot;</span><span class="p">,</span> <span class="s2">&quot;MGGA_C_SCAN&quot;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;SCANL&quot;</span><span class="p">:</span>
                <span class="n">cp2k_names</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;MGGA_X_SCANL&quot;</span><span class="p">,</span> <span class="s2">&quot;MGGA_C_SCANL&quot;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;R2SCAN&quot;</span><span class="p">:</span>
                <span class="n">cp2k_names</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;MGGA_X_R2SCAN&quot;</span><span class="p">,</span> <span class="s2">&quot;MGGA_C_R2SCAN&quot;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;R2SCANL&quot;</span><span class="p">:</span>
                <span class="n">cp2k_names</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;MGGA_X_R2SCANL&quot;</span><span class="p">,</span> <span class="s2">&quot;MGGA_C_R2SCANL&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cp2k_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cp2k_names</span></div>

<div class="viewcode-block" id="DftSet.write_basis_set_file"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.write_basis_set_file">[docs]</a>    <span class="k">def</span> <span class="nf">write_basis_set_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">basis_sets</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="s2">&quot;BASIS&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Write the basis sets to a file&quot;&quot;&quot;</span>
        <span class="n">BasisFile</span><span class="p">(</span><span class="n">objects</span><span class="o">=</span><span class="n">basis_sets</span><span class="p">)</span><span class="o">.</span><span class="n">write_file</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span></div>

<div class="viewcode-block" id="DftSet.write_potential_file"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.write_potential_file">[docs]</a>    <span class="k">def</span> <span class="nf">write_potential_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">potentials</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="s2">&quot;POTENTIAL&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Write the potentials to a file&quot;&quot;&quot;</span>
        <span class="n">PotentialFile</span><span class="p">(</span><span class="n">objects</span><span class="o">=</span><span class="n">potentials</span><span class="p">)</span><span class="o">.</span><span class="n">write_file</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span></div>

<div class="viewcode-block" id="DftSet.print_forces"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.print_forces">[docs]</a>    <span class="k">def</span> <span class="nf">print_forces</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print out the forces and stress during calculation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Section</span><span class="p">(</span><span class="s2">&quot;PRINT&quot;</span><span class="p">,</span> <span class="n">subsections</span><span class="o">=</span><span class="p">{}))</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">][</span><span class="s2">&quot;PRINT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Section</span><span class="p">(</span><span class="s2">&quot;FORCES&quot;</span><span class="p">,</span> <span class="n">subsections</span><span class="o">=</span><span class="p">{}))</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">][</span><span class="s2">&quot;PRINT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Section</span><span class="p">(</span><span class="s2">&quot;STRESS_TENSOR&quot;</span><span class="p">,</span> <span class="n">subsections</span><span class="o">=</span><span class="p">{}))</span></div>

<div class="viewcode-block" id="DftSet.print_dos"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.print_dos">[docs]</a>    <span class="k">def</span> <span class="nf">print_dos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ndigits</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Activate printing of the overall DOS file.</span>

<span class="sd">        Note: As of 2022.1, ndigits needs to be set to a sufficient value to ensure data is not lost.</span>
<span class="sd">        Note: As of 2022.1, can only be used with a k-point calculation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;force_eval&quot;</span><span class="p">][</span><span class="s2">&quot;dft&quot;</span><span class="p">][</span><span class="s2">&quot;print&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">DOS</span><span class="p">(</span><span class="n">ndigits</span><span class="p">))</span></div>

<div class="viewcode-block" id="DftSet.print_pdos"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.print_pdos">[docs]</a>    <span class="k">def</span> <span class="nf">print_pdos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nlumo</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Activate creation of the PDOS file.</span>

<span class="sd">        Args:</span>
<span class="sd">            nlumo (int): Number of virtual orbitals to be added to the MO set (-1=all).</span>
<span class="sd">                CAUTION: Setting this value to be higher than the number of states present may</span>
<span class="sd">                cause a Cholesky error.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s2">&quot;FORCE_EVAL/DFT/PRINT/PDOS&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">][</span><span class="s2">&quot;DFT&quot;</span><span class="p">][</span><span class="s2">&quot;PRINT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">PDOS</span><span class="p">(</span><span class="n">nlumo</span><span class="o">=</span><span class="n">nlumo</span><span class="p">))</span></div>

<div class="viewcode-block" id="DftSet.print_ldos"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.print_ldos">[docs]</a>    <span class="k">def</span> <span class="nf">print_ldos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nlumo</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Activate the printing of LDOS files, printing one for each atom kind by default</span>

<span class="sd">        Args:</span>
<span class="sd">            nlumo (int): Number of virtual orbitals to be added to the MO set (-1=all).</span>
<span class="sd">                CAUTION: Setting this value to be higher than the number of states present may</span>
<span class="sd">                cause a Cholesky error.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s2">&quot;FORCE_EVAL/DFT/PRINT/PDOS&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">][</span><span class="s2">&quot;DFT&quot;</span><span class="p">][</span><span class="s2">&quot;PRINT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">PDOS</span><span class="p">(</span><span class="n">nlumo</span><span class="o">=</span><span class="n">nlumo</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">num_sites</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">][</span><span class="s2">&quot;DFT&quot;</span><span class="p">][</span><span class="s2">&quot;PRINT&quot;</span><span class="p">][</span><span class="s2">&quot;PDOS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">LDOS</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;LDOS </span><span class="si">{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span></div>

<div class="viewcode-block" id="DftSet.print_mo_cubes"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.print_mo_cubes">[docs]</a>    <span class="k">def</span> <span class="nf">print_mo_cubes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">write_cube</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">nlumo</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">nhomo</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Activate printing of molecular orbitals.</span>

<span class="sd">        Args:</span>
<span class="sd">            write_cube (bool): whether to write cube file for the MOs instead of out file</span>
<span class="sd">            nlumo (int): Controls the number of lumos printed and dumped as a cube (-1=all)</span>
<span class="sd">            nhomo (int): Controls the number of homos printed and dumped as a cube (-1=all)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s2">&quot;FORCE_EVAL/DFT/PRINT/MO_CUBES&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">][</span><span class="s2">&quot;DFT&quot;</span><span class="p">][</span><span class="s2">&quot;PRINT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">MO_Cubes</span><span class="p">(</span><span class="n">write_cube</span><span class="o">=</span><span class="n">write_cube</span><span class="p">,</span> <span class="n">nlumo</span><span class="o">=</span><span class="n">nlumo</span><span class="p">,</span> <span class="n">nhomo</span><span class="o">=</span><span class="n">nhomo</span><span class="p">))</span></div>

<div class="viewcode-block" id="DftSet.print_mo"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.print_mo">[docs]</a>    <span class="k">def</span> <span class="nf">print_mo</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print molecular orbitals when running non-OT diagonalization</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="DftSet.print_v_hartree"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.print_v_hartree">[docs]</a>    <span class="k">def</span> <span class="nf">print_v_hartree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Controls the printing of a cube file with eletrostatic potential generated by the</span>
<span class="sd">            total density (electrons+ions). It is valid only for QS with GPW formalism.</span>
<span class="sd">        Note that by convention the potential has opposite sign than the expected physical one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s2">&quot;FORCE_EVAL/DFT/PRINT/V_HARTREE_CUBE&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">][</span><span class="s2">&quot;DFT&quot;</span><span class="p">][</span><span class="s2">&quot;PRINT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">V_Hartree_Cube</span><span class="p">(</span><span class="n">keywords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;STRIDE&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;STRIDE&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">stride</span><span class="p">)}))</span></div>

<div class="viewcode-block" id="DftSet.print_e_density"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.print_e_density">[docs]</a>    <span class="k">def</span> <span class="nf">print_e_density</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Controls the printing of cube files with electronic density and, for UKS, the spin density</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s2">&quot;FORCE_EVAL/DFT/PRINT/E_DENSITY_CUBE&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">][</span><span class="s2">&quot;DFT&quot;</span><span class="p">][</span><span class="s2">&quot;PRINT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">E_Density_Cube</span><span class="p">(</span><span class="n">keywords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;STRIDE&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;STRIDE&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">stride</span><span class="p">)}))</span></div>

<div class="viewcode-block" id="DftSet.print_bandstructure"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.print_bandstructure">[docs]</a>    <span class="k">def</span> <span class="nf">print_bandstructure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kpoints_line_density</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attaches a non-scf band structure calc the end of an SCF loop.</span>

<span class="sd">        This requires a kpoint calculation, which is not always default in cp2k.</span>

<span class="sd">        Args:</span>
<span class="sd">            kpoints_line_density: number of kpoints along each branch in line-mode calc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Kpoints must be provided to enable band structure printing&quot;</span><span class="p">)</span>

        <span class="n">bs</span> <span class="o">=</span> <span class="n">Band_Structure</span><span class="o">.</span><span class="n">from_kpoints</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">,</span>
            <span class="n">kpoints_line_density</span><span class="o">=</span><span class="n">kpoints_line_density</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;force_eval&quot;</span><span class="p">][</span><span class="s2">&quot;dft&quot;</span><span class="p">][</span><span class="s2">&quot;print&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">bs</span><span class="p">)</span></div>

<div class="viewcode-block" id="DftSet.print_hirshfeld"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.print_hirshfeld">[docs]</a>    <span class="k">def</span> <span class="nf">print_hirshfeld</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Activate or deactivate printing of Hirshfeld charges&quot;&quot;&quot;</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">Section</span><span class="p">(</span><span class="s2">&quot;HIRSHFELD&quot;</span><span class="p">,</span> <span class="n">section_parameters</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ON&quot;</span> <span class="k">if</span> <span class="n">on</span> <span class="k">else</span> <span class="s2">&quot;OFF&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;force_eval&quot;</span><span class="p">][</span><span class="s2">&quot;dft&quot;</span><span class="p">][</span><span class="s2">&quot;print&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">section</span><span class="p">)</span></div>

<div class="viewcode-block" id="DftSet.print_mulliken"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.print_mulliken">[docs]</a>    <span class="k">def</span> <span class="nf">print_mulliken</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Activate or deactivate printing of Mulliken charges&quot;&quot;&quot;</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">Section</span><span class="p">(</span><span class="s2">&quot;MULLIKEN&quot;</span><span class="p">,</span> <span class="n">section_parameters</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ON&quot;</span> <span class="k">if</span> <span class="n">on</span> <span class="k">else</span> <span class="s2">&quot;OFF&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;force_eval&quot;</span><span class="p">][</span><span class="s2">&quot;dft&quot;</span><span class="p">][</span><span class="s2">&quot;print&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">section</span><span class="p">)</span></div>

<div class="viewcode-block" id="DftSet.set_charge"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.set_charge">[docs]</a>    <span class="k">def</span> <span class="nf">set_charge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">charge</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set the overall charge of the simulation cell&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">][</span><span class="s2">&quot;DFT&quot;</span><span class="p">][</span><span class="s2">&quot;CHARGE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;CHARGE&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">charge</span><span class="p">))</span></div>

<div class="viewcode-block" id="DftSet.activate_hybrid"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.activate_hybrid">[docs]</a>    <span class="k">def</span> <span class="nf">activate_hybrid</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">hybrid_functional</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;PBE0&quot;</span><span class="p">,</span>
        <span class="n">hf_fraction</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span>
        <span class="n">gga_x_fraction</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.75</span><span class="p">,</span>
        <span class="n">gga_c_fraction</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">max_memory</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span>
        <span class="n">cutoff_radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">8.0</span><span class="p">,</span>
        <span class="n">potential_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">omega</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.11</span><span class="p">,</span>
        <span class="n">scale_coulomb</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">scale_gaussian</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">scale_longrange</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">admm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">admm_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;BASIS_PROJECTION&quot;</span><span class="p">,</span>
        <span class="n">admm_purification_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;NONE&quot;</span><span class="p">,</span>
        <span class="n">admm_exch_correction_func</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;DEFAULT&quot;</span><span class="p">,</span>
        <span class="n">eps_schwarz</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-7</span><span class="p">,</span>
        <span class="n">eps_schwarz_forces</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">,</span>
        <span class="n">screen_on_initial_p</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">screen_p_forces</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Basic set for activating hybrid DFT calculation using Auxiliary Density Matrix Method.</span>

<span class="sd">        Note 1: When running ADMM with cp2k, memory is very important. If the memory requirements</span>
<span class="sd">        exceed what is available (see max_memory), then CP2K will have to calculate the 4-electron</span>
<span class="sd">        integrals for HFX during each step of the SCF cycle. ADMM provides a huge speed up by</span>
<span class="sd">        making the memory requirements *feasible* to fit into RAM, which means you only need to</span>
<span class="sd">        calculate the integrals once each SCF cycle. But, this only works if it fits into memory.</span>
<span class="sd">        When setting up ADMM calculations, we recommend doing whatever is possible to fit all the</span>
<span class="sd">        4EI into memory.</span>

<span class="sd">        Note 2: This set is designed for reliable high-throughput calculations, NOT for extreme</span>
<span class="sd">        accuracy. Please review the in-line comments in this method if you want more control.</span>

<span class="sd">        Args:</span>
<span class="sd">            hybrid_functional (str): Type of hybrid functional. This set supports HSE (screened)</span>
<span class="sd">                and PBE0 (truncated). Default is PBE0, which converges easier in the GPW basis</span>
<span class="sd">                used by cp2k.</span>
<span class="sd">            hf_fraction (float): fraction of exact HF exchange energy to mix. Default: 0.25</span>
<span class="sd">            gga_x_fraction (float): fraction of gga exchange energy to retain. Default: 0.75</span>
<span class="sd">            gga_c_fraction (float): fraction of gga correlation energy to retain. Default: 1.0</span>
<span class="sd">            max_memory (int): Maximum memory available to each MPI process (in Mb) in the</span>
<span class="sd">                calculation. Most modern computing nodes will have ~2Gb per core, or 2048 Mb,</span>
<span class="sd">                but check for your specific system. This value should be as large as possible</span>
<span class="sd">                while still leaving some memory for the other parts of cp2k. Important: If</span>
<span class="sd">                this value is set larger than the memory limits, CP2K will likely seg-fault.</span>
<span class="sd">                Default: 2000</span>
<span class="sd">            cutoff_radius (float): for truncated hybrid functional (i.e. PBE0), this is the cutoff</span>
<span class="sd">                radius. The default is selected as that which generally gives convergence, but</span>
<span class="sd">                maybe too low (if you want very high accuracy) or too high (if you want a quick</span>
<span class="sd">                screening). Default: 8 angstroms</span>
<span class="sd">            potential_type (str): what interaction potential to use for HFX. Available in CP2K are</span>
<span class="sd">                COULOMB, GAUSSIAN, IDENTITY, LOGRANGE, MIX_CL, MIX_CL_TRUNC, MIX_LG, SHORTRANGE,</span>
<span class="sd">                and TRUNCATED. Default is None, and it will be set automatically depending on the</span>
<span class="sd">                named hybrid_functional that you use, but setting it to one of the acceptable</span>
<span class="sd">                values will constitute a user-override.</span>
<span class="sd">            omega (float): For HSE, this specifies the screening parameter. HSE06 sets this as</span>
<span class="sd">                0.2, which is the default.</span>
<span class="sd">            scale_coulomb: Scale for the coulomb operator if using a range separated functional</span>
<span class="sd">            scale_gaussian: Scale for the gaussian operator (if applicable)</span>
<span class="sd">            scale_longrange: Scale for the coulomb operator if using a range separated functional</span>
<span class="sd">            admm: Whether or not to use the auxiliary density matrix method for the exact</span>
<span class="sd">                HF exchange contribution. Highly recommended. Speed ups between 10x and 1000x are</span>
<span class="sd">                possible when compared to non ADMM hybrid calculations.</span>
<span class="sd">            admm_method: Method for constructing the auxiliary basis</span>
<span class="sd">            admm_purification_method: Method for purifying the auxiliary density matrix so as to</span>
<span class="sd">                preserve properties, such as idempotency. May lead to shifts in the</span>
<span class="sd">                eigenvalues.</span>
<span class="sd">            admm_exch_correction_func: Which functional to use to calculate the exchange correction</span>
<span class="sd">                E_x(primary) - E_x(aux)</span>
<span class="sd">            eps_schwarz: Screening threshold for HFX, in Ha. Contributions smaller than</span>
<span class="sd">                this will be screened. The smaller the value, the more accurate, but also the more</span>
<span class="sd">                costly. Default value is 1e-7. 1e-6 works in a large number of cases, but is</span>
<span class="sd">                quite aggressive, which can lead to convergence issues.</span>
<span class="sd">            eps_schwarz_forces: Same as for eps_schwarz, but for screening contributions to</span>
<span class="sd">                forces. Convergence is not as sensitive with respect to eps_schwarz forces as</span>
<span class="sd">                compared to eps_schwarz, and so 1e-6 should be good default.</span>
<span class="sd">            screen_on_initial_p: If an initial density matrix is provided, in the form of a</span>
<span class="sd">                CP2K wfn restart file, then this initial density will be used for screening. This</span>
<span class="sd">                is generally very computationally efficient, but, as with eps_schwarz, can lead to</span>
<span class="sd">                instabilities if the initial density matrix is poor.</span>
<span class="sd">            screen_p_forces: Same as screen_on_initial_p, but for screening of forces.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">admm</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_and_potential</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="s2">&quot;aux_basis&quot;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_and_potential</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;aux_basis&quot;</span><span class="p">]</span>
            <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;force_eval&quot;</span><span class="p">][</span><span class="s2">&quot;subsys&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_subsys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">aux_matrix_params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;ADMM_PURIFICATION_METHOD&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;ADMM_PURIFICATION_METHOD&quot;</span><span class="p">,</span> <span class="n">admm_purification_method</span><span class="p">),</span>
                <span class="s2">&quot;METHOD&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;METHOD&quot;</span><span class="p">,</span> <span class="n">admm_method</span><span class="p">),</span>
                <span class="s2">&quot;EXCH_CORRECTION_FUNC&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;EXCH_CORRECTION_FUNC&quot;</span><span class="p">,</span> <span class="n">admm_exch_correction_func</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="n">aux_matrix</span> <span class="o">=</span> <span class="n">Section</span><span class="p">(</span>
                <span class="s2">&quot;AUXILIARY_DENSITY_MATRIX_METHOD&quot;</span><span class="p">,</span>
                <span class="n">keywords</span><span class="o">=</span><span class="n">aux_matrix_params</span><span class="p">,</span>
                <span class="n">subsections</span><span class="o">=</span><span class="p">{},</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subsections</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">][</span><span class="s2">&quot;DFT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">aux_matrix</span><span class="p">)</span>

        <span class="c1"># Define the GGA functional as PBE</span>
        <span class="n">screening</span> <span class="o">=</span> <span class="n">Section</span><span class="p">(</span>
            <span class="s2">&quot;SCREENING&quot;</span><span class="p">,</span>
            <span class="n">subsections</span><span class="o">=</span><span class="p">{},</span>
            <span class="n">keywords</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;EPS_SCHWARZ&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;EPS_SCHWARZ&quot;</span><span class="p">,</span> <span class="n">eps_schwarz</span><span class="p">),</span>
                <span class="s2">&quot;EPS_SCHWARZ_FORCES&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;EPS_SCHWARZ_FORCES&quot;</span><span class="p">,</span> <span class="n">eps_schwarz_forces</span><span class="p">),</span>
                <span class="s2">&quot;SCREEN_ON_INITIAL_P&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;SCREEN_ON_INITIAL_P&quot;</span><span class="p">,</span> <span class="n">screen_on_initial_p</span><span class="p">),</span>
                <span class="s2">&quot;SCREEN_P_FORCES&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;SCREEN_P_FORCES&quot;</span><span class="p">,</span> <span class="n">screen_p_forces</span><span class="p">),</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># Check for unphysical cutoff radius</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">Structure</span><span class="p">):</span>
            <span class="n">max_cutoff_radius</span> <span class="o">=</span> <span class="n">get_truncated_coulomb_cutoff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_cutoff_radius</span> <span class="o">&lt;</span> <span class="n">cutoff_radius</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;Provided cutoff radius exceeds half the minimum&quot;</span>
                    <span class="s2">&quot; distance between atoms. I hope you know what you&#39;re doing.&quot;</span>
                <span class="p">)</span>

        <span class="n">ip_keywords</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">hybrid_functional</span> <span class="o">==</span> <span class="s2">&quot;HSE06&quot;</span><span class="p">:</span>
            <span class="n">pbe</span> <span class="o">=</span> <span class="n">PBE</span><span class="p">(</span><span class="s2">&quot;ORIG&quot;</span><span class="p">,</span> <span class="n">scale_c</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">scale_x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">xc_functional</span> <span class="o">=</span> <span class="n">Xc_Functional</span><span class="p">(</span><span class="n">functionals</span><span class="o">=</span><span class="p">[],</span> <span class="n">subsections</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;PBE&quot;</span><span class="p">:</span> <span class="n">pbe</span><span class="p">})</span>

            <span class="n">potential_type</span> <span class="o">=</span> <span class="n">potential_type</span> <span class="k">if</span> <span class="n">potential_type</span> <span class="k">else</span> <span class="s2">&quot;SHORTRANGE&quot;</span>
            <span class="n">xc_functional</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="n">Section</span><span class="p">(</span>
                    <span class="s2">&quot;XWPBE&quot;</span><span class="p">,</span>
                    <span class="n">subsections</span><span class="o">=</span><span class="p">{},</span>
                    <span class="n">keywords</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;SCALE_X0&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;SCALE_X0&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                        <span class="s2">&quot;SCALE_X&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;SCALE_X&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">),</span>
                        <span class="s2">&quot;OMEGA&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;OMEGA&quot;</span><span class="p">,</span> <span class="mf">0.11</span><span class="p">),</span>
                    <span class="p">},</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">ip_keywords</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;POTENTIAL_TYPE&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;POTENTIAL_TYPE&quot;</span><span class="p">,</span> <span class="n">potential_type</span><span class="p">),</span>
                    <span class="s2">&quot;OMEGA&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;OMEGA&quot;</span><span class="p">,</span> <span class="mf">0.11</span><span class="p">),</span>
                    <span class="s2">&quot;CUTOFF_RADIUS&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;CUTOFF_RADIUS&quot;</span><span class="p">,</span> <span class="n">cutoff_radius</span><span class="p">),</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">hybrid_functional</span> <span class="o">==</span> <span class="s2">&quot;PBE0&quot;</span><span class="p">:</span>
            <span class="n">pbe</span> <span class="o">=</span> <span class="n">PBE</span><span class="p">(</span><span class="s2">&quot;ORIG&quot;</span><span class="p">,</span> <span class="n">scale_c</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">scale_x</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span> <span class="n">hf_fraction</span><span class="p">)</span>
            <span class="n">xc_functional</span> <span class="o">=</span> <span class="n">Xc_Functional</span><span class="p">(</span><span class="n">functionals</span><span class="o">=</span><span class="p">[],</span> <span class="n">subsections</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;PBE&quot;</span><span class="p">:</span> <span class="n">pbe</span><span class="p">})</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">Molecule</span><span class="p">):</span>
                <span class="n">potential_type</span> <span class="o">=</span> <span class="s2">&quot;COULOMB&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">potential_type</span> <span class="o">=</span> <span class="s2">&quot;TRUNCATED&quot;</span>
                <span class="n">xc_functional</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                    <span class="n">Section</span><span class="p">(</span>
                        <span class="s2">&quot;PBE_HOLE_T_C_LR&quot;</span><span class="p">,</span>
                        <span class="n">subsections</span><span class="o">=</span><span class="p">{},</span>
                        <span class="n">keywords</span><span class="o">=</span><span class="p">{</span>
                            <span class="s2">&quot;CUTOFF_RADIUS&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;CUTOFF_RADIUS&quot;</span><span class="p">,</span> <span class="n">cutoff_radius</span><span class="p">),</span>
                            <span class="s2">&quot;SCALE_X&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;SCALE_X&quot;</span><span class="p">,</span> <span class="n">hf_fraction</span><span class="p">),</span>
                        <span class="p">},</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">ip_keywords</span><span class="p">[</span><span class="s2">&quot;CUTOFF_RADIUS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;CUTOFF_RADIUS&quot;</span><span class="p">,</span> <span class="n">cutoff_radius</span><span class="p">)</span>
                <span class="n">ip_keywords</span><span class="p">[</span><span class="s2">&quot;T_C_G_DATA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;T_C_G_DATA&quot;</span><span class="p">,</span> <span class="s2">&quot;t_c_g.dat&quot;</span><span class="p">)</span>

            <span class="n">ip_keywords</span><span class="p">[</span><span class="s2">&quot;POTENTIAL_TYPE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;POTENTIAL_TYPE&quot;</span><span class="p">,</span> <span class="n">potential_type</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">hybrid_functional</span> <span class="o">==</span> <span class="s2">&quot;RSH&quot;</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Activates range separated functional using mixing of the truncated</span>
<span class="sd">            coulomb operator and the long range operator using scale_longrange,</span>
<span class="sd">            scale_coulomb, cutoff_radius, and omega.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">pbe</span> <span class="o">=</span> <span class="n">PBE</span><span class="p">(</span><span class="s2">&quot;ORIG&quot;</span><span class="p">,</span> <span class="n">scale_c</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">scale_x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">xc_functional</span> <span class="o">=</span> <span class="n">Xc_Functional</span><span class="p">(</span><span class="n">functionals</span><span class="o">=</span><span class="p">[],</span> <span class="n">subsections</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;PBE&quot;</span><span class="p">:</span> <span class="n">pbe</span><span class="p">})</span>

            <span class="n">potential_type</span> <span class="o">=</span> <span class="n">potential_type</span> <span class="k">if</span> <span class="n">potential_type</span> <span class="k">else</span> <span class="s2">&quot;MIX_CL_TRUNC&quot;</span>
            <span class="n">hf_fraction</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">ip_keywords</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;POTENTIAL_TYPE&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;POTENTIAL_TYPE&quot;</span><span class="p">,</span> <span class="n">potential_type</span><span class="p">),</span>
                    <span class="s2">&quot;CUTOFF_RADIUS&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;CUTOFF_RADIUS&quot;</span><span class="p">,</span> <span class="n">cutoff_radius</span><span class="p">),</span>
                    <span class="s2">&quot;T_C_G_DATA&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;T_C_G_DATA&quot;</span><span class="p">,</span> <span class="s2">&quot;t_c_g.dat&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;OMEGA&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;OMEGA&quot;</span><span class="p">,</span> <span class="n">omega</span><span class="p">),</span>
                    <span class="s2">&quot;SCALE_COULOMB&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;SCALE_COULOMB&quot;</span><span class="p">,</span> <span class="n">scale_coulomb</span><span class="p">),</span>
                    <span class="s2">&quot;SCALE_LONGRANGE&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;SCALE_LONGRANGE&quot;</span><span class="p">,</span> <span class="n">scale_longrange</span> <span class="o">-</span> <span class="n">scale_coulomb</span><span class="p">),</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="n">xc_functional</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="n">Section</span><span class="p">(</span>
                    <span class="s2">&quot;XWPBE&quot;</span><span class="p">,</span>
                    <span class="n">subsections</span><span class="o">=</span><span class="p">{},</span>
                    <span class="n">keywords</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;SCALE_X0&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;SCALE_X0&quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">scale_longrange</span><span class="p">),</span>
                        <span class="s2">&quot;SCALE_X&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;SCALE_X&quot;</span><span class="p">,</span> <span class="n">scale_longrange</span> <span class="o">-</span> <span class="n">scale_coulomb</span><span class="p">),</span>
                        <span class="s2">&quot;OMEGA&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;OMEGA&quot;</span><span class="p">,</span> <span class="n">omega</span><span class="p">),</span>
                    <span class="p">},</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">xc_functional</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="n">Section</span><span class="p">(</span>
                    <span class="s2">&quot;PBE_HOLE_T_C_LR&quot;</span><span class="p">,</span>
                    <span class="n">subsections</span><span class="o">=</span><span class="p">{},</span>
                    <span class="n">keywords</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;CUTOFF_RADIUS&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;CUTOFF_RADIUS&quot;</span><span class="p">,</span> <span class="n">cutoff_radius</span><span class="p">),</span>
                        <span class="s2">&quot;SCALE_X&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;SCALE_X&quot;</span><span class="p">,</span> <span class="n">scale_longrange</span><span class="p">),</span>
                    <span class="p">},</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Unknown hybrid functional. Using PBE base functional and overriding all &quot;</span>
                <span class="s2">&quot;settings manually. Proceed with caution.&quot;</span>
            <span class="p">)</span>
            <span class="n">pbe</span> <span class="o">=</span> <span class="n">PBE</span><span class="p">(</span><span class="s2">&quot;ORIG&quot;</span><span class="p">,</span> <span class="n">scale_c</span><span class="o">=</span><span class="n">gga_c_fraction</span><span class="p">,</span> <span class="n">scale_x</span><span class="o">=</span><span class="n">gga_x_fraction</span><span class="p">)</span>
            <span class="n">xc_functional</span> <span class="o">=</span> <span class="n">Xc_Functional</span><span class="p">(</span><span class="n">functionals</span><span class="o">=</span><span class="p">[],</span> <span class="n">subsections</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;PBE&quot;</span><span class="p">:</span> <span class="n">pbe</span><span class="p">})</span>

            <span class="n">ip_keywords</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;POTENTIAL_TYPE&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;POTENTIAL_TYPE&quot;</span><span class="p">,</span> <span class="n">potential_type</span><span class="p">),</span>
                    <span class="s2">&quot;CUTOFF_RADIUS&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;CUTOFF_RADIUS&quot;</span><span class="p">,</span> <span class="n">cutoff_radius</span><span class="p">),</span>
                    <span class="s2">&quot;T_C_G_DATA&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;T_C_G_DATA&quot;</span><span class="p">,</span> <span class="s2">&quot;t_c_g.dat&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;SCALE_COULOMB&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;SCALE_COULOMB&quot;</span><span class="p">,</span> <span class="n">scale_coulomb</span><span class="p">),</span>
                    <span class="s2">&quot;SCALE_GAUSSIAN&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;SCALE_GAUSSIAN&quot;</span><span class="p">,</span> <span class="n">scale_gaussian</span><span class="p">),</span>
                    <span class="s2">&quot;SCALE_LONGRANGE&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;SCALE_LONGRANGE&quot;</span><span class="p">,</span> <span class="n">scale_longrange</span><span class="p">),</span>
                    <span class="s2">&quot;OMEGA&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;OMEGA&quot;</span><span class="p">,</span> <span class="n">omega</span><span class="p">),</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="n">interaction_potential</span> <span class="o">=</span> <span class="n">Section</span><span class="p">(</span><span class="s2">&quot;INTERACTION_POTENTIAL&quot;</span><span class="p">,</span> <span class="n">subsections</span><span class="o">=</span><span class="p">{},</span> <span class="n">keywords</span><span class="o">=</span><span class="n">ip_keywords</span><span class="p">)</span>

        <span class="c1"># Unlikely for users to override</span>
        <span class="n">load_balance</span> <span class="o">=</span> <span class="n">Section</span><span class="p">(</span>
            <span class="s2">&quot;LOAD_BALANCE&quot;</span><span class="p">,</span>
            <span class="n">keywords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;RANDOMIZE&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;RANDOMIZE&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)},</span>
            <span class="n">subsections</span><span class="o">=</span><span class="p">{},</span>
        <span class="p">)</span>

        <span class="c1"># EPS_STORAGE_SCALING squashes the integrals for efficient storage</span>
        <span class="c1"># Unlikely for users to override.</span>
        <span class="n">memory</span> <span class="o">=</span> <span class="n">Section</span><span class="p">(</span>
            <span class="s2">&quot;MEMORY&quot;</span><span class="p">,</span>
            <span class="n">subsections</span><span class="o">=</span><span class="p">{},</span>
            <span class="n">keywords</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;EPS_STORAGE_SCALING&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;EPS_STORAGE_SCALING&quot;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
                <span class="s2">&quot;MAX_MEMORY&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;MAX_MEMORY&quot;</span><span class="p">,</span> <span class="n">max_memory</span><span class="p">),</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="n">hf</span> <span class="o">=</span> <span class="n">Section</span><span class="p">(</span>
            <span class="s2">&quot;HF&quot;</span><span class="p">,</span>
            <span class="n">keywords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;FRACTION&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;FRACTION&quot;</span><span class="p">,</span> <span class="n">hf_fraction</span><span class="p">)},</span>
            <span class="n">subsections</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;SCREENING&quot;</span><span class="p">:</span> <span class="n">screening</span><span class="p">,</span>
                <span class="s2">&quot;INTERACTION_POTENTIAL&quot;</span><span class="p">:</span> <span class="n">interaction_potential</span><span class="p">,</span>
                <span class="s2">&quot;LOAD_BALANCE&quot;</span><span class="p">:</span> <span class="n">load_balance</span><span class="p">,</span>
                <span class="s2">&quot;MEMORY&quot;</span><span class="p">:</span> <span class="n">memory</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="n">xc</span> <span class="o">=</span> <span class="n">Section</span><span class="p">(</span><span class="s2">&quot;XC&quot;</span><span class="p">,</span> <span class="n">subsections</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;XC_FUNCTIONAL&quot;</span><span class="p">:</span> <span class="n">xc_functional</span><span class="p">,</span> <span class="s2">&quot;HF&quot;</span><span class="p">:</span> <span class="n">hf</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">subsections</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">][</span><span class="s2">&quot;DFT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">xc</span><span class="p">)</span></div>

<div class="viewcode-block" id="DftSet.activate_motion"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.activate_motion">[docs]</a>    <span class="k">def</span> <span class="nf">activate_motion</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">max_drift</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3e-3</span><span class="p">,</span>
        <span class="n">rms_drift</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5e-3</span><span class="p">,</span>
        <span class="n">max_force</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">4.5e-4</span><span class="p">,</span>
        <span class="n">rms_force</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3e-4</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
        <span class="n">optimizer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;BFGS&quot;</span><span class="p">,</span>
        <span class="n">trust_radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span>
        <span class="n">line_search</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;2PNT&quot;</span><span class="p">,</span>
        <span class="n">ensemble</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;NVE&quot;</span><span class="p">,</span>
        <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
        <span class="n">timestep</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">nsteps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">thermostat</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;NOSE&quot;</span><span class="p">,</span>
        <span class="n">nproc_rep</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Turns on the motion section for GEO_OPT, CELL_OPT, etc. calculations.</span>
<span class="sd">        Will turn on the printing subsections and also bind any constraints</span>
<span class="sd">        to their respective atoms.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s2">&quot;MOTION&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Section</span><span class="p">(</span><span class="s2">&quot;MOTION&quot;</span><span class="p">,</span> <span class="n">subsections</span><span class="o">=</span><span class="p">{}))</span>

        <span class="n">run_type</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;global&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;run_type&quot;</span><span class="p">,</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;run_type&quot;</span><span class="p">,</span> <span class="s2">&quot;energy&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">run_type</span> <span class="o">==</span> <span class="s2">&quot;GEOMETRY_OPTIMIZATION&quot;</span><span class="p">:</span>
            <span class="n">run_type</span> <span class="o">=</span> <span class="s2">&quot;GEO_OPT&quot;</span>
        <span class="k">if</span> <span class="n">run_type</span> <span class="o">==</span> <span class="s2">&quot;MOLECULAR_DYNAMICS&quot;</span><span class="p">:</span>
            <span class="n">run_type</span> <span class="o">=</span> <span class="s2">&quot;MD&quot;</span>

        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;MOTION&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Section</span><span class="p">(</span><span class="s2">&quot;PRINT&quot;</span><span class="p">,</span> <span class="n">subsections</span><span class="o">=</span><span class="p">{}))</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;MOTION&quot;</span><span class="p">][</span><span class="s2">&quot;PRINT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Section</span><span class="p">(</span><span class="s2">&quot;TRAJECTORY&quot;</span><span class="p">,</span> <span class="n">section_parameters</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ON&quot;</span><span class="p">],</span> <span class="n">subsections</span><span class="o">=</span><span class="p">{}))</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;MOTION&quot;</span><span class="p">][</span><span class="s2">&quot;PRINT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Section</span><span class="p">(</span><span class="s2">&quot;CELL&quot;</span><span class="p">,</span> <span class="n">subsections</span><span class="o">=</span><span class="p">{}))</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;MOTION&quot;</span><span class="p">][</span><span class="s2">&quot;PRINT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Section</span><span class="p">(</span><span class="s2">&quot;FORCES&quot;</span><span class="p">,</span> <span class="n">subsections</span><span class="o">=</span><span class="p">{}))</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;MOTION&quot;</span><span class="p">][</span><span class="s2">&quot;PRINT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Section</span><span class="p">(</span><span class="s2">&quot;STRESS&quot;</span><span class="p">,</span> <span class="n">subsections</span><span class="o">=</span><span class="p">{}))</span>

        <span class="c1"># ACTIVATE RELAX IF REQUESTED</span>
        <span class="k">if</span> <span class="n">run_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;GEO_OPT&quot;</span><span class="p">,</span> <span class="s2">&quot;CELL_OPT&quot;</span><span class="p">]:</span>
            <span class="n">opt_params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;MAX_DR&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;MAX_DR&quot;</span><span class="p">,</span> <span class="n">max_drift</span><span class="p">),</span>
                <span class="s2">&quot;MAX_FORCE&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;MAX_FORCE&quot;</span><span class="p">,</span> <span class="n">max_force</span><span class="p">),</span>
                <span class="s2">&quot;RMS_DR&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;RMS_DR&quot;</span><span class="p">,</span> <span class="n">rms_drift</span><span class="p">),</span>
                <span class="s2">&quot;RMS_FORCE&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;RMS_FORCE&quot;</span><span class="p">,</span> <span class="n">rms_force</span><span class="p">),</span>
                <span class="s2">&quot;MAX_ITER&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;MAX_ITER&quot;</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">),</span>
                <span class="s2">&quot;OPTIMIZER&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;OPTIMIZER&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="n">Section</span><span class="p">(</span><span class="n">run_type</span><span class="p">,</span> <span class="n">subsections</span><span class="o">=</span><span class="p">{},</span> <span class="n">keywords</span><span class="o">=</span><span class="n">opt_params</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;CG&quot;</span><span class="p">:</span>
                <span class="n">ls</span> <span class="o">=</span> <span class="n">Section</span><span class="p">(</span><span class="s2">&quot;LINE_SEARCH&quot;</span><span class="p">,</span> <span class="n">subsections</span><span class="o">=</span><span class="p">{},</span> <span class="n">keywords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;TYPE&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;TYPE&quot;</span><span class="p">,</span> <span class="n">line_search</span><span class="p">)})</span>
                <span class="n">cg</span> <span class="o">=</span> <span class="n">Section</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="n">subsections</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;LINE_SEARCH&quot;</span><span class="p">:</span> <span class="n">ls</span><span class="p">},</span> <span class="n">keywords</span><span class="o">=</span><span class="p">{})</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;BFGS&quot;</span><span class="p">:</span>
                <span class="n">bfgs</span> <span class="o">=</span> <span class="n">Section</span><span class="p">(</span><span class="s2">&quot;BFGS&quot;</span><span class="p">,</span> <span class="n">subsections</span><span class="o">=</span><span class="p">{},</span> <span class="n">keywords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;TRUST_RADIUS&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;TRUST_RADIUS&quot;</span><span class="p">,</span> <span class="n">trust_radius</span><span class="p">)})</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">bfgs</span><span class="p">)</span>

            <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;MOTION&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>

        <span class="c1"># ACTIVATE MD IF REQUESTED</span>
        <span class="k">elif</span> <span class="n">run_type</span> <span class="o">==</span> <span class="s2">&quot;MD&quot;</span><span class="p">:</span>
            <span class="n">md_keywords</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;ENSEMBLE&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;ENSEMBLE&quot;</span><span class="p">,</span> <span class="n">ensemble</span><span class="p">),</span>
                <span class="s2">&quot;TEMPERATURE&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;TEMPERATURE&quot;</span><span class="p">,</span> <span class="n">temperature</span><span class="p">),</span>
                <span class="s2">&quot;TIMESTEP&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;TIMESTEP&quot;</span><span class="p">,</span> <span class="n">timestep</span><span class="p">),</span>
                <span class="s2">&quot;STEPS&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;STEPS&quot;</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="n">thermostat</span> <span class="o">=</span> <span class="n">Section</span><span class="p">(</span><span class="s2">&quot;THERMOSTAT&quot;</span><span class="p">,</span> <span class="n">keywords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;TYPE&quot;</span><span class="p">:</span> <span class="n">thermostat</span><span class="p">})</span>
            <span class="n">md</span> <span class="o">=</span> <span class="n">Section</span><span class="p">(</span><span class="s2">&quot;MD&quot;</span><span class="p">,</span> <span class="n">subsections</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;THERMOSTAT&quot;</span><span class="p">:</span> <span class="n">thermostat</span><span class="p">},</span> <span class="n">keywords</span><span class="o">=</span><span class="n">md_keywords</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;MOTION&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">md</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">run_type</span> <span class="o">==</span> <span class="s2">&quot;BAND&quot;</span><span class="p">:</span>
            <span class="n">convergence_control_params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;MAX_DR&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;MAX_DR&quot;</span><span class="p">,</span> <span class="n">max_drift</span><span class="p">),</span>
                <span class="s2">&quot;MAX_FORCE&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;MAX_FORCE&quot;</span><span class="p">,</span> <span class="n">max_force</span><span class="p">),</span>
                <span class="s2">&quot;RMS_DR&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;RMS_DR&quot;</span><span class="p">,</span> <span class="n">rms_drift</span><span class="p">),</span>
                <span class="s2">&quot;RMS_FORCE&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;RMS_FORCE&quot;</span><span class="p">,</span> <span class="n">rms_force</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="n">band_kwargs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;BAND_TYPE&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;BAND_TYPE&quot;</span><span class="p">,</span> <span class="s2">&quot;IT-NEB&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Improved tangent NEB&quot;</span><span class="p">),</span>
                <span class="s2">&quot;NUMBER_OF_REPLICA&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;NUMBER_OF_REPLICA&quot;</span><span class="p">),</span>
                <span class="s2">&quot;NPROC_REP&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;NPROC_REP&quot;</span><span class="p">,</span> <span class="n">nproc_rep</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="n">band</span> <span class="o">=</span> <span class="n">Section</span><span class="p">(</span><span class="s2">&quot;BAND&quot;</span><span class="p">,</span> <span class="n">keywords</span><span class="o">=</span><span class="n">band_kwargs</span><span class="p">)</span>
            <span class="n">band</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Section</span><span class="p">(</span><span class="s2">&quot;CONVERGENCE_CONTROL&quot;</span><span class="p">,</span> <span class="n">keywords</span><span class="o">=</span><span class="n">convergence_control_params</span><span class="p">))</span>
            <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;MOTION&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">modify_dft_print_iters</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">add_last</span><span class="o">=</span><span class="s2">&quot;numeric&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;fix&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">site_properties</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;motion&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Section</span><span class="p">(</span><span class="s2">&quot;CONSTRAINT&quot;</span><span class="p">))</span>

            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">components</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">tuples</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">):</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span>
                    <span class="mi">1</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">takewhile</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">site_properties</span><span class="p">[</span><span class="s2">&quot;fix&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">site_properties</span><span class="p">[</span><span class="s2">&quot;fix&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">:],</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">site_properties</span><span class="p">[</span><span class="s2">&quot;fix&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                <span class="n">tuples</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">end</span>
            <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;motion&quot;</span><span class="p">][</span><span class="s2">&quot;constraint&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="n">SectionList</span><span class="p">(</span>
                    <span class="n">sections</span><span class="o">=</span><span class="p">[</span>
                        <span class="n">Section</span><span class="p">(</span>
                            <span class="s2">&quot;FIXED_ATOMS&quot;</span><span class="p">,</span>
                            <span class="n">keywords</span><span class="o">=</span><span class="p">{</span>
                                <span class="s2">&quot;COMPONENTS_TO_FIX&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;COMPONENTS_TO_FIX&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span>
                                <span class="s2">&quot;LIST&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;LIST&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">..</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                            <span class="p">},</span>
                        <span class="p">)</span>
                        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tuples</span><span class="p">,</span> <span class="n">components</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">c</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="DftSet.activate_tddfpt"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.activate_tddfpt">[docs]</a>    <span class="k">def</span> <span class="nf">activate_tddfpt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Activate TDDFPT for calculating excited states. Only works with GPW. Supports hfx.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s2">&quot;force_eval/properties&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Section</span><span class="p">(</span><span class="s2">&quot;PROPERTIES&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">][</span><span class="s2">&quot;PROPERTIES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Section</span><span class="p">(</span><span class="s2">&quot;TDDFPT&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span></div>

<div class="viewcode-block" id="DftSet.activate_epr"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.activate_epr">[docs]</a>    <span class="k">def</span> <span class="nf">activate_epr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate g-tensor. Requires localize. Suggested with GAPW&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s2">&quot;force_eval/properties/linres/localize&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">activate_localize</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">][</span><span class="s2">&quot;PROPERTIES&quot;</span><span class="p">][</span><span class="s2">&quot;LINRES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Section</span><span class="p">(</span><span class="s2">&quot;EPR&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">][</span><span class="s2">&quot;PROPERTIES&quot;</span><span class="p">][</span><span class="s2">&quot;LINRES&quot;</span><span class="p">][</span><span class="s2">&quot;EPR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;PRINT&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;G_TENSOR&quot;</span><span class="p">:</span> <span class="p">{}}})</span></div>

<div class="viewcode-block" id="DftSet.activate_nmr"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.activate_nmr">[docs]</a>    <span class="k">def</span> <span class="nf">activate_nmr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate nmr shifts. Requires localize. Suggested with GAPW&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s2">&quot;force_eval/properties/linres/localize&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">activate_localize</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">][</span><span class="s2">&quot;PROPERTIES&quot;</span><span class="p">][</span><span class="s2">&quot;LINRES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Section</span><span class="p">(</span><span class="s2">&quot;NMR&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">][</span><span class="s2">&quot;PROPERTIES&quot;</span><span class="p">][</span><span class="s2">&quot;LINRES&quot;</span><span class="p">][</span><span class="s2">&quot;NMR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;PRINT&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;CHI_TENSOR&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;SHIELDING_TENSOR&quot;</span><span class="p">:</span> <span class="p">{}}})</span></div>

<div class="viewcode-block" id="DftSet.activate_spinspin"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.activate_spinspin">[docs]</a>    <span class="k">def</span> <span class="nf">activate_spinspin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate spin-spin coupling tensor. Requires localize.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s2">&quot;force_eval/properties/linres/localize&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">activate_localize</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">][</span><span class="s2">&quot;PROPERTIES&quot;</span><span class="p">][</span><span class="s2">&quot;LINRES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Section</span><span class="p">(</span><span class="s2">&quot;SPINSPIN&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span></div>

<div class="viewcode-block" id="DftSet.activate_polar"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.activate_polar">[docs]</a>    <span class="k">def</span> <span class="nf">activate_polar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate polarizations (including raman).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s2">&quot;force_eval/properties&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Section</span><span class="p">(</span><span class="s2">&quot;PROPERTIES&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s2">&quot;force_eval/properties/linres&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">][</span><span class="s2">&quot;PROPERTIES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="s2">&quot;LINRES&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">][</span><span class="s2">&quot;PROPERTIES&quot;</span><span class="p">][</span><span class="s2">&quot;LINRES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Section</span><span class="p">(</span><span class="s2">&quot;POLAR&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span></div>

<div class="viewcode-block" id="DftSet.activate_hyperfine"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.activate_hyperfine">[docs]</a>    <span class="k">def</span> <span class="nf">activate_hyperfine</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Print the hyperfine coupling constants.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">][</span><span class="s2">&quot;DFT&quot;</span><span class="p">][</span><span class="s2">&quot;PRINT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Section</span><span class="p">(</span><span class="s2">&quot;HYPERFINE_COUPLING_TENSOR&quot;</span><span class="p">,</span> <span class="n">FILENAME</span><span class="o">=</span><span class="s2">&quot;HYPERFINE&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="DftSet.activate_localize"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.activate_localize">[docs]</a>    <span class="k">def</span> <span class="nf">activate_localize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="o">=</span><span class="s2">&quot;OCCUPIED&quot;</span><span class="p">,</span> <span class="n">preconditioner</span><span class="o">=</span><span class="s2">&quot;FULL_ALL&quot;</span><span class="p">,</span> <span class="n">restart</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Activate calculation of the maximally localized wannier functions.</span>

<span class="sd">        Args:</span>
<span class="sd">            states: Which states to calculate. occupied, unoccupied, mixed states, or all states. At</span>
<span class="sd">                present, unoccupied orbitals are only implemented for GPW.</span>
<span class="sd">            preconditioner: Preconditioner to use for optimize</span>
<span class="sd">            restart: Initialize from the localization restart file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s2">&quot;force_eval/properties&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Section</span><span class="p">(</span><span class="s2">&quot;PROPERTIES&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s2">&quot;force_eval/properties/linres&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">][</span><span class="s2">&quot;PROPERTIES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Section</span><span class="p">(</span><span class="s2">&quot;LINRES&quot;</span><span class="p">))</span>

        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">][</span><span class="s2">&quot;PROPERTIES&quot;</span><span class="p">][</span><span class="s2">&quot;LINRES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
            <span class="n">Section</span><span class="p">(</span><span class="s2">&quot;LOCALIZE&quot;</span><span class="p">,</span> <span class="n">PRECONDITIONER</span><span class="o">=</span><span class="n">preconditioner</span><span class="p">,</span> <span class="n">STATES</span><span class="o">=</span><span class="n">states</span><span class="p">,</span> <span class="n">RESTART</span><span class="o">=</span><span class="n">restart</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">][</span><span class="s2">&quot;PROPERTIES&quot;</span><span class="p">][</span><span class="s2">&quot;LINRES&quot;</span><span class="p">][</span><span class="s2">&quot;LOCALIZE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Section</span><span class="p">(</span><span class="s2">&quot;PRINT&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">][</span><span class="s2">&quot;PROPERTIES&quot;</span><span class="p">][</span><span class="s2">&quot;LINRES&quot;</span><span class="p">][</span><span class="s2">&quot;LOCALIZE&quot;</span><span class="p">][</span><span class="s2">&quot;PRINT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Section</span><span class="p">(</span><span class="s2">&quot;LOC_RESTART&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="DftSet.activate_vdw_potential"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.activate_vdw_potential">[docs]</a>    <span class="k">def</span> <span class="nf">activate_vdw_potential</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dispersion_functional</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">potential_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Activate van der Waals dispersion corrections.</span>

<span class="sd">        Args:</span>
<span class="sd">            dispersion_functional: Type of dispersion functional.</span>
<span class="sd">                Options: pair_potential or non_local</span>
<span class="sd">            potential_type: What type of potential to use, given a dispersion functional type</span>
<span class="sd">                Options: DFTD2, DFTD3, DFTD3(BJ), DRSLL, LMKLL, RVV10</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vdw</span> <span class="o">=</span> <span class="n">Section</span><span class="p">(</span>
            <span class="s2">&quot;VDW_POTENTIAL&quot;</span><span class="p">,</span> <span class="n">keywords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;DISPERSION_FUNCTIONAL&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;DISPERSION_FUNCTIONAL&quot;</span><span class="p">,</span> <span class="n">dispersion_functional</span><span class="p">)}</span>
        <span class="p">)</span>
        <span class="n">keywords</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;TYPE&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;TYPE&quot;</span><span class="p">,</span> <span class="n">potential_type</span><span class="p">)}</span>
        <span class="k">if</span> <span class="n">dispersion_functional</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;PAIR_POTENTIAL&quot;</span><span class="p">:</span>
            <span class="n">reference_functional</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xc_functionals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Reference functional will not be checked for validity. &quot;</span>
                <span class="s2">&quot;Calculation will fail if the reference functional &quot;</span>
                <span class="s2">&quot;does not exist in the dftd3 reference data&quot;</span>
            <span class="p">)</span>
            <span class="n">keywords</span><span class="p">[</span><span class="s2">&quot;PARAMETER_FILE_NAME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;PARAMETER_FILE_NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;dftd3.dat&quot;</span><span class="p">)</span>
            <span class="n">keywords</span><span class="p">[</span><span class="s2">&quot;REFERENCE_FUNCTIONAL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;REFERENCE_FUNCTIONAL&quot;</span><span class="p">,</span> <span class="n">reference_functional</span><span class="p">)</span>

        <span class="n">vdw</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Section</span><span class="p">(</span><span class="n">dispersion_functional</span><span class="p">,</span> <span class="n">keywords</span><span class="o">=</span><span class="n">keywords</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">][</span><span class="s2">&quot;DFT&quot;</span><span class="p">][</span><span class="s2">&quot;XC&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">vdw</span><span class="p">)</span></div>

<div class="viewcode-block" id="DftSet.activate_fast_minimization"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.activate_fast_minimization">[docs]</a>    <span class="k">def</span> <span class="nf">activate_fast_minimization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">on</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to modify the set to use fast SCF minimization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">on</span><span class="p">:</span>
            <span class="n">ot</span> <span class="o">=</span> <span class="n">OrbitalTransformation</span><span class="p">(</span>
                <span class="n">minimizer</span><span class="o">=</span><span class="s2">&quot;DIIS&quot;</span><span class="p">,</span>
                <span class="n">preconditioner</span><span class="o">=</span><span class="s2">&quot;FULL_ALL&quot;</span><span class="p">,</span>
                <span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;IRAC&quot;</span><span class="p">,</span>
                <span class="n">linesearch</span><span class="o">=</span><span class="s2">&quot;2PNT&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;DFT&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;SCF&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;OT&quot;</span><span class="p">:</span> <span class="n">ot</span><span class="p">}}}})</span></div>

<div class="viewcode-block" id="DftSet.activate_robust_minimization"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.activate_robust_minimization">[docs]</a>    <span class="k">def</span> <span class="nf">activate_robust_minimization</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to modify the set to use more robust SCF minimization technique</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ot</span> <span class="o">=</span> <span class="n">OrbitalTransformation</span><span class="p">(</span>
            <span class="n">minimizer</span><span class="o">=</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span>
            <span class="n">preconditioner</span><span class="o">=</span><span class="s2">&quot;FULL_ALL&quot;</span><span class="p">,</span>
            <span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;STRICT&quot;</span><span class="p">,</span>
            <span class="n">linesearch</span><span class="o">=</span><span class="s2">&quot;3PNT&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;DFT&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;SCF&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;OT&quot;</span><span class="p">:</span> <span class="n">ot</span><span class="p">}}}})</span></div>

<div class="viewcode-block" id="DftSet.activate_very_strict_minimization"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.activate_very_strict_minimization">[docs]</a>    <span class="k">def</span> <span class="nf">activate_very_strict_minimization</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to modify the set to use very strict SCF minimization scheme</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ot</span> <span class="o">=</span> <span class="n">OrbitalTransformation</span><span class="p">(</span>
            <span class="n">minimizer</span><span class="o">=</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span>
            <span class="n">preconditioner</span><span class="o">=</span><span class="s2">&quot;FULL_ALL&quot;</span><span class="p">,</span>
            <span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;STRICT&quot;</span><span class="p">,</span>
            <span class="n">linesearch</span><span class="o">=</span><span class="s2">&quot;GOLD&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;DFT&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;SCF&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;OT&quot;</span><span class="p">:</span> <span class="n">ot</span><span class="p">}}}})</span></div>

<div class="viewcode-block" id="DftSet.activate_nonperiodic"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.activate_nonperiodic">[docs]</a>    <span class="k">def</span> <span class="nf">activate_nonperiodic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s2">&quot;ANALYTIC&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Activates a calculation with non-periodic calculations by turning of PBC and</span>
<span class="sd">        changing the poisson solver. Still requires a CELL to put the atoms</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kwds</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;POISSON_SOLVER&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;POISSON_SOLVER&quot;</span><span class="p">,</span> <span class="n">solver</span><span class="p">),</span>
            <span class="s2">&quot;PERIODIC&quot;</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;PERIODIC&quot;</span><span class="p">,</span> <span class="s2">&quot;NONE&quot;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">][</span><span class="s2">&quot;DFT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Section</span><span class="p">(</span><span class="s2">&quot;POISSON&quot;</span><span class="p">,</span> <span class="n">subsections</span><span class="o">=</span><span class="p">{},</span> <span class="n">keywords</span><span class="o">=</span><span class="n">kwds</span><span class="p">))</span></div>

<div class="viewcode-block" id="DftSet.create_subsys"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.create_subsys">[docs]</a>    <span class="k">def</span> <span class="nf">create_subsys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span> <span class="o">|</span> <span class="n">Molecule</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the structure for the input</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subsys</span> <span class="o">=</span> <span class="n">Subsys</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">Structure</span><span class="p">):</span>
            <span class="n">subsys</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Cell</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">lattice</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">cart_coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">cart_coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">z</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">cart_coords</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="k">if</span> <span class="n">x</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="k">if</span> <span class="n">y</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">z</span> <span class="k">if</span> <span class="n">z</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="n">Cell</span><span class="p">(</span><span class="n">lattice</span><span class="o">=</span><span class="n">Lattice</span><span class="p">([[</span><span class="mi">10</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">z</span><span class="p">]]))</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;PERIODIC&quot;</span><span class="p">,</span> <span class="s2">&quot;NONE&quot;</span><span class="p">))</span>
            <span class="n">subsys</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>

        <span class="c1"># Insert atom kinds by identifying the unique sites (unique element and site properties)</span>
        <span class="n">unique_kinds</span> <span class="o">=</span> <span class="n">get_unique_site_indices</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">unique_kinds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">kind</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">_ox</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">site_properties</span><span class="p">[</span><span class="s2">&quot;oxi_state&quot;</span><span class="p">][</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="k">if</span> <span class="s2">&quot;oxi_state&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">site_properties</span>
                <span class="k">else</span> <span class="mi">0</span>
            <span class="p">)</span>
            <span class="n">_sp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">site_properties</span><span class="p">[</span><span class="s2">&quot;spin&quot;</span><span class="p">][</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="s2">&quot;spin&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">site_properties</span> <span class="k">else</span> <span class="mi">0</span>

            <span class="n">bs</span> <span class="o">=</span> <span class="n">BrokenSymmetry</span><span class="o">.</span><span class="n">from_el</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">_ox</span><span class="p">,</span> <span class="n">_sp</span><span class="p">)</span> <span class="k">if</span> <span class="n">_ox</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="s2">&quot;magmom&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">site_properties</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">bs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;magnetization&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">site_properties</span><span class="p">[</span><span class="s2">&quot;magmom&quot;</span><span class="p">][</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

            <span class="k">if</span> <span class="s2">&quot;ghost&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">site_properties</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ghost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">site_properties</span><span class="p">[</span><span class="s2">&quot;ghost&quot;</span><span class="p">][</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

            <span class="k">if</span> <span class="s2">&quot;basis_set&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">site_properties</span><span class="p">:</span>
                <span class="n">basis_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">site_properties</span><span class="p">[</span><span class="s2">&quot;basis_set&quot;</span><span class="p">][</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">basis_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_and_potential</span><span class="p">[</span><span class="n">kind</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;basis&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;potential&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">site_properties</span><span class="p">:</span>
                <span class="n">potential</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">site_properties</span><span class="p">[</span><span class="s2">&quot;potential&quot;</span><span class="p">][</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">potential</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_and_potential</span><span class="p">[</span><span class="n">kind</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;potential&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;aux_basis&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">site_properties</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;aux_basis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">site_properties</span><span class="p">[</span><span class="s2">&quot;aux_basis&quot;</span><span class="p">][</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_and_potential</span><span class="p">[</span><span class="n">kind</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;aux_basis&quot;</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;aux_basis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_and_potential</span><span class="p">[</span><span class="n">kind</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;aux_basis&quot;</span><span class="p">)</span>

            <span class="n">_kind</span> <span class="o">=</span> <span class="n">Kind</span><span class="p">(</span>
                <span class="n">kind</span><span class="p">,</span>
                <span class="n">alias</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                <span class="n">basis_set</span><span class="o">=</span><span class="n">basis_set</span><span class="p">,</span>
                <span class="n">potential</span><span class="o">=</span><span class="n">potential</span><span class="p">,</span>
                <span class="n">subsections</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;BS&quot;</span><span class="p">:</span> <span class="n">bs</span><span class="p">}</span> <span class="k">if</span> <span class="n">bs</span> <span class="k">else</span> <span class="p">{},</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qs_method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;GAPW&quot;</span><span class="p">:</span>
                <span class="n">_kind</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;RADIAL_GRID&quot;</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
                <span class="n">_kind</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;LEBEDEV_GRID&quot;</span><span class="p">,</span> <span class="mi">80</span><span class="p">))</span>

            <span class="n">subsys</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">_kind</span><span class="p">)</span>

        <span class="n">coord</span> <span class="o">=</span> <span class="n">Coord</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">aliases</span><span class="o">=</span><span class="n">unique_kinds</span><span class="p">)</span>
        <span class="n">subsys</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;FORCE_EVAL&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">subsys</span><span class="p">)</span></div>

<div class="viewcode-block" id="DftSet.modify_dft_print_iters"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.modify_dft_print_iters">[docs]</a>    <span class="k">def</span> <span class="nf">modify_dft_print_iters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iters</span><span class="p">,</span> <span class="n">add_last</span><span class="o">=</span><span class="s2">&quot;no&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Modify all DFT print iterations at once. Common use is to set iters to the max</span>
<span class="sd">        number of iterations + 1 and then set add_last to numeric. This would have the</span>
<span class="sd">        effect of printing only the first and last iteration, which might be useful for</span>
<span class="sd">        speeding up/saving space on GEO_OPT or MD runs where you don&#39;t need the intermediate</span>
<span class="sd">        values.</span>

<span class="sd">        Args:</span>
<span class="sd">            iters (int): print each &quot;iters&quot; iterations.</span>
<span class="sd">            add_last (str): Whether to explicitly include the last iteration, and how to mark it.</span>
<span class="sd">                numeric: mark last iteration with the iteration number</span>
<span class="sd">                symbolic: mark last iteration with the letter &quot;l&quot;</span>
<span class="sd">                no: do not explicitly include the last iteration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">add_last</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="s2">&quot;numeric&quot;</span><span class="p">,</span> <span class="s2">&quot;symbolic&quot;</span><span class="p">]</span>
        <span class="n">run_type</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;global&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;run_type&quot;</span><span class="p">,</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;run_type&quot;</span><span class="p">,</span> <span class="s2">&quot;energy&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">run_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ENERGY_FORCE&quot;</span><span class="p">,</span> <span class="s2">&quot;ENERGY&quot;</span><span class="p">,</span> <span class="s2">&quot;WAVEFUNCTION_OPTIMIZATION&quot;</span><span class="p">,</span> <span class="s2">&quot;WFN_OPT&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span>
            <span class="s2">&quot;FORCE_EVAL/DFT/PRINT&quot;</span>
        <span class="p">):</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;force_eval&quot;</span><span class="p">][</span><span class="s2">&quot;dft&quot;</span><span class="p">][</span><span class="s2">&quot;print&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">subsections</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s2">&quot;ACTIVE_SPACE&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;BAND_STRUCTURE&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;GAPW&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;IMPLICIT_PSOLVER&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;SCCS&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;WFN_MIX&quot;</span><span class="p">,</span>
                <span class="p">]:</span>
                    <span class="k">continue</span>

                <span class="n">v</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Section</span><span class="p">(</span><span class="s2">&quot;EACH&quot;</span><span class="p">,</span> <span class="n">subsections</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keywords</span><span class="o">=</span><span class="p">{</span><span class="n">run_type</span><span class="p">:</span> <span class="n">Keyword</span><span class="p">(</span><span class="n">run_type</span><span class="p">,</span> <span class="n">iters</span><span class="p">)}))</span>
                <span class="n">v</span><span class="o">.</span><span class="n">keywords</span><span class="p">[</span><span class="s2">&quot;ADD_LAST&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Keyword</span><span class="p">(</span><span class="s2">&quot;ADD_LAST&quot;</span><span class="p">,</span> <span class="n">add_last</span><span class="p">)</span></div>

<div class="viewcode-block" id="DftSet.validate"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.DftSet.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Implements a few checks for a valid input set&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s2">&quot;force_eval/dft/kpoints&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s2">&quot;force_eval/dft/xc/hf&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">Cp2kValidationError</span><span class="p">(</span><span class="s2">&quot;Does not support hartree fock with kpoints&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;force_eval&quot;</span><span class="p">][</span><span class="s2">&quot;subsys&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">subsections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;KIND&quot;</span> <span class="ow">and</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;POTENTIAL&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;ALL&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;force_eval&quot;</span><span class="p">][</span><span class="s2">&quot;dft&quot;</span><span class="p">][</span><span class="s2">&quot;qs&quot;</span><span class="p">][</span><span class="s2">&quot;method&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;GAPW&quot;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">Cp2kValidationError</span><span class="p">(</span><span class="s2">&quot;All electron basis sets require GAPW method&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="StaticSet"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.StaticSet">[docs]</a><span class="k">class</span> <span class="nc">StaticSet</span><span class="p">(</span><span class="n">DftSet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Quick Constructor for static calculations&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">run_type</span><span class="o">=</span><span class="s2">&quot;ENERGY_FORCE&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="RelaxSet"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.RelaxSet">[docs]</a><span class="k">class</span> <span class="nc">RelaxSet</span><span class="p">(</span><span class="n">DftSet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Quick Constructor for geometry relaxation&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">run_type</span><span class="o">=</span><span class="s2">&quot;GEO_OPT&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activate_motion</span><span class="p">()</span></div>


<div class="viewcode-block" id="CellOptSet"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.CellOptSet">[docs]</a><span class="k">class</span> <span class="nc">CellOptSet</span><span class="p">(</span><span class="n">DftSet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Quick Constructor for cell optimization relaxation&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">run_type</span><span class="o">=</span><span class="s2">&quot;CELL_OPT&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activate_motion</span><span class="p">()</span></div>


<div class="viewcode-block" id="HybridStaticSet"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.HybridStaticSet">[docs]</a><span class="k">class</span> <span class="nc">HybridStaticSet</span><span class="p">(</span><span class="n">DftSet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Quick Constructor for static calculations&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">run_type</span><span class="o">=</span><span class="s2">&quot;ENERGY_FORCE&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activate_hybrid</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;activate_hybrid&quot;</span><span class="p">,</span> <span class="p">{}))</span></div>


<div class="viewcode-block" id="HybridRelaxSet"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.HybridRelaxSet">[docs]</a><span class="k">class</span> <span class="nc">HybridRelaxSet</span><span class="p">(</span><span class="n">DftSet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Quick Constructor for hybrid geometry relaxation&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">run_type</span><span class="o">=</span><span class="s2">&quot;GEO_OPT&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activate_hybrid</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;activate_hybrid&quot;</span><span class="p">,</span> <span class="p">{}))</span></div>


<div class="viewcode-block" id="HybridCellOptSet"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.HybridCellOptSet">[docs]</a><span class="k">class</span> <span class="nc">HybridCellOptSet</span><span class="p">(</span><span class="n">DftSet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Quick Constructor for hybrid cell optimization relaxation&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">run_type</span><span class="o">=</span><span class="s2">&quot;CELL_OPT&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activate_hybrid</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;activate_hybrid&quot;</span><span class="p">,</span> <span class="p">{}))</span></div>


<div class="viewcode-block" id="Cp2kValidationError"><a class="viewcode-back" href="../../../../pymatgen.io.cp2k.sets.html#pymatgen.io.cp2k.sets.Cp2kValidationError">[docs]</a><span class="k">class</span> <span class="nc">Cp2kValidationError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cp2k Validation Exception. Not exhausted. May raise validation</span>
<span class="sd">    errors for features which actually do work if using a newer version</span>
<span class="sd">    of cp2k</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CP2K_VERSION</span> <span class="o">=</span> <span class="s2">&quot;v2022.1&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;CP2K </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">CP2K_VERSION</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">pymatgen 2022.11.7 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">pymatgen.io.cp2k.sets</a></li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2011, Pymatgen Development Team.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.0.2.
    </div>
<div class="footer">This page uses <a href="http://analytics.google.com/">
Google Analytics</a> to collect statistics. You can disable it by blocking
the JavaScript coming from www.google-analytics.com.
<script type="text/javascript">
  (function() {
    var ga = document.createElement('script');
    ga.src = ('https:' == document.location.protocol ?
              'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    ga.setAttribute('async', 'true');
    document.documentElement.firstChild.appendChild(ga);
  })();
</script>
</div>

  </body>
</html>